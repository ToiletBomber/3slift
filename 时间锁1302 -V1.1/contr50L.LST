C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 1   


C51 COMPILER V8.05a, COMPILATION OF MODULE CONTR50L
OBJECT MODULE PLACED IN contr50L.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE contr50L.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          //zjbtest
   2          /*
   3          *****************************±ØĞëÊ¹ÓÃ×Ô¶¯ÔöÁ¿Ä£Ê½£¬ÆğÊ¼µØÖ·0x22£¬ÔöÁ¿³¤¶È3£¬ÔöÁ¿Öµ1£¬Ê®½øÖÆ¸ñÊ½
   4          *****************************×¢Òâ£¬
   5          *****************************ÉÕÂ¼²ÉÓÃ18.4320M£¬
   6          *****************************µÍµçÑ¹½ûÖ¹eeprom²Ù×÷£¬
   7          *****************************eepromÌî³äÎªFF
   8          
   9          ID´æ´¢Î»ÖÃ 0x20,0x21,0x22
  10          ÊÚÈ¨ÓĞĞ§Ê±¼ä´æ´¢Î»ÖÃÒ³Âë0£¬1£¬2£¬µØÖ·0x00(Äê)£¬0x01(ÔÂ),0x02(ÈÕ)
  11          
  12          ±£´æ¿ª»úÊ±Ê±ÖÓÒ³Âë4£¬5£¬6£¬µØÖ·0x00(Äê)£¬0x01(ÔÂ),0x02(ÈÕ),0x03(Ê±),0x04(·Ö),0x05(Ãë)
  13          
  14          ±£´æÊ±ÖÓÍ£°Ú×Ô¶¯ĞŞ¸´´ÎÊıÒ³Âë8£¬µØÖ·0x00£¬µ±´óÓÚ10´Î±¨´í
  15          
  16          ¿ª»úÊÚÈ¨·½Ê½£¬¿ª»ú½øĞĞ0.1ÃëÖÓµÄ¼ì²â£¬ÅĞ¶ÏÊÇ·ñ´æÔÚÊÚÈ¨ĞèÇó
  17          
  18          2017-5-31
  19          
  20          ÔÚÒÔÇ°µÄ³ÌĞòÉÏĞŞ¸ÄÉı¼¶Îªstc15w4k32s4µÄĞÂ°æ±¾³ÌĞò£¬ÒÔÇ°³ÌĞòµÄĞŞ¸Ä¼ÇÂ¼±£Áô£¬µ«¿ÉÄÜÒÑ¾­Ã»ÓĞÒâÒå
  21          stc15w4k32s4Ê¹ÓÃÍ·ÎÄ¼ş·½Ê½£¬²»ÔÙ×Ô¼º¶¨Òå
  22          
  23          ÒÔÏÂÊÇÃ»ÓĞ1302Ç°µÄĞŞ¸Ä¼ÇÂ¼
  24          2017-5-27
  25                  1\Ê¹ÓÃÍâ²¿´æ´¢Æ÷±àÒëºó£¬Ò»Ğ©±äÁ¿ĞèÒª³õÊ¼»¯
  26                  2\ÆÁ±ÎÁËÃ»ÓĞÌ«´óÒâÒåµÄE31¹ÊÕÏ
  27          2017-5-25
  28          1\ĞÂÔö°´ÕÕÔËĞĞÊ±¼äÀ´ÉÏËø
  29                  Ö»¼ÆÉÏÉıÔËĞĞÊ±¼ä£¬
  30                  ÔËĞĞÊ±¼äÓÃ·ÖÖÓ¼Æ,Ê¹ÓÃ2¸ö×Ö½Ú,65535·Ö=1092Ğ¡Ê±£¬
  31                  ÔËĞĞÊ±¼ä³¬Ê±Ê±,Ö»ÏŞÖÆÉÏÉı,²»ÏŞÖÆÏÂ½µ,²¢Ö»ÔÚĞÂ¿ªµçÔ´Ê±²ÅÓĞĞ§£¬
  32          
  33          2\Ê±¼äËø×î´óÊ±¼äÓÃ³ÌĞòµØÖ·ĞŞ¸Ä,³ÌĞòµØÖ·Îª[0x0010,0x0011],×î´óÊ±¼ä=[0x0010]*256+[0x0011]
  34          ¶Ô16½øÖÆ,¿ÉÒÔ´ÖËã0x40ÎªÒ»Ğ¡Ê±,0x80,0xc0,0x100......
  35          
  36          3\°´ÕÕÃ¿ÖÜÊ¹ÓÃ1´Î,Ã¿´Î20·ÖÖÓ,ÉÏÉıÎª10·ÖÖÓ,³¬¹ı10·ÖÖÓµ±´Î²»ÔÚ¼ÆÊ±
  37          
  38          4\Èç¹ûÃ»ÓĞÌØÊâÒªÇó£¬×î´ó¹¤×÷Ê±³¤ÉèÎª300Ğ¡Ê±
  39          
  40          2017-05-22
  41          ÓÉÓÚ¿Í»§ÔÚ°²È«Ëø´¥·¢×´Ì¬ÏÂ£¬´íÎóÊ¹ÓÃ½âËø·½Ê½£¬¼´ÉÏµçÊ±°´ÏÂ½µ°´Å¥£¨Ó¦¸Ã°´ÉÏÉı°´Å¥È»ºóÊÖ¶¯½âËø£©£¬ËùÒÔÆÁ±Îµô
             -ÏÂ½µÓĞĞ§
  42          
  43          2017-01-04²âÊÔ½«»¥¸ĞÆ÷ÏŞÁ÷µç×èÓÉ200kÔö¼Óµ½600k,Í¬Ê±Êä³ö×è¿¹ÓÉ330Ôöµ½1k
  44          
  45          2015-08-12
  46          ÓÉÓÚÊ¹ÓÃ·¢µç»úµçÑ¹¹ıµÍ±¨¾¯»á¸²¸ÇÆäËû¹ÊÕÏ±¨¾¯,ÑÏÖØÓ°Ïì¿Í·şµ÷ÊÔ,¸ÄµçÑ¹±¨¾¯²»ÍêÈ«¸²¸ÇÔ­ÓĞ¹ÊÕÏĞÅÏ¢
  47          
  48          2015-04-08
  49          ÏÖ³¡·¢ÏÖÆµ·±±¨µçÑ¹¹ıµÍ,ĞŞ¸ÄÔ­À´360Îª330·ü
  50          
  51          2014/3/19
  52          Ôö¼ÓÒ»¸öÊ±¼ä¼ÆÊıÆ÷,ÒÔÏÂÏŞÎ»´¥·¢¹éÁã,¼ÇÂ¼µçÌİÉÏÉıºÍÏÂ½µµÄÊ±¼ä,ÒÔ±ã´Ö¹ÀÉı½µ»úµÄÎ»ÖÃ,ÅĞ¶¨¹ıÔØÊ±ÅÙ³ıµçÀÂµÄÖØÁ¿
             -ºÍ¸ÖË¿ÉşµÄÓ°Ïì,±äÁ¿Ãûint GaoDu,ÁíÉèÒ»¸ö³£Á¿(¼ÓÈ¨ÏµÊı)GaoDuK
  53          
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 2   

  54          2013-05-03ĞŞ¸Ä
  55          1¡¢²»ÔÙ¼ÆËãµÚÈıÏàµçÁ÷
  56          2¡¢¹ıÔØ²»ÔÙ²ÅÓÃÍÆÍì·½Ê½
  57          3¡¢
  58          
  59          2012-12-3²âÊÔ½á¹û
  60          1¡¢¿ª»ú±¨21ºÅ´íÎó£¬È»ºóÏûÊ§
  61          2¡¢¿ª»úÃ»ÓĞÊ±¼äÏÔÊ¾¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ªÓĞÏÔÊ¾£¬1.2Ôİ²»Ğè´¦Àí
  62          
  63          3¡¢Éè¶¨µÄ360~440£¬Êµ²â360~400
  64          4¡¢È±Ïà±¨µçÑ¹µÍ
  65          5¡¢¹ıÔØÎ´´¦Àí
  66          */
  67          
  68          
  69          /*
  70          ³ÌĞòĞŞ¸Ä¼ÇÂ¼
  71          2012-10-25 ÔÚ¶ş´úµçÌİ³ÌĞò»ù´¡ÉÏÖÆ×÷5´úµçÌİ³ÌĞò£¬Ô´³ÌĞòcontr204.c
  72          1¡¢¼ÌµçÆ÷¿ØÖÆ¹¦ÄÜÍ¨¹ı
  73          2¡¢ÕÕÃ÷Ê§°Ü£¬µÆÉÁË¸£¬¿¼ÂÇÈı¶ËÎÈÑ¹ºãÁ÷Ô´
  74          
  75          2012-11-28¼ÇÂ¼
  76          1¡¢µçÑ¹²âÊÔÍ¨¹ı
  77          2¡¢ÕÕÃ÷Ê§°Ü£¬ÎÈÑ¹Ğ¾Æ¬¹ıÈÈ£¬¿¼ÂÇ×¨ÓÃÕÕÃ÷ºãÁ÷Ô´
  78          
  79          2012-8-2
  80          ¶ÏÏà±£»¤ºÍ´íÏà±£»¤Ê±¼äÓÉ250ºÁÃë Ôö¼Óµ½2.5Ãë
  81          ³ÌĞòĞŞ¸Ä¼ÇÂ¼
  82          2012-3-24
  83          ¼ÓÈë±¸ÓÃÃÅ±¨¾¯
  84          ¶ÏÏà±£»¤µçÁ÷ÃÅÏŞÓÉ0.6Aµ÷µ½1.8A
  85          
  86          ±à³ÉÈÕÆÚ£º2009-12-25
  87          Íê³ÉµÄµ÷ÊÔ
  88          1¡¢²âÊÔµãµÄ²É¼¯ºÍË³ĞòÕûÀí
  89          2¡¢¹ıÔØµÄ¼ì²âºÍ¿ØÖÆ
  90          3¡¢°²È«Ëø¼ÌµçÆ÷µÄ¿ØÖÆ
  91          4¡¢¹ÊÕÏ¼ÌµçÆ÷µÄ¿ØÖÆ
  92          5¡¢¹ıÔØµÄ±ê¶¨
  93          6¡¢Ö÷µçÂ·µÄ¿ØÖÆ
  94          7¡¢ÉÏÉıµçÂ·µÄ¿ØÖÆ
  95          8¡¢ÏÂ½µµçÂ·µÄ¿ØÖÆ
  96          9¡¢¿ª»úµÄ¿ØÖÆ
  97          Î´Íê³ÉµÄµ÷ÊÔ
  98          1¡¢´íÏàµÄ¼ì²âºÍ¿ØÖÆ
  99          2¡¢È±ÏàµÄ¼ì²âºÍ¿ØÖÆ
 100          Íê³ÉÈÕÆÚ£º2010-1-11
 101          */
 102          //¿âÎÄ¼ş
 103          #include <intrins.h>
 104          #include <ABSACC.h>
 105          #include <STC15W4K32S4.h>
 106          
 107          //³£Êı
 108          #define OverLoadLimite  (128*4+6*10)    //¹ıÔØÔØÖØÖµ 0.2mV<==>25kg<==>6
 109          #define OverLoadLimite1 (OverLoadLimite-1)      
 110          
 111          #define Crystal         18432000
 112          #define BaudRate        19200
 113          #define InitTime        200//(us)×î´ó256*12/18432000=42.6ms
 114          
 115          #define Alarm           0x40
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 3   

 116          #define Error           0x20
 117          
 118          #define CheckCycle      31//´óÔ¼25ms 800us*31=24.8ms
 119          /*
 120          #define MaxPower        ((440-40)/2.5)//µçÑ¹ÉÏÏŞ£¬440V
 121          //#define MaxPower      (30/3.3)//µçÑ¹ÉÏÏŞ£¬ÀíÂÛÉÏÓ¦¸Ã=µçÑ¹/3£¬¿ÉÊµ²âÊÇµçÑ¹/3.3
 122          #define MinPower        ((360-40)/2.5)//µçÑ¹ÏÂÏŞ  360V
 123          #define LosePower       ((110-40)/2.5)//µçÑ¹ÏÂÏŞ  110V
 124          */
 125          #define MaxPower        (440/3.1)//µçÑ¹ÉÏÏŞ£¬Êµ²â420V
 126          //#define MinPower      (360/3.1)//µçÑ¹ÏÂÏŞ  Êµ²â360V
 127          #define MinPower        (330/3.1)//2015-04-08
 128          //#define MinPower      (430/3.1)//2015-08-12//test
 129          #define LosePower       (110/3.1)//µçÑ¹ÏÂÏŞ  110V
 130          
 131          /*Êµ²â½á¹û
 132          380V    80h
 133          
 134          388V    87h
 135          
 136          400V    7Eh     
 137          360V    6Dh
 138          
 139          
 140          20121212
 141          µÚÒ»´Î²âÁ¿£¬ÆäÖĞµÚÒ»¸ö»¥¸ĞÆ÷Õı×°£¬µÚ¶ş¸ö·´×°£¬µÚÈı¸öÊÇ¼ÆËãµÃ³ö
 142          50hz
 143          120     26 25 25
 144          300     68 66 5c
 145          320     6f 6d 63
 146          340     77 75 6a
 147          360     7f 7c 70
 148          380     87 84 78
 149          400     8f 8c 7f
 150          420     97 94 86
 151          440     9f 9c 8e
 152          460     a8 a4 95
 153          
 154                  60hz            50hz
 155          460     a7 a3 92        a9 a5 96
 156          400     8f 8c 7d        90 8c 80
 157          340     78 75 69        77 75 6a
 158          
 159          µÚÒ»´Î²âÁ¿£¬ÆäÖĞµÚÒ»¸ö»¥¸ĞÆ÷Õı×°£¬µÚ¶ş¸öÕı×°£¬µÚÈı¸öÊÇ¼ÆËãµÃ³ö
 160                  60hz            50hz
 161          460     a7 a3 92        a9 a5 96
 162          400     8f 8c 7d        90 8c 80
 163          340     78 75 69        77 75 6a
 164          
 165          
 166          µÃµ½¹ØÏµÊ½£¬Êı¾İ=(µçÑ¹-40)/2.5
 167          
 168          ÒÔÉÏÃ¿¸öÊı¾İ´ó¸ÅÔÚ+1»ò-1ÉÏ¸¡¶¯
 169          */
 170          
 171          
 172          //IOÎ»¶¨Òå
 173          //Ë«Ïò
 174           
 175          //A/D£¬Õâ¼¸¸ö¶¨ÒåÖ»ÊÇÎªÁËËµÃ÷ioÎ»ÖÃ£¬Êµ¼Ê³ÌĞòÖĞ²¢²»³öÏÖ
 176          sbit    Load    =P1^2;  //³ÆÖØ´«¸ĞÆ÷£¬Òı½Å
 177          sbit    AD0             =P1^3;  //AÏà
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 4   

 178          sbit    AD1             =P1^4;  //BÏà
 179          sbit    AD2             =P1^5;  //CÏà
 180          sbit    AD25    =P1^6;  //»¥¸ĞÆ÷»ù×¼µçÑ¹
 181          
 182          //Êä³ö
 183          sbit    DrvRun  =P3^2;  //¹ÊÕÏ¿ØÖÆ(È±Ïà£¬´íÏà£¬¹ıÔØ)
 184          sbit    DrvSl3  =P3^3;  //°²È«Ëø¿ØÖÆ
 185          sbit    Ss0     =P0^6;  //±¸ÓÃ£¬µçÂ·°åÀ©Õ¹ÓÃ
 186          sbit    Ss1     =P0^5;  //±¸ÓÃ£¬µçÂ·°åÀ©Õ¹ÓÃ
 187          
 188          sbit    L_Run   =P5^0;  //µÆ
 189          /*595ºÍ165£¬²»ÔÙÊ¹ÓÃ£¬ĞŞ¸ÄÍê³ÌĞòÉ¾³ı
 190          sbit    Pl      =P2^4;
 191          sbit    DatOut  =P2^5;
 192          sbit    Lsetb   =P2^6;
 193          sbit    Lclk    =P2^7;
 194          sbit    Nc2     =P3^2;  //¿Õ
 195          sbit    Nc3     =P3^3;  //¿Õ
 196          sbit    Nc4     =P3^4;  //¿Õ
 197          sbit    Clk     =P3^5;
 198          sbit    Ldat    =P3^7;
 199          
 200          //ÌØÊâ¹¦ÄÜ¼Ä´æÆ÷
 201          sfr     P0M0            =0x93;
 202          sfr     P0M1            =0x94;
 203          sfr     P1M0            =0x91;
 204          sfr     P1M1            =0x92;
 205          sfr     P2M0            =0x95;
 206          sfr     P2M1            =0x96;
 207          sfr     P3M0            =0xb1;
 208          sfr     P3M1            =0xb2;
 209          
 210          sfr     ISP_DATA        =0xe2;//ISP/IAP²Ù×÷Êı¾İ¼Ä´æÆ÷
 211          sfr     ISP_ADDRH       =0xe3;//ISP/IAP²Ù×÷µØÖ·¼Ä´æÆ÷¸ß°ËÎ»
 212          sfr     ISP_ADDRL       =0xe4;//ISP/IAP²Ù×÷µØÖ·¼Ä´æÆ÷µÍ°ËÎ»
 213          sfr     ISP_CMD         =0xe5;//ISP/IAP²Ù×÷ÃüÁî¼Ä´æÆ÷£¬ĞèÃüÁî´¥·¢¼Ä´æÆ÷´¥·¢·½¿ÉÉúĞ§
 214                                          //=0£º´ı»ú£¬ÎŞ²Ù×÷=1=2=3
 215                                          //=1£º¶Á
 216                                          //=2£ºĞ´
 217                                          //=3£º²Á³ı
 218          sfr     ISP_TRIG        =0xe6;//ISP/IAP²Ù×÷ÃüÁî´¥·¢¼Ä´æÆ÷
 219                                          //ÔÚISPEN(ISP_CONTR.7)=1Ê±£¬ÏÈĞ´Èë0x46£¬ÔÙĞ´Èë0xb9£¬ISP/IAPÃüÁî²Å»áÉúĞ§
 220          sfr     ISP_CONTR       =0xe7;////ISP/IAP¿ØÖÆ¼Ä´æÆ÷
 221          
 222          sfr     IPH             =0xb7;
 223          
 224          sfr     AUXR            =0x8e;
 225          
 226          
 227          sfr     WDT_CONTR               =0xe1;//¿´ÃÅ¹·
 228          
 229          */
 230          
 231          //¶¨ÒåÈ«¾Ö±äÁ¿
 232          unsigned char   DelayStart;     //¿ª»úµçÑ¹¼ì²âÑÓÊ±
 233          unsigned char   Sec5;           //Ò»¸ö5ÃëµÄÑ­»·¼ÆÊıÆ÷2015-08-12
 234          
 235          unsigned char xdata     State[20]={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};    //²É¼¯µãµÄ×´Ì¬¼Ä´æÆ÷
 236          unsigned char Tcount;           //²É¼¯¼ÆÊıÆ÷
 237          
 238          unsigned char   ErrorState;     //´«ËÍµÄÃüÁî×Ö½Ú,×Ö½Ú¶¨Òå¼ûStateErrorCheck()
 239          unsigned char   CountIndex;     //¶¨Ê±Æ÷¼ÆÊı,±£Ö¤20ms·¢ËÍÒ»´ÎÖ¸Áî
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 5   

 240          unsigned char   SecCount;       //¶¨Ê±Æ÷£¬ÓÃÓÚ1ÃëµÄ¼ÆÊ±,25ms¼õÒ»
 241          
 242          unsigned int xdata      OverLoad=0;
 243          unsigned long xdata     OverLoad1=0;
 244          unsigned int xdata      OverLoadCount=0;
 245          
 246          unsigned int xdata      Clock_1s=0;
 247          unsigned int FF=0;
 248          unsigned char A1=1,B1=1;
 249          unsigned char UP = 0, DOWN = 0;
 250          unsigned char PRESS = 0;
 251          //Î»
 252          bit DrvUpSta;           //?
 253          bit FlagPowerL;         //ÓÃÒÔ¼ì²âµçÑ¹¹ÊÕÏ Ç·Ñ¹
 254          bit FlagPowerH;         //ÓÃÒÔ¼ì²âµçÑ¹¹ÊÕÏ ¹ıÑ¹
 255          bit FlagOverLoad;       //ÓÃÒÔ¼ì²â¹ıÔØ¹ÊÕÏ
 256          bit FlagErrorPhase;     //ÓÃÒÔ¼ì²â´íÏà¹ÊÕÏ
 257          bit FlagLosePhase;      //ÓÃÒÔ¼ì²âÈ±Ïà¹ÊÕÏ
 258          bit FlagStart;          //ÓÃÒÔ±êÊ¾¿ª»ú=0ÏÔÊ¾Ê±¼ä£¬=1ÏÔÊ¾×´Ì¬
 259          
 260          bit FlagRun;                                    //×´Ì¬±êÊ¾ =1ÔËĞĞ×´Ì¬ =0¿ÕÏĞ×´Ì¬ ÓÃÒÔ±£ÕÏÔËĞĞÖĞ²»¶Ô¹ıÔØ²âÁ¿£¬±ÜÃâÒâÍâÍ£»ú
 261          bit FlagReadCurrent;                    //=1¶ÁµçÁ÷²Ù×÷
 262          
 263          #define LoadZero        (128*4)         //0µçÁ÷Öµ
 264          //#define LoadMin       (16*4)          //¼ì²âµçÁ÷·§Öµ Ïàµ±ÓÚ20mA*16*4=1.2A
 265          //#define PhaseLoseMax  0x60    //È±ÏàºâÁ¿ÓĞµçÁ÷»ù×¼£¬Ïàµ±ÓÚ20mA*0x60/2=0.9A
 266          //#define PhaseLoseMin  0x40    //È±ÏàºâÁ¿ÎŞµçÁ÷»ù×¼£¬Ïàµ±ÓÚ20mA*0x40/2=0.6A
 267          
 268          #define LoadMin         64              //¼ì²âµçÁ÷·§Öµ Ïàµ±ÓÚ20mA*16*4=1.2A
 269          #define PhaseLoseMax    200     //È±ÏàºâÁ¿ÓĞµçÁ÷»ù×¼£¬Ïàµ±ÓÚ20mA*200/2=2A
 270          #define PhaseLoseMin    180     //È±ÏàºâÁ¿ÎŞµçÁ÷»ù×¼£¬Ïàµ±ÓÚ20mA*180/2=1.8A
 271          
 272          /*
 273                  Ô­Ê¼Êı¾İ£º      ta12-200 5A==>2.5mA
 274                  ×î´óÁ¿³Ì£º      2.5mA*470/5V*1024=240
 275                  ·Ö±æÂÊ£º        5A/240=20mA
 276          */
 277          unsigned int xdata      DelaySecCount=0;//ÑÓÊ±¼ÆÊıÆ÷
 278          //µçÁ÷¼ì²â
 279          
 280          unsigned int xdata      LoadDot[64]={0};        //ÈÎÒ»Ê±¿Ì²âÁ¿µ½µÄµçÁ÷
 281          //unsigned int  CurrentMax[3];                          //µçÁ÷²¨·å
 282          //unsigned int  CurrentMin[3];                          //µçÁ÷²¨¹È
 283          
 284          //0~2ÊÇABCÈıÏàÏà¼äµçÑ¹£¬3ÊÇAÏßµçÑ¹
 285          unsigned int xdata      LoadCurrent[4]={0,0,0,0};//µçÑ¹¾ùÖµ=SumLoadCurrent[3]/SumCount
 286          unsigned long xdata     SumLoadCurrent[4]={0,0,0,0};
 287          
 288          unsigned int    SumCount;
 289          unsigned char   PhaseLose;              //È±Ïà´íÎó¼ÆÊıÆ÷£¬ÖÁÉÙ10¸öÖÜÆÚ²ÅÅĞ¶Ï
 290          
 291          bit                             Polarity0;              //aÏàÏßµ±Ç°¼«ĞÔ
 292          bit                             Polarity1;              //bÏàÏßµ±Ç°¼«ĞÔ
 293          bit                             Polarity2;              //cÏàÏßµ±Ç°¼«ĞÔ
 294          unsigned char   PhaseTimer[3];  //ÏàĞò¼ÆÊ±
 295          unsigned char   PhaseError;             //ÏàĞò´íÎó¼ÆÊıÆ÷£¬ÖÁÉÙ10¸öÖÜÆÚ²ÅÅĞ¶Ï
 296          unsigned char   LoadIndex;              //Éè±¸¹¤×÷µçÁ÷²âÁ¿Ë÷Òı
 297          
 298          
 299          /*2014/3/19
 300          ¼Ù¶¨Éı½µ»úÔËĞĞ10·ÖÖÓ¼ÓÖØ50¹«½ï
 301          10·ÖÖÓ=600Ãë=600000ºÁÃë
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 6   

 302          GaoDuÃ¿25ºÁÃë¼ÆÊıÒ»´Î,¼ÆÊıÖµ=600000ºÁÃë/25ºÁÃë=24000
 303          ¶ø25¹«½ï,ÊıÄ£×ª»»ÖµÊÇ6(Õâ¸öÖµÊÇ·ñ×¼È·Î´Öª,ÏÈ¼Ù¶¨×¼È·)
 304          50¹«½ï¾ÍÊÇ12,24000/12=2000,Õâ¾ÍÊÇGaoDuKµÄÖµ
 305          */
 306          unsigned int    GaoDu;//2014/3/19
 307          #define GaoDuK  2000//2014/3/19
 308          
 309          //2017-5-25 start
 310          unsigned char   OldErrorState;  //
 311          bit                     FlagOverTimer;  //ÉÏµçÊ±¼ÇÂ¼³¬Ê±×´Ì¬
 312          bit                             OverTimer;              //³¬Ê±ºóÓĞÉÏÉı²Ù×÷±¨´í
 313          unsigned int    OneMin;
 314          
 315          //2017-5-25 end
 316          
 317          unsigned char RL1,RL2;//µçÎ»Æ÷µ÷ÕûÏÔÊ¾¶¯»­2017-8-22
 318          
 319          //ds1302³ÌĞò
 320          //¼Ä´æÆ÷ºê¶¨Òå 
 321          #define WRITE_SECOND            0x80 
 322          #define WRITE_MINUTE            0x82 
 323          #define WRITE_HOUR              0x84 
 324          #define READ_SECOND             0x81 
 325          #define READ_MINUTE             0x83 
 326          #define READ_HOUR               0x85 
 327          #define WRITE_PROTECT           0x8E
 328          #define READ_PROTECT            0x8F
 329          #define WRITE_POWER             0x90 
 330          #define READ_POWER              0x91 
 331          #define WRITE_YEAR              0x8C
 332          #define WRITE_MONTH             0x88 
 333          #define WRITE_DATE              0x86 
 334          #define READ_YEAR               0x8D 
 335          #define READ_MONTH              0x89 
 336          #define READ_DATE               0x87
 337          
 338          unsigned char xdata DATE[7];    //0Äê1ÔÂ2ÈÕ3Ê±4·Ö5Ãë 
 339          
 340          sbit    SCLK    = P2^1;                 //DS1302Ê±ÖÓĞÅºÅ
 341          sbit    DIO             = P2^2;                 // DS1302Êı¾İĞÅºÅ
 342          sbit    CE              = P2^3;                 // DS1302Æ¬Ñ¡ 
 343          
 344          sbit    DA              = P4^3;
 345          sbit    DB              = P4^2;
 346          sbit    DF              = P4^1;
 347          sbit    DC              = P7^3;
 348          sbit    DD              = P7^2;
 349          sbit    DE              = P7^1;
 350          sbit    DG              = P7^0;
 351          
 352          sbit    LED1    = P3^6;
 353          sbit    LED2    = P3^5;
 354          sbit    LED3    = P3^4;
 355          sbit    IN3             = P2^4;
 356          sbit    IN2             = P2^5;
 357          unsigned char   ShowTimer;
 358          code char Bcd7Seg[64]   =
 359          {
 360          //dp g  f  e  d  c  b  a
 361              0x3F,// 0>>0
 362                  0x06,// 1>>1
 363                  0x5B,// 2>>2
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 7   

 364                  0x4F,// 3>>3
 365                  0x66,// 4>>4
 366                  0x6D,// 5>>5
 367                  0x7D,// 6>>6
 368                  0x07,// 7>>7
 369                  0x7F,// 8>>8
 370                  0x6F,// 9>>9
 371                  0x77,// 10>>A
 372                  0x7C,// 11>>b
 373                  0x39,// 12>>C
 374                  0x5E,// 13>>d
 375                  0x79,// 14>>E
 376                  0x71,// 15>>F
 377                  0x76,// 16>>H
 378                  0x74,// 17>>h
 379                  0x38,// 18>>L
 380                  0x54,// 19>>n
 381                  0x63,// 20>>oÉÏ
 382                  0x5C,// 21>>oÏÂ
 383                  0x73,// 22>>p
 384                  0x67,// 23>>q
 385                  0x50,// 24>>r
 386                  0x3E,// 25>>U
 387                  0x40,// 26>>-
 388                  0x23,// 27>>ÉÏÉı
 389                  0x1C,// 28>>ÏÂ½µ
 390                  0x00,// 29>>¿Õ¸ñ
 391                  0x00,// 30>>¿Õ¸ñ
 392                  0x46,// 31>>-1
 393          
 394          //a  b  c  d  e  f  g  dp
 395              0xFC,// 0>>0
 396                  0x60,// 1>>1
 397                  0xDA,// 2>>2
 398                  0xF2,// 3>>3
 399                  0x66,// 4>>4
 400                  0xB6,// 5>>5
 401                  0xBE,// 6>>6
 402                  0xE0,// 7>>7
 403                  0xFE,// 8>>8
 404                  0xF6,// 9>>9
 405                  0xEE,// 10>>A
 406                  0x3E,// 11>>b
 407                  0x9C,// 12>>C
 408                  0x7A,// 13>>d
 409                  0x9E,// 14>>E
 410                  0x8E,// 15>>F
 411                  0x6E,// 16>>H
 412                  0x2E,// 17>>h
 413                  0x1C,// 18>>L
 414                  0x2A,// 19>>n
 415                  0xC6,// 20>>oÉÏ
 416                  0x3A,// 21>>oÏÂ
 417                  0xCE,// 22>>p
 418                  0xE6,// 23>>q
 419                  0x0A,// 24>>r
 420                  0x7C,// 25>>U
 421                  0x02,// 26>>-
 422                  0xC4,// 27>>ÉÏÉı
 423                  0x38,// 28>>ÏÂ½µ
 424          
 425                  0x00,// 29>>¿Õ¸ñ
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 8   

 426                  0x00,// 30>>¿Õ¸ñ
 427                  0x00,// 31>>¿Õ¸ñ
 428          };
 429          void Delay_us(unsigned int index)
 430          {
 431   1              while(index--)
 432   1              {
 433   2                      _nop_();_nop_();_nop_();_nop_();_nop_();_nop_();
 434   2                      _nop_();_nop_();_nop_();_nop_();_nop_();_nop_();
 435   2                      _nop_();_nop_();_nop_();_nop_();_nop_();_nop_();
 436   2              }
 437   1      }
 438          
 439          #define S2RI    0x01
 440          #define S2TI    0x02
 441          
 442          void Verify();
 443          void test();
 444          
 445          //µØÖ·¡¢Êı¾İ·¢ËÍ×Ó³ÌĞò 
 446          void Write1302 ( unsigned char addr,dat )     
 447          { 
 448   1              unsigned char i,temp; 
 449   1              
 450   1              CE=0;                         //CEÒı½ÅÎªµÍ£¬Êı¾İ´«ËÍÖĞÖ¹ 
 451   1              SCLK=0;                    //ÇåÁãÊ±ÖÓ×ÜÏß 
 452   1              Delay_us(4);
 453   1              CE = 1;                       //CEÒı½ÅÎª¸ß£¬Âß¼­¿ØÖÆÓĞĞ§ 
 454   1              Delay_us(4);
 455   1              //·¢ËÍµØÖ· 
 456   1              for ( i=8; i>0; i-- ) //Ñ­»·8´ÎÒÆÎ» 
 457   1              {     
 458   2                    SCLK = 0; 
 459   2                    temp = addr; 
 460   2                    DIO = (bit)(temp&0x01);          //Ã¿´Î´«ÊäµÍ×Ö½Ú 
 461   2                        Delay_us(1);
 462   2                    addr >>= 1;                //ÓÒÒÆÒ»Î» 
 463   2                    SCLK = 1; 
 464   2              } 
 465   1              //·¢ËÍÊı¾İ 
 466   1              for ( i=8; i>0; i-- ) 
 467   1              {     
 468   2                    SCLK = 0; 
 469   2                    temp = dat; 
 470   2                    DIO = (bit)(temp&0x01);          
 471   2                        Delay_us(1);
 472   2                    dat >>= 1;                   
 473   2                    SCLK = 1; 
 474   2              } 
 475   1              CE = 0;         
 476   1      } 
 477          
 478          
 479          //Êı¾İ¶ÁÈ¡×Ó³ÌĞò 
 480          unsigned char Read1302 ( unsigned char Index) 
 481          { 
 482   1              unsigned char i,temp,temp1,addr;
 483   1      
 484   1              do
 485   1              {
 486   2                      temp1=temp;
 487   2                      addr=Index;
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 9   

 488   2                      
 489   2                      CE=0;           
 490   2                      SCLK=0;
 491   2                      Delay_us(4);
 492   2                      CE = 1;  
 493   2                      Delay_us(4);
 494   2             //·¢ËÍµØÖ· 
 495   2                      for ( i=8; i>0; i-- )                      //Ñ­»·8´ÎÒÆÎ» 
 496   2                      {     
 497   3                            SCLK = 0; 
 498   3                                DIO = (bit)(addr&0x01);          //Ã¿´Î´«ÊäµÍ×Ö½Ú
 499   3                                Delay_us(1);
 500   3                            addr >>= 1;                              //ÓÒÒÆÒ»Î»
 501   3                            SCLK = 1; 
 502   3                      } 
 503   2      
 504   2      //¶ÁÈ¡Êı¾İ
 505   2      
 506   2      //      DIO =1;
 507   2      
 508   2                      for ( i=8; i>0; i-- ) 
 509   2                      { 
 510   3                            SCLK = 1; 
 511   3                                temp>>=1;
 512   3                            SCLK = 0;
 513   3                                Delay_us(1);
 514   3                                if(DIO)temp|=0x80;
 515   3                      }     
 516   2                      CE=0;
 517   2      
 518   2              }while(temp!=temp1);
 519   1       
 520   1              return (temp); 
 521   1      }
 522          
 523          
 524          
 525          //³õÊ¼»¯DS1302 
 526          void Initial(void)    
 527          { 
 528   1         Write1302 (WRITE_PROTECT,0X00);              //½ûÖ¹Ğ´±£»¤ 
 529   1      
 530   1         Write1302 (WRITE_YEAR,DATE[0]);                      //ÃëÎ»³õÊ¼»¯ 
 531   1         Write1302 (WRITE_MONTH,DATE[1]);             //·ÖÖÓ³õÊ¼»¯ 
 532   1         Write1302 (WRITE_DATE,DATE[2]);                      //ÃëÎ»³õÊ¼»¯ 
 533   1         Write1302 (WRITE_HOUR,DATE[3]);              //Ğ¡Ê±³õÊ¼»¯
 534   1         Write1302 (WRITE_MINUTE,DATE[4]);            //·ÖÖÓ³õÊ¼»¯ 
 535   1         Write1302 (WRITE_SECOND,0x00);               //ÃëÎ»³õÊ¼»¯ 
 536   1      
 537   1         Write1302 (WRITE_POWER,0xAA);                //2¸ö¶ş¼«¹Ü£¬4Ç§Å·
 538   1         Write1302 (WRITE_PROTECT,0x80);              //ÔÊĞíĞ´±£»¤ 
 539   1      } 
 540          
 541          
 542          
 543          //²âÊÔ
 544          unsigned int t_int1;
 545          unsigned char t_char;
 546          
 547          #define CMD_IDLE        0       //¿ÕÏĞÄ£Ê½
 548          #define CMD_READ        1       //IAP¶Á
 549          #define CMD_PROGRAM     2       //IAPĞ´
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 10  

 550          #define CMD_ERASE       3       //IAP²Á³ı
 551          
 552          #define ENABLE_IAP      0X82    //SYSCLK<24M
 553          
 554          void IapIdle()
 555          {
 556   1              IAP_CONTR=0;
 557   1              IAP_CMD=0;
 558   1              IAP_TRIG=0;
 559   1              IAP_ADDRH=0x80;
 560   1              IAP_ADDRL=0;
 561   1      }
 562          void WriteFlash(unsigned int IspAddr,unsigned char IspData)
 563          {
 564   1              IAP_CONTR=ENABLE_IAP;
 565   1              IAP_CMD=CMD_PROGRAM;
 566   1              IAP_ADDRL=IspAddr%0x100;
 567   1              IAP_ADDRH=IspAddr/0x100;
 568   1              IAP_DATA=0xff-IspData;
 569   1              IAP_TRIG=0x5A;
 570   1              IAP_TRIG=0xA5;
 571   1              _nop_();
 572   1              IapIdle();
 573   1      }
 574          unsigned char ReadFlash(unsigned int IspAddr)
 575          {
 576   1              unsigned char i;
 577   1              IAP_CONTR=ENABLE_IAP;
 578   1              IAP_CMD=CMD_READ;
 579   1              IAP_ADDRL=IspAddr%0x100;
 580   1              IAP_ADDRH=IspAddr/0x100;
 581   1              IAP_TRIG=0x5A;
 582   1              IAP_TRIG=0xA5;
 583   1              _nop_();
 584   1              i=0xff-IAP_DATA;
 585   1              IapIdle();
 586   1      
 587   1              return i;
 588   1      }
 589          void EraseFlash(unsigned int IspAddr)
 590          {
 591   1              IAP_CONTR=ENABLE_IAP;
 592   1              IAP_CMD=CMD_ERASE;
 593   1              IAP_ADDRL=IspAddr%0x100;
 594   1              IAP_ADDRH=IspAddr/0x100;
 595   1              IAP_TRIG=0x5A;
 596   1              IAP_TRIG=0xA5;
 597   1              _nop_();
 598   1              IapIdle();
 599   1      }
 600          
 601          unsigned int crc_cal_value(unsigned char data_value,unsigned int crc_value)
 602          {
 603   1              unsigned char i;
 604   1              union{
 605   1                              unsigned char Addr[2];
 606   1                          unsigned int crc_value;
 607   1                      }temp;
 608   1      
 609   1              temp.crc_value=crc_value;
 610   1              temp.crc_value^=data_value;
 611   1      
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 11  

 612   1              for(i=0;i<8;i++)
 613   1              {
 614   2                      if(temp.crc_value&0x0001)
 615   2                      {
 616   3                              temp.crc_value = temp.crc_value>>1;
 617   3                              temp.Addr[0]^=0xa0;
 618   3                              temp.Addr[1]^=0x01;
 619   3                      }
 620   2                      else temp.crc_value=temp.crc_value>>1;
 621   2              }
 622   1              return(temp.crc_value);
 623   1      }
 624          
 625          unsigned char xdata LedStr[3];
 626          bit Flag_CheckID;
 627          bit Flag_Timer0;                //ÓÃÓÚ¿ª»úÊ±¼ÆËãÊ±¼ä£¬Ã¿´Î¶¨Ê±ÖĞ¶ÏÖÃ1
 628          unsigned char code ID2 _at_     0x0020;
 629          unsigned char code ID1 _at_     0x0021;
 630          unsigned char code ID0 _at_     0x0022;
 631          
 632          unsigned char code EndYear _at_ 0x8000;//Èç¹ûÓÃiap¶ÁĞ´£¬µØÖ·Îª0x0000
 633          unsigned char code EndMon  _at_ 0x8001;
 634          unsigned char code EndDay  _at_ 0x8002;
 635          
 636          unsigned char code EndYear1 _at_ 0x8200;//Èç¹ûÓÃiap¶ÁĞ´£¬µØÖ·Îª0x0000
 637          unsigned char code EndMon1  _at_ 0x8201;
 638          unsigned char code EndDay1  _at_ 0x8202;
 639          
 640          unsigned char code EndYear2 _at_ 0x8400;//Èç¹ûÓÃiap¶ÁĞ´£¬µØÖ·Îª0x0000
 641          unsigned char code EndMon2  _at_ 0x8401;
 642          unsigned char code EndDay2  _at_ 0x8402;
 643          
 644          #define TB_NowTime              0xe9
 645          #define TB_EndTime              0xed
 646          
 647          unsigned char Sint_value=0;
 648          unsigned char Sint_value1=0;
 649          unsigned char Sint_count=0;
 650          
 651          void RstPower()
 652          {
 653   1              unsigned char t;
 654   1              if(RI)//ÔÚ³ÌĞòÔËĞĞ¹ı³ÌÖĞÒ²¿ÉÒÔÊÚÈ¨Ğ£ÕıÊ±¼ä
 655   1              {
 656   2                      RI=0;
 657   2                      t=SBUF;
 658   2                      if(t==TB_NowTime)//Ğ£Ê±Í¬²½
 659   2                      {
 660   3                              if(Sint_value==TB_NowTime)Sint_count++;
 661   3                              else Sint_count=0;
 662   3                      }
 663   2                      if(t==TB_EndTime)//ÊÚÈ¨Í¬²½
 664   2                      {
 665   3                              if(Sint_value==TB_EndTime)Sint_count++;
 666   3                              else Sint_count=0;
 667   3                      }
 668   2                      if(Sint_value1==0xEB)
 669   2                      {
 670   3                              if(Sint_value<=0x20)
 671   3                              {
 672   4                                      TI=0;
 673   4                                      SBUF=ReadFlash(Sint_value*256+t);
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 12  

 674   4                                      while(!TI);
 675   4                              }
 676   3                              else if(Sint_value<0x80){;}
 677   3                              else if(Sint_value<=0x90)
 678   3                              {
 679   4                                      Sint_value=Sint_value|0x01;//Èç¹ûÊı¾İÊÇĞ´£¬Ç¿ÖÆ¸ÄÎª¶Á
 680   4                                      TI=0;
 681   4                                      SBUF=Read1302(Sint_value);
 682   4                                      while(!TI){};
 683   4                              }
 684   3                      }
 685   2                      Sint_value1=Sint_value;
 686   2                      Sint_value=t;
 687   2                      if(Sint_count>10)IAP_CONTR=0x20;//ÖØĞÂÆô¶¯
 688   2              }
 689   1      }
 690          
 691          
 692          void CheckID()
 693          {
 694   1              unsigned int i,j;
 695   1              unsigned char t,t0;
 696   1              unsigned int crc_value;
 697   1              unsigned char BZ;//=0:¼ì²âID£¬=1:°üº¬±¾°åID
 698   1              
 699   1              union{
 700   1                              unsigned char Addr[4];
 701   1                          unsigned long value;
 702   1                      }EndDate;
 703   1              
 704   1              union{                             
 705   1                              unsigned char Addr[4];
 706   1                          unsigned long value;
 707   1                      }MeID;
 708   1              
 709   1              union{
 710   1                              unsigned char Addr[4];
 711   1                          unsigned long value;
 712   1                      }AcceptDat;
 713   1      
 714   1              MeID.Addr[0]=0;
 715   1              MeID.Addr[1]=ID2;
 716   1              MeID.Addr[2]=ID1;
 717   1              MeID.Addr[3]=ID0;
 718   1              AcceptDat.Addr[0]=0;
 719   1              BZ=0;
 720   1              Flag_CheckID=1;
 721   1              EA=1;
 722   1      //¼ì²éÊÇ·ñ¿ªÆôĞÂµÄÊÚÈ¨
 723   1      //¼ì²éÊ±ÖÓÊÇ·ñÕı³££¬¼ì²éÊ±ÖÓÊÇ·ñÍ£°Ú£¬Èç¹ûÍ£°Ú±¨E01£¬Í¬Ê±ÏÔÊ¾A01£¬²¢½ûÖ¹ÔËĞĞ
 724   1      //¼ì²éÊ±ÖÓÊÇ·ñÕı³££¬¼ì²éÊ±ÖÓ³äµçÉèÖÃ£¬Èç¹û´íÎó±¨E01£¬Í¬Ê±ÏÔÊ¾A03£¬²¢½ûÖ¹ÔËĞĞ
 725   1      //¼ì²éÊÇ·ñÊÚÈ¨¹ıÆÚ£¬Èç¹û¹ıÆÚ±¨E01£¬Í¬Ê±ÏÔÊ¾A01£¬²¢½ûÖ¹ÔËĞĞ
 726   1      //Ê±¼äĞ£Õı
 727   1      
 728   1              RI=0;Flag_Timer0=0;i=0;
 729   1      
 730   1              //µÈ´ıÊÚÈ¨Ö¸Áî£¬²»ÂÛÓĞ»¹ÊÇÃ»ÓĞ£¬È·ÈÏÃ»ÓĞºó¼ì²éÊÚÈ¨×´Ì¬
 731   1              while((i<200))//500*200us=100ms,14msÓĞ10%µÄ»ú»áÍê³ÉÍ¨ĞÅ£¬16msÓĞ80%»ú»áÍê³ÉÍ¨ĞÅ£¬18msÓë16ms²î²»¶à£¬20ms»ù±
             -¾100%£¬×îºóÈ¡40ms
 732   1              {
 733   2                      if(Flag_Timer0) //Õâ¸ö±äÁ¿Ö»ÓĞÔÚ¼ì²éÊÚÈ¨Ê±ÖÃÎ»,ËùÒÔÆäÊµÕâ¸öº¯Êı¾ÍÊÇÑÓÊ±,ÉÏµçÊ±¼ì²éÊÇ·ñÒªÊÚÈ¨
 734   2                      {
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 13  

 735   3                              i++;
 736   3                              Flag_Timer0=0;
 737   3                      }
 738   2                      if(RI)                  //Èç¹û´®¿Ú½ÓÊÕµ½Êı¾İ
 739   2                      {
 740   3                              RI=0;
 741   3                              t=SBUF;         //½ÓÊÕµ½µÄÊı¾İ´æÈët±äÁ¿ÖĞ
 742   3                              if(t==TB_EndTime) //ÊÕµ½Í¬²½Í·Îª 0xed
 743   3                              {
 744   4                                      while(t==TB_EndTime)//½ÓÊÜÍ¬²½Âë£¬Í¬Ê±µÈ´ıÊ×Î»ĞÅÏ¢
 745   4                                      {
 746   5                                              TI=0;
 747   5                                              SBUF=0xaa;        //·µ»Ø0XAA
 748   5                                              while(!RI){;}
 749   5                                              RI=0;
 750   5                                              t0=SBUF;          //ÏÂ¸öÊı¾İ´æÈët0±äÁ¿ÖĞ
 751   5                                              t=t0;             //½«t0ÖĞµÄÊı¾İ¸øtÈ·±£t0Ò»Ö±ÊÇ×îĞÂÊÕµ½µÄÖµ
 752   5                                      }
 753   4      
 754   4                                      //¿ªÊ¼½ÓÊÕÊı¾İ,ÏÈ×öCRC³ÌĞò
 755   4                                      crc_value=0xffff;
 756   4                                      crc_value=crc_cal_value(t,crc_value);//Ëæ»úÂë
 757   4      
 758   4                                      for(i=0;i<3;i++)//½ÓÊÕÊÚÈ¨ÈÕÆÚ
 759   4                                      {
 760   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[3]=t;crc_value=crc_cal_value(t,crc_value);
 761   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[2]=t;crc_value=crc_cal_value(t,crc_value);
 762   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 763   5                                      }
 764   4                                      EndDate.value=AcceptDat.value;
 765   4      
 766   4                                      for(i=0;i<1000;i++)//½ÓÊÕID
 767   4                                      {
 768   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 769   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[2]=t;crc_value=crc_cal_value(t,crc_value);
 770   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[3]=t;crc_value=crc_cal_value(t,crc_value);
 771   5                                              if(AcceptDat.value==MeID.value)BZ=1;
 772   5                                      }
 773   4      
 774   4                                      //½ÓÊÕcrc
 775   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 776   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 777   4      
 778   4                                      if(crc_value==0)  //crcÎŞ´íÎó
 779   4                                      {
 780   5                                              if(BZ==1)        //idºÅÔÚÊÚÈ¨·¶Î§ÄÚ
 781   5                                              {
 782   6                                                      t=0x55; //ĞÅÏ¢½ÓÊÕÍê±Ï
 783   6                                              //ĞŞÕıÊÚÈ¨Ê±¼ä
 784   6                                                      for(i=0;i<3;i++)
 785   6                                                      {
 786   7                                                              BZ=0;
 787   7                                                              while(!BZ)
 788   7                                                              {
 789   8                                                                      EraseFlash(i*512);      //µÚ1,2,3ÉÈÇø´æ´¢ÊÚÈ¨µÄÖÕÖ¹Ê±¼ä
 790   8                                                                      WriteFlash(i*512+0,EndDate.Addr[1]);
 791   8                                                                      WriteFlash(i*512+1,EndDate.Addr[2]);
 792   8                                                                      WriteFlash(i*512+2,EndDate.Addr[3]);
 793   8                                                                      BZ=(ReadFlash(i*512+0)==EndDate.Addr[1])&(ReadFlash(i*512+1)==EndDate.Addr[2])&(ReadFlash(i*512+2)
             -==EndDate.Addr[3]);
 794   8                                                              }
 795   7                                                      }
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 14  

 796   6                                                      
 797   6                                              }
 798   5                                              else t=0xe1;
 799   5                                      }
 800   4                                      else t=0xee;
 801   4      
 802   4                                      for(i=0;i<5;i++)
 803   4                                      {
 804   5                                              TI=0;
 805   5                                              SBUF=t;
 806   5                                              while(!TI);
 807   5                                      }
 808   4      
 809   4                              }
 810   3                              else if(t==TB_NowTime)
 811   3                              {
 812   4                                      while(t==TB_NowTime)//½ÓÊÜÍ¬²½Âë£¬Í¬Ê±µÈ´ıÊ×Î»ĞÅÏ¢
 813   4                                      {
 814   5                                              TI=0;
 815   5                                              SBUF=0xa5;
 816   5                                              while(!RI){};
 817   5                                              RI=0;
 818   5                                              t0=SBUF;
 819   5                                              t=t0;
 820   5                                      }
 821   4      
 822   4                                      //¿ªÊ¼½ÓÊÕÊı¾İ,ÏÈ×öCRC³ÌĞò
 823   4                                      crc_value = 0xffff;
 824   4                                      crc_value = crc_cal_value(t,crc_value);//Ëæ»úÂë
 825   4      
 826   4                                      //½ÓÊÕÃë·ÖÊ±
 827   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[3]=t;crc_value=crc_cal_value(t,crc_value);
 828   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[2]=t;crc_value=crc_cal_value(t,crc_value);
 829   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 830   4                                      EndDate.value=AcceptDat.value;//½èÓÃ¼Ä´æÆ÷
 831   4                                      
 832   4                                      //½ÓÊÕÈÕÔÂÄê
 833   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[3]=t;crc_value=crc_cal_value(t,crc_value);
 834   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[2]=t;crc_value=crc_cal_value(t,crc_value);
 835   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 836   4      
 837   4                                      //½ÓÊÕcrc
 838   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;crc_value=crc_cal_value(t,crc_value);
 839   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;crc_value=crc_cal_value(t,crc_value);
 840   4      
 841   4                                      if(crc_value==0)
 842   4                                      {
 843   5                                              //ĞŞÕıÊ±ÖÓ
 844   5                                              BZ=0;
 845   5                                              while(!BZ)
 846   5                                              {
 847   6                                              Write1302 (WRITE_PROTECT,0X00);                                 //½ûÖ¹Ğ´±£»¤ 
 848   6                                              Write1302 (WRITE_SECOND,EndDate.Addr[3]);               //ÃëÎ»³õÊ¼»¯ 
 849   6                                              Write1302 (WRITE_MINUTE,EndDate.Addr[2]);               //·ÖÖÓ³õÊ¼»¯ 
 850   6                                              Write1302 (WRITE_HOUR,EndDate.Addr[1]);                 //Ğ¡Ê±³õÊ¼»¯
 851   6                                              EndDate.value=AcceptDat.value;                                          //½èÓÃ¼Ä´æÆ÷
 852   6                                                      Write1302 (WRITE_DATE,EndDate.Addr[3]);                 //ÈÕÎ»³õÊ¼»¯ 
 853   6                                              Write1302 (WRITE_MONTH,EndDate.Addr[2]);                //ÔÂÖÓ³õÊ¼»¯ 
 854   6                                              Write1302 (WRITE_YEAR,EndDate.Addr[1]);                 //ÄêÊ±³õÊ¼»¯
 855   6                                              Write1302 (WRITE_POWER,0xAA);                                   //2¸ö¶ş¼«¹Ü£¬4Ç§Å·
 856   6                                              Write1302 (WRITE_PROTECT,0x80);                                 //ÔÊĞíĞ´±£»¤ 
 857   6              
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 15  

 858   6                                                      BZ=(Read1302(READ_DATE)==EndDate.Addr[3])&(Read1302(READ_MONTH)==EndDate.Addr[2])&(Read1302(READ_YEA
             -R)==EndDate.Addr[1]);
 859   6                                                      //BZ=1;
 860   6                                              }
 861   5                                              EraseFlash(8*512);
 862   5                                              WriteFlash(8*512,0);//Ã¿´ÎĞ£Ê±ºó£¬Ê±ÖÓ×Ô¶¯ĞŞ¸´ÏŞ´Î¹é0
 863   5                                              
 864   5                                              IN2=1;
 865   5                                              LED1 =1;
 866   5              
 867   5                                              t=0x55;
 868   5                                      }
 869   4                                      else    t=0xee;
 870   4                                      for(i=0;i<5;i++)
 871   4                                      {
 872   5                                              TI=0;
 873   5                                              SBUF=t;
 874   5                                              while(!TI);
 875   5                                      }
 876   4                              }
 877   3                      }
 878   2              }
 879   1      
 880   1      
 881   1      //¼ì²éÊ±ÖÓÊÇ·ñÕı³££¬¼ì²éÊ±ÖÓÊÇ·ñÍ£°Ú£¬Èç¹ûÍ£°Ú±¨E01£¬Í¬Ê±ÏÔÊ¾A01£¬²¢½ûÖ¹ÔËĞĞ
 882   1              
 883   1              do
 884   1              {
 885   2                      t=Read1302(READ_PROTECT);
 886   2              }while(t&0x7f);//È·±£1302ÓĞ0Êı¾İÊä³ö£¬0x80»ò0x00
 887   1              
 888   1              t=Read1302(READ_SECOND);
 889   1              if(t&0x80)
 890   1              {
 891   2                      t0=0;
 892   2                      //³¢ÊÔĞŞ¸´
 893   2                      BZ=0;
 894   2                      i=4;j=5;
 895   2                      if((ReadFlash(i*512+0)==ReadFlash(j*512+0))&(ReadFlash(i*512+1)==ReadFlash(j*512+1))&(ReadFlash(i*512+2)
             -==ReadFlash(j*512+2))&(ReadFlash(i*512+3)==ReadFlash(j*512+3))&(ReadFlash(i*512+4)==ReadFlash(j*512+4))&(ReadFlash(i*512
             -+5)==ReadFlash(j*512+5))&!BZ)
 896   2                      {DATE[0]=ReadFlash(i*512+0);DATE[1]=ReadFlash(i*512+1);DATE[2]=ReadFlash(i*512+2);DATE[3]=ReadFlash(i*51
             -2+3);DATE[4]=ReadFlash(i*512+4);DATE[5]=ReadFlash(i*512+5);BZ=1;}
 897   2                      i=4;j=6;
 898   2                      if((ReadFlash(i*512+0)==ReadFlash(j*512+0))&(ReadFlash(i*512+1)==ReadFlash(j*512+1))&(ReadFlash(i*512+2)
             -==ReadFlash(j*512+2))&(ReadFlash(i*512+3)==ReadFlash(j*512+3))&(ReadFlash(i*512+4)==ReadFlash(j*512+4))&(ReadFlash(i*512
             -+5)==ReadFlash(j*512+5))&!BZ)
 899   2                      {DATE[0]=ReadFlash(i*512+0);DATE[1]=ReadFlash(i*512+1);DATE[2]=ReadFlash(i*512+2);DATE[3]=ReadFlash(i*51
             -2+3);DATE[4]=ReadFlash(i*512+4);DATE[5]=ReadFlash(i*512+5);BZ=1;}
 900   2                      i=5;j=6;
 901   2                      if((ReadFlash(i*512+0)==ReadFlash(j*512+0))&(ReadFlash(i*512+1)==ReadFlash(j*512+1))&(ReadFlash(i*512+2)
             -==ReadFlash(j*512+2))&(ReadFlash(i*512+3)==ReadFlash(j*512+3))&(ReadFlash(i*512+4)==ReadFlash(j*512+4))&(ReadFlash(i*512
             -+5)==ReadFlash(j*512+5))&!BZ)
 902   2                      {DATE[0]=ReadFlash(i*512+0);DATE[1]=ReadFlash(i*512+1);DATE[2]=ReadFlash(i*512+2);DATE[3]=ReadFlash(i*51
             -2+3);DATE[4]=ReadFlash(i*512+4);DATE[5]=ReadFlash(i*512+5);BZ=1;}
 903   2      
 904   2                      i=DATE[0];j=i%16;i=i/16;i=i*10+j;if(i>99)BZ=0;
 905   2                      i=DATE[1];j=i%16;i=i/16;i=i*10+j;if((i==0)|(i>12))BZ=0;
 906   2                      i=DATE[2];j=i%16;i=i/16;i=i*10+j;if((i==0)|(i>31))BZ=0;
 907   2      
 908   2                      i=ReadFlash(8*512+0);
 909   2                      if(i>10)
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 16  

 910   2                      {
 911   3                              BZ=0;
 912   3                              IN2=0;
 913   3                              LED1 =0;
 914   3                      }//ĞŞ¸´Ê±ÖÓÏŞÖÆÎª10´Î
 915   2                      else 
 916   2                      {
 917   3                              EraseFlash(8*512);
 918   3                              WriteFlash(8*512,i+1);
 919   3                              IN2=1;
 920   3                              LED1 =1;
 921   3                      }
 922   2                      if(BZ)Initial();
 923   2                      else
 924   2                      {
 925   3                              while(1)
 926   3                              {
 927   4                                      //ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;while(!(S2CON&S2TI)){}
 928   4                                      DrvRun=1;//½ûÖ¹ÔËĞĞ
 929   4                                      LED1 = 0;
 930   4                                      IN2 =0;
 931   4                                      RstPower();
 932   4      
 933   4                                      //²úÉúÒ»¸ö50000*200us=10ÃëµÄÖÜÆÚ
 934   4                                      while(!Flag_Timer0){}
 935   4                                      i++;
 936   4                                      Flag_Timer0=0;
 937   4                                      if(i>50000)i=0;
 938   4      
 939   4                                      //20msÏòB°å·¢×´Ì¬                       
 940   4                                      t=i%100;
 941   4                                      if(t==1){ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;}
 942   4      
 943   4                                      //ÏÔÊ¾µØÖ·ºÍ¹ÊÕÏ´úÂë
 944   4                                      t=i/10000;ShowTimer=7;
 945   4                                      if(t==2){t0=ID2;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 946   4                                      if(t==3){t0=ID1;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 947   4                                      if(t==4){t0=ID0;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 948   4                                      if(t<2){LedStr[0]=10;LedStr[1]=0;LedStr[2]=1;}//=7ÏÔÊ¾bcd7¶Î±àÂë£¬=8Ö±½ÓÏÔÊ¾Êı¾İ
 949   4                              }
 950   3                      }
 951   2              }
 952   1      
 953   1      //¼ì²éÊ±ÖÓÊÇ·ñÕı³££¬¼ì²éÊ±ÖÓ³äµçÉèÖÃ£¬Èç¹û´íÎó±¨E01£¬Í¬Ê±ÏÔÊ¾A03£¬²¢½ûÖ¹ÔËĞĞ
 954   1              t=Read1302(READ_POWER);
 955   1              if(t!=0xAA)
 956   1              {
 957   2                      t0=0;
 958   2                      while(1)
 959   2                      {
 960   3                              //ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;while(!(S2CON&S2TI)){}
 961   3                              DrvRun=1;//½ûÖ¹ÔËĞĞ
 962   3                              LED1 = 0;
 963   3                              IN2 =0;
 964   3                              RstPower();
 965   3      
 966   3                              //²úÉúÒ»¸ö50000*200us=10ÃëµÄÖÜÆÚ
 967   3                              while(!Flag_Timer0){}
 968   3                              i++;Flag_Timer0=0;
 969   3                              if(i>50000)i=0;
 970   3      
 971   3                              //20msÏòB°å·¢×´Ì¬
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 17  

 972   3                              t=i%100;
 973   3                              if(t==1){ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;}
 974   3      
 975   3                              //ÏÔÊ¾µØÖ·ºÍ¹ÊÕÏ´úÂë
 976   3                              t=i/10000;ShowTimer=7;
 977   3                              if(t==2){t0=ID2;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 978   3                              if(t==3){t0=ID1;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 979   3                              if(t==4){t0=ID0;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 980   3                              if(t<2){LedStr[0]=10;LedStr[1]=0;LedStr[2]=3;}//=7ÏÔÊ¾bcd7¶Î±àÂë£¬=8Ö±½ÓÏÔÊ¾Êı¾İ
 981   3                      }
 982   2              }
 983   1      
 984   1      //¼ì²éÊÇ·ñÊÚÈ¨¹ıÆÚ£¬Èç¹û¹ıÆÚ±¨E01£¬Í¬Ê±ÏÔÊ¾A02£¬²¢½ûÖ¹ÔËĞĞ
 985   1              EndDate.Addr[0]=0;
 986   1              EndDate.Addr[1]=~EndYear;
 987   1              EndDate.Addr[2]=~EndMon;
 988   1              EndDate.Addr[3]=~EndDay;
 989   1      
 990   1              MeID.Addr[0]=0;
 991   1              MeID.Addr[1]=~EndYear1;
 992   1              MeID.Addr[2]=~EndMon1;
 993   1              MeID.Addr[3]=~EndDay1;
 994   1              if(EndDate.value!=MeID.value)
 995   1              {
 996   2                      EndDate=MeID;
 997   2                      MeID.Addr[0]=0;
 998   2                      MeID.Addr[1]=~EndYear2;
 999   2                      MeID.Addr[2]=~EndMon2;
1000   2                      MeID.Addr[3]=~EndDay2;
1001   2      
1002   2                      if(EndDate.value!=MeID.value)
1003   2                      {
1004   3                              EndDate=MeID;
1005   3                              MeID.Addr[0]=0;
1006   3                              MeID.Addr[1]=~EndYear;
1007   3                              MeID.Addr[2]=~EndMon;
1008   3                              MeID.Addr[3]=~EndDay;
1009   3      
1010   3                              if(EndDate.value!=MeID.value)EndDate.value=0;
1011   3                      }
1012   2              }
1013   1      
1014   1              AcceptDat.Addr[0]=0;
1015   1              AcceptDat.Addr[1]=Read1302(READ_YEAR);
1016   1              AcceptDat.Addr[2]=Read1302(READ_MONTH);
1017   1              AcceptDat.Addr[3]=Read1302(READ_DATE);
1018   1      
1019   1              if(AcceptDat.value>EndDate.value)
1020   1              {
1021   2                      while(1)
1022   2                      {
1023   3                              //ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;while(!(S2CON&S2TI)){}
1024   3                              DrvRun=1;//½ûÖ¹ÔËĞĞ
1025   3                              LED1 = 0;
1026   3                              IN2 =0;
1027   3                              RstPower();
1028   3      
1029   3                              //²úÉúÒ»¸ö50000*200us=10ÃëµÄÖÜÆÚ
1030   3                              while(!Flag_Timer0){}
1031   3                              i++;
1032   3                              Flag_Timer0=0;
1033   3                              if(i>50000)i=0;
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 18  

1034   3      
1035   3                              //20msÏòB°å·¢×´Ì¬
1036   3                              t=i%100;
1037   3                              if(t==1){ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;}
1038   3      
1039   3                              //ÏÔÊ¾µØÖ·ºÍ¹ÊÕÏ´úÂë
1040   3                              t=i/10000;ShowTimer=7;
1041   3                              if(t==2){t0=ID2;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
1042   3                              if(t==3){t0=ID1;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
1043   3                              if(t==4){t0=ID0;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
1044   3                              if(t<2){LedStr[0]=10;LedStr[1]=0;LedStr[2]=2;}//=7ÏÔÊ¾bcd7¶Î±àÂë£¬=8Ö±½ÓÏÔÊ¾Êı¾İ
1045   3                      }
1046   2              }
1047   1      
1048   1      //´æ´¢Ê±ÖÓµÄÄêÔÂÈÕÊ±·ÖÃë£¬ÒÔ±¸Êı¾İ¶ªÊ§¿ÉÒÔ×ÔĞĞ»Ø¸´Ê¹ÓÃ
1049   1              DATE[0]=Read1302(READ_YEAR);
1050   1              DATE[1]=Read1302(READ_MONTH);
1051   1              DATE[2]=Read1302(READ_DATE);
1052   1              DATE[3]=Read1302(READ_HOUR);
1053   1              DATE[4]=Read1302(READ_MINUTE);
1054   1              DATE[5]=Read1302(READ_SECOND);
1055   1      
1056   1              for(i=4;i<6;i++)
1057   1              {
1058   2                      BZ=0;
1059   2                      while(!BZ)
1060   2                      {
1061   3                              EraseFlash(i*512);
1062   3                              WriteFlash(i*512+0,DATE[0]);
1063   3                              WriteFlash(i*512+1,DATE[1]);
1064   3                              WriteFlash(i*512+2,DATE[2]);
1065   3                              WriteFlash(i*512+3,DATE[3]);
1066   3                              WriteFlash(i*512+4,DATE[4]);
1067   3                              WriteFlash(i*512+5,DATE[5]);
1068   3                              BZ=(ReadFlash(i*512+0)==DATE[0])&(ReadFlash(i*512+1)==DATE[1])&(ReadFlash(i*512+2)==DATE[2])&(ReadFlash
             -(i*512+3)==DATE[3])&(ReadFlash(i*512+4)==DATE[4])&(ReadFlash(i*512+5)==DATE[5]);
1069   3                      }
1070   2              }
1071   1      
1072   1              Flag_CheckID=0;
1073   1      }
1074          
1075          unsigned char Line;
1076          
1077          void LedWr(unsigned char Index)
1078          {
1079   1              DA=Index&0x01;
1080   1              DB=Index&0x02;
1081   1              DC=Index&0x04;
1082   1              DD=Index&0x08;
1083   1              DE=Index&0x10;
1084   1              DF=Index&0x20;
1085   1              DG=Index&0x40;
1086   1      }
1087          
1088          void ShowID()//ShowTimer=0,1ÏÔÊ¾4ÃëID2£»=2ÏÔÊ¾2ÃëID1£»=3ÏÔÊ¾2ÃëID0£»
1089          {
1090   1              unsigned int i;
1091   1              unsigned char t0,t1,t2;
1092   1              switch(ShowTimer)
1093   1              {
1094   2                      case 2:i=ID1;t2=1;break;
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 19  

1095   2                      case 3:i=ID0;t2=2;break;
1096   2                      default:i=ID2;t2=0;
1097   2              }
1098   1      
1099   1              t0=i%16;i=i/16;
1100   1              t1=i;
1101   1      
1102   1      
1103   1      }
1104          
1105          void ShowLoad()//ÏÔÊ¾¹ıÔØÊµ²âÊı¾İÓë»ù×¼Êı¾İµÄ²îÖµ£¬¾ø¶ÔÖµ3Î»Êı²»ÏÔÊ¾·ûºÅ
1106          {
1107   1              unsigned int i;
1108   1              unsigned char t0,t1,t2;
1109   1      
1110   1              RL1--;
1111   1              if(!RL1)
1112   1              {
1113   2                      RL1=100;//100*1.6ms=160ms
1114   2                      if(OverLoad<=OverLoadLimite1)
1115   2                      {
1116   3                              RL2=(RL2*2)%64;
1117   3                              if(RL2==0)RL2=1;
1118   3                              t2=RL2;
1119   3                      }else
1120   2                      {
1121   3                              RL2=RL2/2;
1122   3                              if(RL2==0)RL2=32;
1123   3                              t2=RL2;
1124   3                      }
1125   2              }
1126   1      
1127   1              if(OverLoad<=OverLoadLimite1)
1128   1              {
1129   2                      i=(OverLoadLimite1-OverLoad);
1130   2                      if(i>199)
1131   2                      {
1132   3                              t0=i%10;i=i/10;
1133   3                              t1=i%10;i=i/10;
1134   3                      }else
1135   2                      {
1136   3                              t0=i%10;i=i/10;
1137   3                              t1=i%10;i=i/10;
1138   3                              t2=Bcd7Seg[i%10];
1139   3                      }
1140   2              }
1141   1              else
1142   1          {
1143   2                      i=(OverLoad-OverLoadLimite1);
1144   2                      if(i>199)
1145   2                      {
1146   3                              t0=i%10;i=i/10;
1147   3                              t1=i%10;i=i/10;
1148   3                      }else if(i>99)
1149   2                      {
1150   3                              t0=i%10;i=i/10;
1151   3                              t1=i%10;i=i/10;
1152   3                              t2=0x46;//-1
1153   3                      }else
1154   2                      {
1155   3                              t0=i%10;i=i/10;
1156   3                              t1=i%10;i=i/10;
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 20  

1157   3                              t2=0x40;//¸ººÅ-
1158   3                      }               
1159   2              }
1160   1      
1161   1      }
1162          
1163          void ShowErrorState()
1164          {
1165   1              unsigned int i;
1166   1              unsigned char t0,t1,t2;
1167   1      
1168   1              i=ErrorState%32;
1169   1              t0=i%10;i=i/10;
1170   1              t1=i%10;
1171   1              i=ErrorState/32;
1172   1              t2=i%4;
1173   1      
1174   1      }
1175          
1176          void ShowSec()
1177          {
1178   1              unsigned char t0,t1,t2;
1179   1          //t2=Read1302 (READ_SECOND);
1180   1              t0=t2%16;
1181   1              t1=t2/16;
1182   1      }
1183          
1184          void ShowBcd()
1185          {;
1186   1      }
1187          
1188          void ShowStr()
1189          {;
1190   1      }
1191          
1192          
1193          void LedShow()
1194          {
1195   1      //ShowTimer==0,1,2,3;¿ª»úÏÔÊ¾ID,ÏÔÊ¾¹ı³Ì£¬3-,D1,D2,D3
1196   1      //ShowTimer==4;È»ºóÏÔÊ¾¹ıÔØÊı¾İ£¬Îª¹ıÔØ±ê¶¨Ìá¹©·½±ã
1197   1      //ShowTimer==5;ÔËĞĞºóÏÔÊ¾ÔËĞĞ×´Ì¬
1198   1      
1199   1              switch(ShowTimer)
1200   1              {
1201   2                      case 3:ShowID();break;
1202   2                      case 4:ShowLoad();break;
1203   2                      case 5:ShowErrorState();break;
1204   2                      case 6:ShowSec();break;
1205   2                      case 7:ShowBcd();break;
1206   2                      default:ShowStr();
1207   2              }
1208   1      }
1209          
1210          //A/D×ª»»×¼±¸
1211          void AdReady(unsigned char INDEX)
1212          {
1213   1              if(INDEX==0)ADC_CONTR=0xe3;//AÏà²âÁ¿
1214   1              else if(INDEX==1)ADC_CONTR=0xe4;//BÏà²âÁ¿
1215   1              else if(INDEX==2)ADC_CONTR=0xe5;//CÏà²âÁ¿
1216   1              else if(INDEX==3)ADC_CONTR=0xe2;//¹ıÔØ²âÁ¿
1217   1      }
1218          void delay()
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 21  

1219          {
1220   1          int i, j;
1221   1      
1222   1          for (i=0; i<100; i++)
1223   1          for (j=0; j<500; j++);
1224   1      }
1225          void AdStart()
1226          {
1227   1      /*      ADC_RES=0;
1228   1              ADC_RESL=0;
1229   1              ADC_CONTR=ADC_CONTR|0x08;
1230   1              */
1231   1      //      P1ASF = 0X04;  //ÉèÖÃP1.2¿ÚÎªAD¿Ú
1232   1      //      ADC_RES = 0;    //Çå½á¹û¼Ä´æÆ÷
1233   1      //      ADC_RESL = 0;   //Çå½á¹û¼Ä´æÆ÷
1234   1      //      CLK_DIV|=0x20;
1235   1      //      ADC_CONTR = 0x80|0x40|2|0x08;
1236   1      //      delay();
1237   1              
1238   1      //      CLK_DIV=0x20;        //Êµ¼ÊÎ¬³Ö¸´Î»³õÖµ,ÆäÖĞd5/ADRJÎ»¾ö¶¨ADC½á¹û¸ñÊ½
1239   1      }
1240          
1241          unsigned int GetAdResult()
1242          {
1243   1              unsigned int w;
1244   1      /*      while(!(ADC_CONTR&0x10)){};
1245   1              ADC_CONTR=ADC_CONTR&0xe7;
1246   1      */      
1247   1              ADC_RES = 0;    //Çå½á¹û¼Ä´æÆ÷
1248   1              ADC_RESL = 0;   //Çå½á¹û¼Ä´æÆ÷
1249   1              CLK_DIV |= 0x20;
1250   1              
1251   1              ADC_CONTR = 0x80|0x60|2|0x08;
1252   1                 _nop_();
1253   1            _nop_(); 
1254   1              _nop_();
1255   1            _nop_();  
1256   1                  _nop_();
1257   1            _nop_();
1258   1                   _nop_();
1259   1            _nop_(); 
1260   1              _nop_();
1261   1            _nop_();  
1262   1                
1263   1              while(!(ADC_CONTR & 0x10));//µÈ´ıADCÍê³É
1264   1          ADC_CONTR &= ~0x10;//Çå³ıADCÖĞ¶Ï
1265   1              w = ADC_RES ;
1266   1              w = w << 8;
1267   1              w |= ADC_RESL;
1268   1              
1269   1              
1270   1              return  w ;
1271   1      //      return ADC_RES*4+ADC_RESL%4;  //<<2µÄ2´Î·½ ×óÒÆÁ½Î»
1272   1      }
1273          
1274          sbit To1        =P5^2;
1275          sbit To2        =P0^4;
1276          sbit To3        =P0^3;
1277          sbit To7        =P2^7;
1278          sbit To8        =P7^4;
1279          sbit To9        =P7^5;
1280          sbit To10       =P0^3; //Ô­³ÌĞòp7^6       ÉÏÉı¼ì²â       ĞÂ³ÌĞò TO1 p0.3
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 22  

1281          sbit To11       =P7^7;
1282          sbit To12       =P4^5;
1283          sbit To13       =P4^6;
1284          sbit To14       =P0^2;//Ô­³ÌĞò P0^0  ÏÂ½µ¼ì²â    ĞÂ³ÌĞò TO2 P0.2
1285          sbit To15       =P0^1;
1286          sbit To16       =P0^2;
1287          
1288          void StateCheck(void)//×´Ì¬¼ì²â
1289          {
1290   1      //Êı¾İ¶ÁÈ¡
1291   1      //Èç¹ûÓĞ24V£¬DatOut=0,State[]!=0
1292   1      //¶ÁÈ¡Ë³ĞòÓĞµçÂ·°å¾ö¶¨
1293   1              
1294   1              if(!To1){if(State[1]<200)State[1]++;}else{if(State[1]>0)State[1]--;}
1295   1              if(!To2){if(State[2]<200)State[2]++;}else{if(State[2]>0)State[2]--;}
1296   1              if(!To3){if(State[3]<200)State[3]++;}else{if(State[3]>0)State[3]--;}
1297   1              if(!To7){if(State[7]<200)State[7]++;}else{if(State[7]>0)State[7]--;}
1298   1              if(!To8){if(State[8]<200)State[8]++;}else{if(State[8]>0)State[8]--;}
1299   1              if(!To9){if(State[9]<200)State[9]++;}else{if(State[9]>0)State[9]--;}
1300   1              if(!To10) //Èç¹ûµçÆ½±äµÍ(³£Ì¬Îª¸ß)ËµÃ÷ÉÏÉı×´Ì¬
1301   1              {       
1302   2                      if(A1 != To10); //°´ÏÂ°´¼üto10 = 0 ,a=0
1303   2                      {       
1304   3                                      FF=0;
1305   3                                      UP = 1;
1306   3                      }
1307   2                      FlagRun = 1;
1308   2                      if(State[10]<200)
1309   2                              State[10]++;
1310   2              }
1311   1              else
1312   1              {
1313   2                      if(State[10]>0)
1314   2                              State[10]--;
1315   2              } //ÉÏÉı
1316   1              if(!To11){if(State[11]<200)State[11]++;}else{if(State[11]>0)State[11]--;}
1317   1              if(!To12){if(State[12]<200)State[12]++;}else{if(State[12]>0)State[12]--;}
1318   1              if(!To13){if(State[13]<200)State[13]++;}else{if(State[13]>0)State[13]--;}
1319   1              if(!To14)//Èç¹ûµçÆ½±äµÍ(³£Ì¬Îª¸ß)ËµÃ÷ÏÂ½µ×´Ì¬
1320   1              {  
1321   2                      if(B1 != To14); //°´ÏÂ°´¼üto10 = 0 ,a=0
1322   2                      {
1323   3                              B1 = To14;
1324   3                              FF = 0;
1325   3                              UP = 1;
1326   3                      }
1327   2                      FlagRun = 1;
1328   2                      if(State[14]<200)
1329   2                              State[14]++;
1330   2              }
1331   1              else
1332   1              {
1333   2                      if(State[14]>0)
1334   2                              State[14]--;
1335   2              } //ÏÂ½µ
1336   1              if(!To15){if(State[15]<200)State[15]++;}else{if(State[15]>0)State[15]--;}
1337   1              if(!To16){if(State[16]<200)State[16]++;}else{if(State[16]>0)State[16]--;}
1338   1      }
1339          
1340          bit PhaseErrorCheck()
1341          {
1342   1      /*
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 23  

1343   1      AÏà:00,01,02,03,04,05,06,07,  08,09,10,11,12,13,14,15,  16,17,18,19,20,21,22,23,
1344   1      BÏà:16,17,18,19,20,21,22,23,  00,01,02,03,04,05,06,07,  08,09,10,11,12,13,14,15,
1345   1      CÏà:08,09,10,11,12,13,14,15,  16,17,18,19,20,21,22,23,  00,01,02,03,04,05,06,07,
1346   1      */
1347   1              unsigned char a[3];
1348   1              a[0]=PhaseTimer[0];
1349   1              a[2]=PhaseTimer[1];
1350   1              a[1]=PhaseTimer[2];
1351   1      
1352   1              //´íÏà7
1353   1              if(!FlagErrorPhase)//²»´íÏà
1354   1              {
1355   2                      if((a[0]<40)&(a[1]<40)&(a[2]<40))//3Ïà¶¼ÓĞµçÁ÷Í¨¹ı;200us*4*40=32ms
1356   2                      {
1357   3                              if(a[0]<a[1])//AÏà:00,01,02,03,04,05,06,07
1358   3                              {
1359   4                                      if((a[2]>a[0])&(a[2]<a[1]))
1360   4                                      {
1361   5                                              if(PhaseError!=0)PhaseError--;
1362   5                                      }
1363   4                                      else
1364   4                                      {
1365   5                                              /*´íÏà*/if(PhaseError<200)PhaseError++;
1366   5                                      }
1367   4                              }
1368   3                              else
1369   3                              {
1370   4                                      if((a[2]>a[0])|(a[2]<a[1]))//AÏà:08,09,10,11,12,13,14,15,  16,17,18,19,20,21,22,23,
1371   4                                      {
1372   5                                              if(PhaseError!=0)PhaseError--;
1373   5                                      }
1374   4                                      else
1375   4                                      {
1376   5                                              /*´íÏà*/if(PhaseError<200)PhaseError++;
1377   5                                      }                               
1378   4                              }
1379   3                      }
1380   2              }
1381   1              if(PhaseError>100)//´íÏà
1382   1              {
1383   2                      PhaseError=150;
1384   2                      ErrorState=Alarm+Error+7;//ERROR
1385   2                      FlagErrorPhase=1;
1386   2              }
1387   1              
1388   1              return FlagErrorPhase;
1389   1      }
1390          
1391          bit PowerCheck()   //zjb
1392          {
1393   1      //µçÑ¹±¨¾¯²ÉÓÃÍÆÍìÉè¼Æ
1394   1      
1395   1              //if(SecCount>(255-20*1))//25ms*20=500ms
1396   1              if(SecCount>(255-100))//25ms*100=2.5s£¬
1397   1              {//Æô¶¯2.5s²»¼ì²â£¬µÈ´ıµçÂ·ÎÈ¶¨   20130924
1398   2              }
1399   1              else if((LoadCurrent[0]<LosePower)&(LoadCurrent[1]<LosePower)&(LoadCurrent[2]<LosePower)&(LoadCurrent[3]<
             -LosePower))
1400   1              {//Î´¼ì²âµ½ÓĞĞ§µçÑ¹£¬²»¼ì²â£¬ÒÔ±ãÓÚµçÂ·°å¼ì²â2017-5-25
1401   2              }
1402   1              else
1403   1              {
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 24  

1404   2                      if(FlagPowerL)//Ç·Ñ¹Ê±
1405   2                      {
1406   3                              if((LoadCurrent[0]>MinPower)&(LoadCurrent[1]>MinPower)&(LoadCurrent[2]>MinPower))FlagPowerL=0;//²»Ç·Ñ¹
1407   3                              else {FlagPowerL=1;ErrorState=Alarm+Error+21;}
1408   3                      }else //Õı³£Ê±
1409   2                      {
1410   3                              if((LoadCurrent[0]<MinPower)|(LoadCurrent[1]<MinPower)|(LoadCurrent[2]<MinPower)){FlagPowerL=1;ErrorSta
             -te=Alarm+Error+21;}
1411   3                              else FlagPowerL=0;//²»Ç·Ñ¹
1412   3                      }
1413   2              
1414   2                      if(FlagPowerH)//³¬Ñ¹Ê±
1415   2                      {
1416   3                              if((LoadCurrent[0]<MaxPower)&(LoadCurrent[1]<MaxPower)&(LoadCurrent[2]<MaxPower))FlagPowerH=0;//²»³¬Ñ¹
1417   3                              else {FlagPowerH=1;ErrorState=Alarm+Error+20;}
1418   3                      }else //Õı³£Ê±
1419   2                      {
1420   3                              if((LoadCurrent[0]>MaxPower)|(LoadCurrent[1]>MaxPower)|(LoadCurrent[2]>MaxPower)){FlagPowerH=1;ErrorSta
             -te=Alarm+Error+20;}
1421   3                              else FlagPowerH=0;//²»³¬Ñ¹
1422   3                      }
1423   2              }
1424   1      
1425   1              if(Sec5>1){FlagPowerH=0;FlagPowerL=0;}//2015-08-12
1426   1      
1427   1              
1428   1              /*È±Ïà*/
1429   1              if(
1430   1                  ((LoadCurrent[0]>MinPower)|(LoadCurrent[1]>MinPower)|(LoadCurrent[2]>MinPower))//¼ì²âµ½ÓĞĞ§µçÑ¹
1431   1                 &((LoadCurrent[0]<LosePower)|(LoadCurrent[1]<LosePower)|(LoadCurrent[2]<LosePower)|(LoadCurrent[3]<Los
             -ePower))//L1~NµçÑ¹¹ıµÍ
1432   1                )
1433   1      
1434   1              {FlagLosePhase=1;ErrorState=Alarm+Error+8;}
1435   1              else FlagLosePhase=0;
1436   1              /*´íÏà*/
1437   1              PhaseErrorCheck();
1438   1              
1439   1              //FlagPower=0;//test ÆÁ±ÎÒÔÉÏÅĞ¶Ï
1440   1              return FlagPowerH|FlagPowerL|FlagLosePhase|FlagErrorPhase;
1441   1      }
1442          void OverLoadCheck()
1443          {
1444   1              unsigned char xx;       
1445   1              if(OverLoadCount>500)//200us*4*500=400ms
1446   1              {
1447   2                      OverLoad=OverLoad1/OverLoadCount;
1448   2                      OverLoad1=OverLoad;
1449   2                      OverLoadCount=1;
1450   2              }
1451   1      //      for(xx=0;xx<64;xx++)
1452   1      //      {
1453   1      //              OverLoad1=LoadDot[xx]+OverLoad1;        
1454   1      //      }
1455   1      //      OverLoad = OverLoad1/64;
1456   1      //      OverLoad1 = 0;
1457   1      //              SBUF = OverLoad>>8;
1458   1      //               TI=0;
1459   1      //              while(!TI);
1460   1      //              TI=0;
1461   1      //              SBUF = OverLoad;
1462   1      //              while(!TI);
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 25  

1463   1              if((OverLoad>=576)&&(!FlagRun)&&(!UP))   //¹ıÔØ  
1464   1              {
1465   2                      if(!FlagRun) //°´Å¥Î´´¥·¢
1466   2                      {       
1467   3                              if(!UP)         //Î´¼ì²âµ½ÉÏÉıÑØ
1468   3                              {
1469   4                                      IN3 = 0;                //¹ıÔØ
1470   4                                      LED2 = 0;
1471   4                                      ErrorState=Alarm+Error+10;//ERROR
1472   4                                      FlagOverLoad=1;
1473   4                              }  
1474   3                              else  //¼ì²âµ½ÉÏÉıÑØ,¼ÆÊ±2s
1475   3                              {       
1476   4                              
1477   4                                      IN3 = 1;                //²»¹ıÔØ
1478   4                                      LED2 = 1;
1479   4                                              
1480   4                              }
1481   3                              if(!PRESS)              //Î´¼ì²âµ½ÉÏÉıÑØ
1482   3                              {
1483   4                                      
1484   4                                      IN3 = 0;                //¹ıÔØ
1485   4                                      LED2 = 0;
1486   4                                      ErrorState=Alarm+Error+10;//ERROR
1487   4                                      FlagOverLoad=1;
1488   4                              }  
1489   3                              else  //¼ì²âµ½ÉÏÉıÑØ,¼ÆÊ±2s
1490   3                              {
1491   4                                      
1492   4                                      PRESS = 0; 
1493   4                                      IN3 = 1;                //²»¹ıÔØ
1494   4                                      LED2 = 1;       
1495   4                              }
1496   3                      }
1497   2                      else
1498   2                      {
1499   3                              
1500   3                         IN3 = 1;             //²»¹ıÔØ
1501   3                              LED2 = 1;
1502   3                      }
1503   2              
1504   2              }//2014/3/19
1505   1              else
1506   1              {
1507   2                      FlagRun = 0;
1508   2                      FlagOverLoad=0;         //²»¹ıÔØ
1509   2                      IN3 = 1;
1510   2                      LED2 = 1;
1511   2                      FF++;           //¼ÆÊ±±êÖ¾
1512   2                      if(FF>50000)
1513   2                      {
1514   3                              UP = 0; 
1515   3                      } 
1516   2                              
1517   2              }
1518   1              
1519   1      //      return FlagOverLoad;
1520   1      }
*** WARNING C280 IN LINE 1444 OF CONTR50L.C: 'xx': unreferenced local variable
1521          
1522          //2012-10-26
1523          bit MainSwitchCheck()
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 26  

1524          {
1525   1      bit sta;
1526   1      /*
1527   1              ÏäÍâ¼±Í£
1528   1              ÏäÄÚ¼±Í£
1529   1              ÃÅ½û
1530   1              ½ô¼±ÉÏÏŞÎ»
1531   1              °²È«Ëø
1532   1              ÈÈ¼Ì
1533   1      */
1534   1      
1535   1              sta=1;FlagRun=0;        
1536   1              if(State[0]<50)         ErrorState=Error+1;//AC24V¹ÊÕÏ
1537   1              if(State[1]<50)         ErrorState=Error+1;//Ô¿³×¿ª¹Ø
1538   1              if(State[2]<50)         ErrorState=Error+3;//ÏäÍâ¼±Í£3
1539   1              else if(State[3]<50)ErrorState=Error+2; //ÏäÄÚ¼±Í£2
1540   1              else if(State[4]<50)ErrorState=Error+1; //¼ÌµçÆ÷6
1541   1              else if(State[5]<50)ErrorState=Error+17;//±¸ÓÃÃÅ17
1542   1              else if(State[6]<50)ErrorState=Error+16;//ÃÅ½û16
1543   1              else if(State[7]<50)ErrorState=Alarm+Error+4;//½ô¼±ÉÏÏŞÎ»4
1544   1              else if(State[8]<50)ErrorState=Alarm+Error+18;//°²È«Ëø18
1545   1              else if(State[9]<50)ErrorState=Alarm+Error+9;//ÈÈ¼Ì9
1546   1              else {sta=0;FlagRun=1;}
1547   1      
1548   1      
1549   1              return sta;
1550   1      }
1551          
1552          //2012-10-26
1553          bit UpSwitchCheck()
1554          {
1555   1              bit sta;
1556   1              sta=1;
1557   1              if(State[10]>0)//ÉÏÉı
1558   1              {
1559   2                      FlagStart=1;
1560   2      
1561   2                              ErrorState=2;
1562   2                              FlagRun=1;
1563   2              }
1564   1              else
1565   1          {
1566   2                      sta=0;
1567   2                      FlagRun=0;
1568   2              }
1569   1              
1570   1              return sta;
1571   1      }
1572          
1573          //2012-10-26
1574          bit DownSwitchCheck()
1575          {
1576   1              bit sta;
1577   1              sta=1;
1578   1              if(State[14]>150)//ÏÂ½µ
1579   1              {
1580   2                      FlagStart=1;
1581   2                              FlagRun=1;
1582   2              }
1583   1              else
1584   1          {
1585   2                      sta=0;
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 27  

1586   2                      FlagRun=0;
1587   2              }
1588   1              
1589   1              return sta;
1590   1      }
1591          
1592          void StateShow()
1593          {
1594   1              FlagRun=0;
1595   1              if(FlagStart)ErrorState=1;//Í£Ö¹×´Ì¬1
1596   1              else ErrorState=0;
1597   1      }
1598          
1599          //¹ÊÕÏ·ÖÎö
1600          void StateErrorCheck()
1601          {
1602   1      
1603   1      
1604   1              if(SecCount>(255-20*1))//25ms*20=500ms
1605   1              {
1606   2                      if(FlagErrorPhase)//±£Ö¤500msÃëÄÚÔÊĞí´íÏàÔËĞĞ£¬ÒÔ±ã²ğĞ¶¸ÖË¿Éş
1607   2                      {
1608   3                              DrvRun=0;
1609   3                              SecCount=255;//2012-3-24 ±¨´íºó£¬Èç¹ûÍ£Ö¹²Ù×÷
1610   3                      }
1611   2      
1612   2                      if(State[14]>150)DrvSl3=0;      //Èç¹ûÏÂ½µ£¬¶Ï¿ª°²È«Ëø¼ÌµçÆ÷2017-05-22
1613   2              }
1614   1              else
1615   1              {
1616   2                      DrvRun=FlagOverLoad|FlagErrorPhase|FlagLosePhase|OverTimer;//2017-5-25
1617   2                      DrvSl3=0;       //¶Ï¿ª°²È«Ëø¼ÌµçÆ÷
1618   2              }
1619   1      }
1620          
1621          void Verify()
1622          {
1623   1              unsigned char check;
1624   1              check=0;
1625   1              if(ErrorState&0x01)check++;
1626   1              if(ErrorState&0x02)check++;
1627   1              if(ErrorState&0x04)check++;
1628   1              if(ErrorState&0x08)check++;
1629   1              if(ErrorState&0x10)check++;
1630   1              if(ErrorState&0x20)check++;
1631   1              if(ErrorState&0x40)check++;
1632   1              if(check&0x01)ErrorState=ErrorState+0x80;
1633   1      }
1634          
1635          //**********************************************************************2017-5-31
1636          void SxBUF_Init()
1637          {
1638   1      //´®¿Ú
1639   1              TH1=0x100-Crystal/12/16/BaudRate;TL1=0x100-Crystal/12/16/BaudRate;
1640   1      //1
1641   1              SCON=0x58;
1642   1              T2H=(65536-Crystal/4/BaudRate)/256;
1643   1              T2L=(65536-Crystal/4/BaudRate)%256;
1644   1      //2
1645   1              S2CON=0x58;//S2SM0/NC/S2SM2/S2REN/S2TB8/S2RB8/S2TI/S2RI
1646   1      //3     
1647   1              S3CON=0x98;//S3SM0/S3ST3/S3SM2/S3REN/S3TB8/S3RB8/S3TI/S3RI
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 28  

1648   1      //4     
1649   1              S4CON=0x98;//S4SM0/S4ST4/S4SM2/S4REN/S4TB8/S4RB8/S4TI/S4RI
1650   1              //¸¨Öú¼Ä´æÆ÷
1651   1              AUXR=0X14;//T0*12/T1*12/UART_M0*6/T2R/T2_CT/T2*12/EXTRAM/S1ST2;S1ST2ÉèÖÃ´®¿Ú1Ê¹ÓÃ¶¨Ê±Æ÷T2
1652   1              AUXR|=0X01;
1653   1      }
1654          
1655          //200us¶¨Ê±ÖĞ¶Ï³ÌĞò
1656          //Ê±ÖÓÊ±¼ä½Ú×à×¼È·
1657          void timer0(void) interrupt 1 /*T0ÖĞ¶Ï*/
1658          {
1659   1              unsigned char xxx;
1660   1              TH0=(65536-Crystal/12000*InitTime/1000)/256;
1661   1              TL0=(65536-Crystal/12000*InitTime/1000)%256;
1662   1      
1663   1              WDT_CONTR=0x3e;//2.72Ãë¿´ÃÅ¹·
1664   1      
1665   1              Clock_1s++;
1666   1              if(Clock_1s>9999)
1667   1              {
1668   2                      if(ShowTimer<4)ShowTimer++;
1669   2                      Clock_1s=0;
1670   2              }
1671   1      
1672   1              if(FlagStart)ShowTimer=5;
1673   1              
1674   1              if(Flag_CheckID)//Èç¹ûÔÚ¼ì²âÊÚÈ¨Ìø¹ıËùÓĞ²Ù×÷
1675   1              {
1676   2                      LedShow();
1677   2                      Flag_Timer0=1;
1678   2                      goto timer0end;
1679   2              }
1680   1         
1681   1      //      AdStart();//ok
1682   1      //      StateCheck();//ok
1683   1      
1684   1      
1685   1              if(LoadIndex==0)//0.8msÒ»´Î
1686   1              {
1687   2                      OverLoad1=OverLoad1+LoadDot[3];
1688   2                      OverLoadCount++;
1689   2                      OverLoadCheck();
1690   2              }
1691   1              LoadDot[LoadIndex]=GetAdResult();
1692   1      
1693   1              LoadIndex=(LoadIndex+1)%4;
1694   1              
1695   1      //              SBUF = OVERLOAD1>>8;
1696   1      //              TI=0;
1697   1      //              WHILE(!TI);
1698   1      //              TI=0;
1699   1      //              SBUF = OVERLOAD1;
1700   1      //              WHILE(!TI);
1701   1      //              TI=0;
1702   1      //              SBUF =AD_SUM ;
1703   1      //              WHILE(!TI);
1704   1              //¹ıÔØ²âÊÔÖµÈ¡¾ø¶ÔÖµ£¬´ËÊ±ÕıÔÚ²âÁ¿AÏà£¬¹ıÔØÒÑ²âÁ¿Íê±Ï
1705   1       /*     if(LoadIndex==0)//0.8msÒ»´Î     200us*4
1706   1              {
1707   1              //      OverLoad1=OverLoad1+LoadDot[3];//¹ıÔØÊıÖµ¼ÆËã
1708   1               
1709   1                      OverLoadCount++;
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 29  

1710   1                      if(DelaySecCount>0)DelaySecCount--;
1711   1                      SumCount++;
1712   1                      
1713   1                      CountIndex=SumCount%CheckCycle;
1714   1              }
1715   1                      if(CountIndex==0)//0.8ms*31=24.8ms
1716   1                      {
1717   1                              StateErrorCheck();
1718   1                              //2017-5-25
1719   1                              //start
1720   1                              if(SumCount>(CheckCycle*40))//800us*31*40=992ms
1721   1                              {
1722   1                                      LoadCurrent[0]=SumLoadCurrent[0]/SumCount;SumLoadCurrent[0]=0;
1723   1                                      LoadCurrent[1]=SumLoadCurrent[1]/SumCount;SumLoadCurrent[1]=0;
1724   1                                      SumLoadCurrent[2]=SumLoadCurrent[2]/1.06;//Êµ²â50hzÊÇ1.053£¬¼ÆËã»úÄ£Äâ50hzÊÇ1.053~1.056£¬60hzÊÇ1.064~1
             -.066£¬ÕÛÖĞÈ¡1.06
1725   1                                      //LoadCurrent[2]=SumLoadCurrent[2]/SumCount;SumLoadCurrent[2]=0;
1726   1                                      LoadCurrent[2]=LoadCurrent[1];SumLoadCurrent[2]=0;//¿¼ÂÇµ½²»ÊÇÖ±½Ó²âÁ¿£¬ÎÊÌâ½Ï´ó£¬²»ÔÙÊ¹ÓÃ20130503
1727   1                                      LoadCurrent[3]=SumLoadCurrent[3]/SumCount;SumLoadCurrent[3]=0;
1728   1      
1729   1                                      SumCount=0;
1730   1                                      Sec5++;
1731   1                                      Sec5=Sec5%5;//2015-08-12
1732   1                              }
1733   1      
1734   1                              if(FlagRun)L_Run=(SumCount>(CheckCycle*20));//1ºÕ×ÈÉÁË¸
1735   1                              else L_Run=0;
1736   1                              
1737   1                              Verify();
1738   1                              S2CON&=~S2TI;
1739   1                              S2BUF=ErrorState;
1740   1      
1741   1                              if(SecCount>0)SecCount--;
1742   1                              if(SecCount==0)
1743   1                              {
1744   1                                      SecCount=100;//2.5sec
1745   1                              }
1746   1      
1747   1                      }
1748   1                      else if(CountIndex&0x01)LedShow();//1.6msÒ»´Î
1749   1              }
1750   1      */      
1751   1      /*
1752   1              LoadIndex==1Ê±£¬AÏàµçÁ÷·ÖÎö£¬´ËÊ±ÕıÔÚ²âÁ¿BÏà£¬AÏàÒÑ²âÁ¿Íê±Ï
1753   1              LoadIndex==2Ê±£¬BÏàµçÁ÷·ÖÎö£¬´ËÊ±ÕıÔÚ²âÁ¿CÏà£¬BÏàÒÑ²âÁ¿Íê±Ï
1754   1              LoadIndex==3Ê±£¬CÏàµçÁ÷·ÖÎö£¬´ËÊ±ÕıÔÚ²âÁ¿¹ıÔØ£¬CÏàÒÑ²âÁ¿Íê±Ï
1755   1              
1756   1              µ±µçÁ÷LoadDot[]>(LoadZero+LoadMin)Ê±£¬±íÊ¾ÓĞÕıµçÁ÷£¬¼«ĞÔPolarity[]±êÎª1
1757   1              µ±µçÁ÷LoadDot[]>(LoadZero-LoadMin)Ê±£¬±íÊ¾ÓĞ¸ºµçÁ÷£¬¼«ĞÔPolarity[]±êÎª0
1758   1              µ±¼«ĞÔPolarity[]ÓÉ0±äÎª1Ê±£¬PhaseTimer[]¿ªÊ¼¼ÆÊ±,
1759   1              µ±¼«ĞÔPolarity[]ÓÉ0±äÎª1Ê±£¬LoadCurrent[]¼ÆËã²¢ÀÛ¼Æ,
1760   1      
1761   1      */
1762   1              //ABÏàµçÑ¹
1763   1      /*      if(LoadIndex==1)
1764   1              {
1765   1                      LoadDot[0]=1024-LoadDot[0];//²âÁ¿µÄÊÇBAµçÑ¹£¬×ªAB
1766   1                      if(LoadDot[0]>LoadZero)
1767   1                      {
1768   1                              SumLoadCurrent[0]=SumLoadCurrent[0]+LoadDot[0]-LoadZero;//2012-11-28
1769   1                      }
1770   1                      else
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 30  

1771   1                      {
1772   1                              SumLoadCurrent[0]=SumLoadCurrent[0]+LoadZero-LoadDot[0];//2012-11-28    
1773   1                      }
1774   1                      
1775   1                      if(!Polarity0)//Èç¹ûµçÁ÷¸º°ëÖÜÆÚ
1776   1                      {
1777   1                              if(LoadDot[0]>(LoadZero+LoadMin))//½øÈëÕı°ëÖÜ
1778   1                              {
1779   1                                      Polarity0=1;
1780   1                                      PhaseTimer[0]=0;
1781   1                              }
1782   1                              
1783   1                      }
1784   1                      else
1785   1                      {
1786   1                              if(LoadDot[0]<(LoadZero-LoadMin))//½øÈë¸º°ëÖÜ
1787   1                              {
1788   1                                      Polarity0=0;
1789   1                              }
1790   1                      }
1791   1                      
1792   1                      if(PhaseTimer[0]<199)PhaseTimer[0]++;
1793   1              }
1794   1              
1795   1              //CAÏàµçÑ¹
1796   1              if(LoadIndex==2)
1797   1              {
1798   1                      if(LoadDot[1]>LoadZero)
1799   1                      {
1800   1                              SumLoadCurrent[1]=SumLoadCurrent[1]+LoadDot[1]-LoadZero;//2012-11-28
1801   1                      }
1802   1                      else 
1803   1                      {
1804   1                              SumLoadCurrent[1]=SumLoadCurrent[1]+LoadZero-LoadDot[1];//2012-11-28
1805   1                      }
1806   1                      
1807   1                      if(!Polarity1)//Èç¹ûµçÁ÷¸º°ëÖÜÆÚ
1808   1                      {
1809   1                              if(LoadDot[1]>(LoadZero+LoadMin))//½øÈëÕı°ëÖÜ
1810   1                              {
1811   1                                      Polarity1=1;
1812   1                                      PhaseTimer[1]=0;
1813   1                                      
1814   1                              }
1815   1                      }else
1816   1                      {
1817   1                              if(LoadDot[1]<(LoadZero-LoadMin))//½øÈë¸º°ëÖÜ
1818   1                              {
1819   1                                      Polarity1=0;
1820   1                              }
1821   1                      }
1822   1                      
1823   1                      if(PhaseTimer[1]<199)PhaseTimer[1]++;
1824   1              }
1825   1      
1826   1              
1827   1              //BCÏàµçÑ¹ºÍAÏßµçÑ¹
1828   1              if(LoadIndex==3)
1829   1              {
1830   1                      //AÏßµçÑ¹
1831   1                      if(LoadDot[2]>LoadZero)SumLoadCurrent[3]=SumLoadCurrent[3]+LoadDot[2]-LoadZero;//2012-11-28
1832   1                      else SumLoadCurrent[3]=SumLoadCurrent[3]+LoadZero-LoadDot[2];//2012-11-28
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 31  

1833   1              
1834   1                      //BCÏàµçÑ¹
1835   1                      LoadDot[2]=1024-(LoadDot[0]+LoadDot[1]-LoadZero);
1836   1                      if(LoadDot[2]>LoadZero)
1837   1                      {
1838   1                              SumLoadCurrent[2]=SumLoadCurrent[2]+LoadDot[2]-LoadZero;//2012-11-28
1839   1                      }else 
1840   1                      {
1841   1                              SumLoadCurrent[2]=SumLoadCurrent[2]+LoadZero-LoadDot[2];//2012-11-28
1842   1                      }
1843   1                      
1844   1                      if(!Polarity2)//Èç¹ûµçÁ÷¸º°ëÖÜÆÚ
1845   1                      {
1846   1                              if(LoadDot[2]>(LoadZero+LoadMin))//½øÈëÕı°ëÖÜ
1847   1                              {
1848   1                                      Polarity2=1;
1849   1                                      PhaseTimer[2]=0;
1850   1                              }
1851   1                              
1852   1                      }else
1853   1                      {
1854   1                              if(LoadDot[2]<(LoadZero-LoadMin))//½øÈë¸º°ëÖÜ
1855   1                              {
1856   1                                      Polarity2=0;
1857   1                              }
1858   1                      }
1859   1                      
1860   1                      if(PhaseTimer[2]<199)PhaseTimer[2]++;
1861   1              }
1862   1               */
1863   1              
1864   1      //      LoadIndex=(LoadIndex+1)%4;
1865   1      //      AdReady(3);
1866   1      
1867   1      timer0end:;
1868   1      }
*** WARNING C280 IN LINE 1659 OF CONTR50L.C: 'xxx': unreferenced local variable
1869          //-------------------ÖĞ¶Ïº¯Êı--------------------------//
1870          void Int0(void)         interrupt 0//int0
1871          {while(1){TI=0;SBUF=0x00;while(!TI){};/*Delay(1000)*/;}}
1872          void Int1(void)         interrupt 2//int1
1873          {while(1){TI=0;SBUF=0x02;while(!TI){};/*Delay(1000)*/;}}
1874          void Timer1(void)       interrupt 3//timer1
1875          {while(1){TI=0;SBUF=0x03;while(!TI){};/*Delay(1000)*/;}}
1876          void UART1(void)        interrupt 4//uart Í¨ĞÅ
1877          {while(1){TI=0;SBUF=0x04;while(!TI){};/*Delay(1000)*/;}}
1878          void ADC(void)          interrupt 5//adc Ä£Êı×ª»»
1879          {while(1){TI=0;SBUF=0x05;while(!TI){};/*Delay(1000)*/;}}
1880          void LVC(void)          interrupt 6//pca µÍÑ¹¼ì²â
1881          {while(1){TI=0;SBUF=0x06;while(!TI){};/*Delay(1000)*/;}}
1882          void PCA(void)          interrupt 7
1883          {while(1){TI=0;SBUF=0x07;while(!TI){};/*Delay(1000)*/;}}
1884          void UART2(void)        interrupt 8
1885          {while(1){TI=0;SBUF=0x08;while(!TI){};/*Delay(1000)*/;}}
1886          void SPI(void)          interrupt 9
1887          {while(1){TI=0;SBUF=0x09;while(!TI){};/*Delay(1000)*/;}}
1888          void Int2(void)         interrupt 10
1889          {while(1){TI=0;SBUF=0x10;while(!TI){};/*Delay(1000)*/;}}
1890          void Int3(void)         interrupt 11
1891          {while(1){TI=0;SBUF=0x11;while(!TI){};/*Delay(1000)*/;}}
1892          void Timer2(void)       interrupt 12
1893          {while(1){TI=0;SBUF=0x12;while(!TI){};/*Delay(1000)*/;}}
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 32  

1894          void zd13(void)         interrupt 13
1895          {while(1){TI=0;SBUF=0x13;while(!TI){};/*Delay(1000)*/;}}
1896          void zd14(void)         interrupt 14
1897          {while(1){TI=0;SBUF=0x14;while(!TI){};/*Delay(1000)*/;}}
1898          void zd15(void)         interrupt 15
1899          {while(1){TI=0;SBUF=0x15;while(!TI){};/*Delay(1000)*/;}}
1900          void Int4(void)         interrupt 16
1901          {while(1){TI=0;SBUF=0x16;while(!TI){};/*Delay(1000)*/;}}
1902          void S3(void)           interrupt 17
1903          {while(1){TI=0;SBUF=0x17;while(!TI){};/*Delay(1000)*/;}}
1904          void S4(void)           interrupt 18
1905          {while(1){TI=0;SBUF=0x18;while(!TI){};/*Delay(1000)*/;}}
1906          void Timer3(void)       interrupt 19
1907          {while(1){TI=0;SBUF=0x19;while(!TI){};/*Delay(1000)*/;}}
1908          void Timer4(void)       interrupt 20
1909          {while(1){TI=0;SBUF=0x20;while(!TI){};/*Delay(1000)*/;}}
1910          void Comparator(void) interrupt 21
1911          {while(1){TI=0;SBUF=0x21;while(!TI){};/*Delay(1000)*/;}}
1912          void PWM(void)          interrupt 22
1913          {while(1){TI=0;SBUF=0x22;while(!TI){};/*Delay(1000)*/;}}
1914          void PWMFD(void)        interrupt 23
1915          {while(1){TI=0;SBUF=0x23;while(!TI){};/*Delay(1000)*/;}}
1916          
1917          
1918          //Ö÷³ÌĞò
1919          void main()
1920          {
1921   1      //unsigned int ii;
1922   1      //unsigned char i;
1923   1      //¿´ÃÅ¹·³ÌĞò
1924   1      /*
1925   1              i=WDT_CONTR;
1926   1              if(i>127)//Èç¹û¿´ÃÅ¹·¸´Î»
1927   1              {
1928   1                      while(1){};
1929   1              }else WDT_CONTR=0x3e;//2.72Ãë¿´ÃÅ¹·
1930   1      */
1931   1      
1932   1      //*****************************************
1933   1      //Ó²¼ş³õÊ¼»¯
1934   1              IE=0;
1935   1      //T0
1936   1              TH0=(65536-Crystal/12000*InitTime/1000)/256;
1937   1              TL0=(65536-Crystal/12000*InitTime/1000)%256;
1938   1              TMOD=0x21;TR0=1;ET0=1;
1939   1      
1940   1              SxBUF_Init();
1941   1      
1942   1      //      ADC_CONTR=0x60;//½«×ª»»ËÙ¶ÈÉèÎª×î¸ß,210¸öÊ±ÖÓÖÜÆÚ
1943   1      //      ADC_CONTR=ADC_CONTR|0x80;//´ò¿ª×ª»»µçÔ´
1944   1              PX0=0;PT0=1;IP2=0;
1945   1      
1946   1      //      ADC_CONTR=0x60;//½«×ª»»ËÙ¶ÈÉèÎª×î¸ß,210¸öÊ±ÖÓÖÜÆÚ
1947   1      //      ADC_CONTR=ADC_CONTR|0x80;//´ò¿ª×ª»»µçÔ´
1948   1      //½«P1.3,P1.4,P1.5ÉèÖÃÎªA/D×ª»»Ä£Ê½
1949   1      
1950   1      /*
1951   1      M1      M0
1952   1      0       0       Ë«Ïò
1953   1      0       1       Êä³ö
1954   1      1       0       ÊäÈë
1955   1      1       1       ¿ªÂ©¡¢AD
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 33  

1956   1      
1957   1      O       Êä³ö
1958   1      I       ÊäÈë
1959   1      NC      Î´ÓÃÒı½Å
1960   1      N0      Ã»ÓĞÒı½Å
1961   1      */
1962   1              //01234567
1963   1          //TO14,TO15,TO16,TO3,TO2,S1,S0,NC
1964   1              P0M1=0x0c;P0M0=0x00;
1965   1      
1966   1              //RXD2,TXD2,LOAD,AD0,AD1,AD2,2.5V,NC
1967   1              //P1M1=~0x03;P1M0=~0x03;
1968   1              P1M1=0xff;P1M0=0x00;
1969   1              P1ASF = 0Xff; 
1970   1              //NC,NC,NC,NC,TO4,TO5,TO6,TO7
1971   1              P2M1=0x00;P2M0=0x00;
1972   1      
1973   1          //RXD,TXD,IN8,IN7,IN6,IN3,IN2,IN1
1974   1              P3M1=0x00;P3M0=~0x03;//01´®¿Ú+6¸ö2803
1975   1      
1976   1              //NC,DF,DB,DA,NC,TO12,TO13,NC
1977   1              P4M1=0x00;P4M0=0x00;
1978   1      
1979   1              //IN5,IN4,TO1,NC,NC,NC,NO,NO
1980   1              P5M1=0x00;P5M0=0x03;//2¸ö2803+1¸ö¹âÅ¼
1981   1      
1982   1              //DG,DE,DD,DC,TO8,TO9,TO10,TO11
1983   1              P7M1=0x00;P7M0=0x00;
1984   1      
1985   1      //test end
1986   1              ErrorState      =0;
1987   1              DrvUpSta        =0;
1988   1              FlagOverLoad    =0;
1989   1              FlagErrorPhase  =0;
1990   1              FlagLosePhase   =0;
1991   1              FlagStart       =0;
1992   1              DrvSl3          =1;//±ÕËø°²È«Ëø
1993   1              DrvRun          =0;//ÔÊĞíÔËĞĞ
1994   1              
1995   1              OverLoad=0;
1996   1              OverLoadCount=1;
1997   1              Polarity0=0;
1998   1              Polarity1=0;
1999   1              Polarity2=0;
2000   1              PhaseError=0;
2001   1              PhaseTimer[0]=0;
2002   1              PhaseTimer[1]=0;
2003   1              PhaseTimer[2]=0;
2004   1              PhaseLose=0;
2005   1              
2006   1              CountIndex=0;
2007   1              SecCount=255;
2008   1      
2009   1              GaoDu=0;
2010   1      
2011   1      //2017-5-25 start
2012   1              OneMin=0;
2013   1              FlagOverTimer=0;
2014   1              OverTimer=0;
2015   1              CheckID();
2016   1      
2017   1      //2017-5-25 end
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 16:51:01 PAGE 34  

2018   1              EA=1;   //µ÷ÊÔÊ±¹Ø¶Ï
2019   1              while(1)
2020   1              {
2021   2      //         Delay_us(10000);//24.8ms
2022   2      //         Delay_us(20000);//50ms
2023   2      //         Delay_us(30000);//75ms
2024   2                      LED3 = 0;
2025   2                      RstPower();
2026   2                      _nop_();
2027   2                      _nop_();
2028   2                      _nop_();
2029   2                      _nop_();
2030   2              }
2031   1      }
2032          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   7239    ----
   CONSTANT SIZE    =     64    ----
   XDATA SIZE       =    194    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     36      42
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     16       3
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
