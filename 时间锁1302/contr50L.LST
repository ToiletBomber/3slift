C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 1   


C51 COMPILER V8.05a, COMPILATION OF MODULE CONTR50L
OBJECT MODULE PLACED IN contr50L.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE contr50L.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          //zjbtest
   2          /*
   3          *****************************±ØĞëÊ¹ÓÃ×Ô¶¯ÔöÁ¿Ä£Ê½£¬ÆğÊ¼µØÖ·0x22£¬ÔöÁ¿³¤¶È3£¬ÔöÁ¿Öµ1£¬Ê®½øÖÆ¸ñÊ½
   4          *****************************×¢Òâ£¬
   5          *****************************ÉÕÂ¼²ÉÓÃ18.4320M£¬
   6          *****************************µÍµçÑ¹½ûÖ¹eeprom²Ù×÷£¬
   7          *****************************eepromÌî³äÎªFF
   8          
   9          ID´æ´¢Î»ÖÃ 0x20,0x21,0x22
  10          ÊÚÈ¨ÓĞĞ§Ê±¼ä´æ´¢Î»ÖÃÒ³Âë0£¬1£¬2£¬µØÖ·0x00(Äê)£¬0x01(ÔÂ),0x02(ÈÕ)
  11          
  12          ±£´æ¿ª»úÊ±Ê±ÖÓÒ³Âë4£¬5£¬6£¬µØÖ·0x00(Äê)£¬0x01(ÔÂ),0x02(ÈÕ),0x03(Ê±),0x04(·Ö),0x05(Ãë)
  13          
  14          ±£´æÊ±ÖÓÍ£°Ú×Ô¶¯ĞŞ¸´´ÎÊıÒ³Âë8£¬µØÖ·0x00£¬µ±´óÓÚ10´Î±¨´í
  15          
  16          ¿ª»úÊÚÈ¨·½Ê½£¬¿ª»ú½øĞĞ0.1ÃëÖÓµÄ¼ì²â£¬ÅĞ¶ÏÊÇ·ñ´æÔÚÊÚÈ¨ĞèÇó
  17          
  18          2017-5-31
  19          
  20          ÔÚÒÔÇ°µÄ³ÌĞòÉÏĞŞ¸ÄÉı¼¶Îªstc15w4k32s4µÄĞÂ°æ±¾³ÌĞò£¬ÒÔÇ°³ÌĞòµÄĞŞ¸Ä¼ÇÂ¼±£Áô£¬µ«¿ÉÄÜÒÑ¾­Ã»ÓĞÒâÒå
  21          stc15w4k32s4Ê¹ÓÃÍ·ÎÄ¼ş·½Ê½£¬²»ÔÙ×Ô¼º¶¨Òå
  22          
  23          ÒÔÏÂÊÇÃ»ÓĞ1302Ç°µÄĞŞ¸Ä¼ÇÂ¼
  24          2017-5-27
  25                  1\Ê¹ÓÃÍâ²¿´æ´¢Æ÷±àÒëºó£¬Ò»Ğ©±äÁ¿ĞèÒª³õÊ¼»¯
  26                  2\ÆÁ±ÎÁËÃ»ÓĞÌ«´óÒâÒåµÄE31¹ÊÕÏ
  27          2017-5-25
  28          1\ĞÂÔö°´ÕÕÔËĞĞÊ±¼äÀ´ÉÏËø
  29                  Ö»¼ÆÉÏÉıÔËĞĞÊ±¼ä£¬
  30                  ÔËĞĞÊ±¼äÓÃ·ÖÖÓ¼Æ,Ê¹ÓÃ2¸ö×Ö½Ú,65535·Ö=1092Ğ¡Ê±£¬
  31                  ÔËĞĞÊ±¼ä³¬Ê±Ê±,Ö»ÏŞÖÆÉÏÉı,²»ÏŞÖÆÏÂ½µ,²¢Ö»ÔÚĞÂ¿ªµçÔ´Ê±²ÅÓĞĞ§£¬
  32          
  33          2\Ê±¼äËø×î´óÊ±¼äÓÃ³ÌĞòµØÖ·ĞŞ¸Ä,³ÌĞòµØÖ·Îª[0x0010,0x0011],×î´óÊ±¼ä=[0x0010]*256+[0x0011]
  34          ¶Ô16½øÖÆ,¿ÉÒÔ´ÖËã0x40ÎªÒ»Ğ¡Ê±,0x80,0xc0,0x100......
  35          
  36          3\°´ÕÕÃ¿ÖÜÊ¹ÓÃ1´Î,Ã¿´Î20·ÖÖÓ,ÉÏÉıÎª10·ÖÖÓ,³¬¹ı10·ÖÖÓµ±´Î²»ÔÚ¼ÆÊ±
  37          
  38          4\Èç¹ûÃ»ÓĞÌØÊâÒªÇó£¬×î´ó¹¤×÷Ê±³¤ÉèÎª300Ğ¡Ê±
  39          
  40          2017-05-22
  41          ÓÉÓÚ¿Í»§ÔÚ°²È«Ëø´¥·¢×´Ì¬ÏÂ£¬´íÎóÊ¹ÓÃ½âËø·½Ê½£¬¼´ÉÏµçÊ±°´ÏÂ½µ°´Å¥£¨Ó¦¸Ã°´ÉÏÉı°´Å¥È»ºóÊÖ¶¯½âËø£©£¬ËùÒÔÆÁ±Îµô
             -ÏÂ½µÓĞĞ§
  42          
  43          2017-01-04²âÊÔ½«»¥¸ĞÆ÷ÏŞÁ÷µç×èÓÉ200kÔö¼Óµ½600k,Í¬Ê±Êä³ö×è¿¹ÓÉ330Ôöµ½1k
  44          
  45          2015-08-12
  46          ÓÉÓÚÊ¹ÓÃ·¢µç»úµçÑ¹¹ıµÍ±¨¾¯»á¸²¸ÇÆäËû¹ÊÕÏ±¨¾¯,ÑÏÖØÓ°Ïì¿Í·şµ÷ÊÔ,¸ÄµçÑ¹±¨¾¯²»ÍêÈ«¸²¸ÇÔ­ÓĞ¹ÊÕÏĞÅÏ¢
  47          
  48          2015-04-08
  49          ÏÖ³¡·¢ÏÖÆµ·±±¨µçÑ¹¹ıµÍ,ĞŞ¸ÄÔ­À´360Îª330·ü
  50          
  51          2014/3/19
  52          Ôö¼ÓÒ»¸öÊ±¼ä¼ÆÊıÆ÷,ÒÔÏÂÏŞÎ»´¥·¢¹éÁã,¼ÇÂ¼µçÌİÉÏÉıºÍÏÂ½µµÄÊ±¼ä,ÒÔ±ã´Ö¹ÀÉı½µ»úµÄÎ»ÖÃ,ÅĞ¶¨¹ıÔØÊ±ÅÙ³ıµçÀÂµÄÖØÁ¿
             -ºÍ¸ÖË¿ÉşµÄÓ°Ïì,±äÁ¿Ãûint GaoDu,ÁíÉèÒ»¸ö³£Á¿(¼ÓÈ¨ÏµÊı)GaoDuK
  53          
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 2   

  54          2013-05-03ĞŞ¸Ä
  55          1¡¢²»ÔÙ¼ÆËãµÚÈıÏàµçÁ÷
  56          2¡¢¹ıÔØ²»ÔÙ²ÅÓÃÍÆÍì·½Ê½
  57          3¡¢
  58          
  59          2012-12-3²âÊÔ½á¹û
  60          1¡¢¿ª»ú±¨21ºÅ´íÎó£¬È»ºóÏûÊ§
  61          2¡¢¿ª»úÃ»ÓĞÊ±¼äÏÔÊ¾¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ªÓĞÏÔÊ¾£¬1.2Ôİ²»Ğè´¦Àí
  62          
  63          3¡¢Éè¶¨µÄ360~440£¬Êµ²â360~400
  64          4¡¢È±Ïà±¨µçÑ¹µÍ
  65          5¡¢¹ıÔØÎ´´¦Àí
  66          */
  67          
  68          
  69          /*
  70          ³ÌĞòĞŞ¸Ä¼ÇÂ¼
  71          2012-10-25 ÔÚ¶ş´úµçÌİ³ÌĞò»ù´¡ÉÏÖÆ×÷5´úµçÌİ³ÌĞò£¬Ô´³ÌĞòcontr204.c
  72          1¡¢¼ÌµçÆ÷¿ØÖÆ¹¦ÄÜÍ¨¹ı
  73          2¡¢ÕÕÃ÷Ê§°Ü£¬µÆÉÁË¸£¬¿¼ÂÇÈı¶ËÎÈÑ¹ºãÁ÷Ô´
  74          
  75          2012-11-28¼ÇÂ¼
  76          1¡¢µçÑ¹²âÊÔÍ¨¹ı
  77          2¡¢ÕÕÃ÷Ê§°Ü£¬ÎÈÑ¹Ğ¾Æ¬¹ıÈÈ£¬¿¼ÂÇ×¨ÓÃÕÕÃ÷ºãÁ÷Ô´
  78          
  79          2012-8-2
  80          ¶ÏÏà±£»¤ºÍ´íÏà±£»¤Ê±¼äÓÉ250ºÁÃë Ôö¼Óµ½2.5Ãë
  81          ³ÌĞòĞŞ¸Ä¼ÇÂ¼
  82          2012-3-24
  83          ¼ÓÈë±¸ÓÃÃÅ±¨¾¯
  84          ¶ÏÏà±£»¤µçÁ÷ÃÅÏŞÓÉ0.6Aµ÷µ½1.8A
  85          
  86          ±à³ÉÈÕÆÚ£º2009-12-25
  87          Íê³ÉµÄµ÷ÊÔ
  88          1¡¢²âÊÔµãµÄ²É¼¯ºÍË³ĞòÕûÀí
  89          2¡¢¹ıÔØµÄ¼ì²âºÍ¿ØÖÆ
  90          3¡¢°²È«Ëø¼ÌµçÆ÷µÄ¿ØÖÆ
  91          4¡¢¹ÊÕÏ¼ÌµçÆ÷µÄ¿ØÖÆ
  92          5¡¢¹ıÔØµÄ±ê¶¨
  93          6¡¢Ö÷µçÂ·µÄ¿ØÖÆ
  94          7¡¢ÉÏÉıµçÂ·µÄ¿ØÖÆ
  95          8¡¢ÏÂ½µµçÂ·µÄ¿ØÖÆ
  96          9¡¢¿ª»úµÄ¿ØÖÆ
  97          Î´Íê³ÉµÄµ÷ÊÔ
  98          1¡¢´íÏàµÄ¼ì²âºÍ¿ØÖÆ
  99          2¡¢È±ÏàµÄ¼ì²âºÍ¿ØÖÆ
 100          Íê³ÉÈÕÆÚ£º2010-1-11
 101          */
 102          //¿âÎÄ¼ş
 103          //#include <reg51.h>
 104          #include <intrins.h>
 105          #include <ABSACC.h>
 106          #include <STC15W4K32S4.h>
 107          
 108          //#include <STDIO.H>
 109          //°üÀ¨µÄº¯Êı
 110          
 111          //³£Êı
 112          #define OverLoadLimite  (128*4+6*10)    //¹ıÔØÔØÖØÖµ 0.2mV<==>25kg<==>6
 113          #define OverLoadLimite1 (OverLoadLimite-1)      
 114          
 115          #define Crystal         18432000
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 3   

 116          #define BaudRate        19200
 117          #define InitTime        200//(us)×î´ó256*12/18432000=42.6ms
 118          
 119          #define Alarm           0x40
 120          #define Error           0x20
 121          
 122          #define CheckCycle      31//´óÔ¼25ms 800us*31=24.8ms
 123          /*
 124          #define MaxPower        ((440-40)/2.5)//µçÑ¹ÉÏÏŞ£¬440V
 125          //#define MaxPower      (30/3.3)//µçÑ¹ÉÏÏŞ£¬ÀíÂÛÉÏÓ¦¸Ã=µçÑ¹/3£¬¿ÉÊµ²âÊÇµçÑ¹/3.3
 126          #define MinPower        ((360-40)/2.5)//µçÑ¹ÏÂÏŞ  360V
 127          #define LosePower       ((110-40)/2.5)//µçÑ¹ÏÂÏŞ  110V
 128          */
 129          #define MaxPower        (440/3.1)//µçÑ¹ÉÏÏŞ£¬Êµ²â420V
 130          //#define MinPower      (360/3.1)//µçÑ¹ÏÂÏŞ  Êµ²â360V
 131          #define MinPower        (330/3.1)//2015-04-08
 132          //#define MinPower      (430/3.1)//2015-08-12//test
 133          #define LosePower       (110/3.1)//µçÑ¹ÏÂÏŞ  110V
 134          
 135          /*Êµ²â½á¹û
 136          380V    80h
 137          
 138          388V    87h
 139          
 140          400V    7Eh     
 141          360V    6Dh
 142          
 143          
 144          20121212
 145          µÚÒ»´Î²âÁ¿£¬ÆäÖĞµÚÒ»¸ö»¥¸ĞÆ÷Õı×°£¬µÚ¶ş¸ö·´×°£¬µÚÈı¸öÊÇ¼ÆËãµÃ³ö
 146          50hz
 147          120     26 25 25
 148          300     68 66 5c
 149          320     6f 6d 63
 150          340     77 75 6a
 151          360     7f 7c 70
 152          380     87 84 78
 153          400     8f 8c 7f
 154          420     97 94 86
 155          440     9f 9c 8e
 156          460     a8 a4 95
 157          
 158                  60hz            50hz
 159          460     a7 a3 92        a9 a5 96
 160          400     8f 8c 7d        90 8c 80
 161          340     78 75 69        77 75 6a
 162          
 163          µÚÒ»´Î²âÁ¿£¬ÆäÖĞµÚÒ»¸ö»¥¸ĞÆ÷Õı×°£¬µÚ¶ş¸öÕı×°£¬µÚÈı¸öÊÇ¼ÆËãµÃ³ö
 164                  60hz            50hz
 165          460     a7 a3 92        a9 a5 96
 166          400     8f 8c 7d        90 8c 80
 167          340     78 75 69        77 75 6a
 168          
 169          
 170          µÃµ½¹ØÏµÊ½£¬Êı¾İ=(µçÑ¹-40)/2.5
 171          
 172          ÒÔÉÏÃ¿¸öÊı¾İ´ó¸ÅÔÚ+1»ò-1ÉÏ¸¡¶¯
 173          */
 174          
 175          
 176          //IOÎ»¶¨Òå
 177          //Ë«Ïò
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 4   

 178           
 179          //A/D£¬Õâ¼¸¸ö¶¨ÒåÖ»ÊÇÎªÁËËµÃ÷ioÎ»ÖÃ£¬Êµ¼Ê³ÌĞòÖĞ²¢²»³öÏÖ
 180          sbit    Load    =P1^2;  //³ÆÖØ´«¸ĞÆ÷£¬Òı½Å
 181          sbit    AD0             =P1^3;  //AÏà
 182          sbit    AD1             =P1^4;  //BÏà
 183          sbit    AD2             =P1^5;  //CÏà
 184          sbit    AD25    =P1^6;  //»¥¸ĞÆ÷»ù×¼µçÑ¹
 185          
 186          //Êä³ö
 187          sbit    DrvRun  =P3^2;  //¹ÊÕÏ¿ØÖÆ(È±Ïà£¬´íÏà£¬¹ıÔØ)
 188          sbit    DrvSl3  =P3^3;  //°²È«Ëø¿ØÖÆ
 189          sbit    Ss0     =P0^6;  //±¸ÓÃ£¬µçÂ·°åÀ©Õ¹ÓÃ
 190          sbit    Ss1     =P0^5;  //±¸ÓÃ£¬µçÂ·°åÀ©Õ¹ÓÃ
 191          
 192          sbit    L_Run   =P5^0;  //µÆ
 193          /*595ºÍ165£¬²»ÔÙÊ¹ÓÃ£¬ĞŞ¸ÄÍê³ÌĞòÉ¾³ı
 194          sbit    Pl      =P2^4;
 195          sbit    DatOut  =P2^5;
 196          sbit    Lsetb   =P2^6;
 197          sbit    Lclk    =P2^7;
 198          sbit    Nc2     =P3^2;  //¿Õ
 199          sbit    Nc3     =P3^3;  //¿Õ
 200          sbit    Nc4     =P3^4;  //¿Õ
 201          sbit    Clk     =P3^5;
 202          sbit    Ldat    =P3^7;
 203          
 204          //ÌØÊâ¹¦ÄÜ¼Ä´æÆ÷
 205          sfr     P0M0            =0x93;
 206          sfr     P0M1            =0x94;
 207          sfr     P1M0            =0x91;
 208          sfr     P1M1            =0x92;
 209          sfr     P2M0            =0x95;
 210          sfr     P2M1            =0x96;
 211          sfr     P3M0            =0xb1;
 212          sfr     P3M1            =0xb2;
 213          
 214          sfr     ISP_DATA        =0xe2;//ISP/IAP²Ù×÷Êı¾İ¼Ä´æÆ÷
 215          sfr     ISP_ADDRH       =0xe3;//ISP/IAP²Ù×÷µØÖ·¼Ä´æÆ÷¸ß°ËÎ»
 216          sfr     ISP_ADDRL       =0xe4;//ISP/IAP²Ù×÷µØÖ·¼Ä´æÆ÷µÍ°ËÎ»
 217          sfr     ISP_CMD         =0xe5;//ISP/IAP²Ù×÷ÃüÁî¼Ä´æÆ÷£¬ĞèÃüÁî´¥·¢¼Ä´æÆ÷´¥·¢·½¿ÉÉúĞ§
 218                                          //=0£º´ı»ú£¬ÎŞ²Ù×÷=1=2=3
 219                                          //=1£º¶Á
 220                                          //=2£ºĞ´
 221                                          //=3£º²Á³ı
 222          sfr     ISP_TRIG        =0xe6;//ISP/IAP²Ù×÷ÃüÁî´¥·¢¼Ä´æÆ÷
 223                                          //ÔÚISPEN(ISP_CONTR.7)=1Ê±£¬ÏÈĞ´Èë0x46£¬ÔÙĞ´Èë0xb9£¬ISP/IAPÃüÁî²Å»áÉúĞ§
 224          sfr     ISP_CONTR       =0xe7;////ISP/IAP¿ØÖÆ¼Ä´æÆ÷
 225          
 226          sfr     IPH             =0xb7;
 227          
 228          sfr     AUXR            =0x8e;
 229          
 230          
 231          sfr     WDT_CONTR               =0xe1;//¿´ÃÅ¹·
 232          
 233          */
 234          
 235          //¶¨ÒåÈ«¾Ö±äÁ¿
 236          unsigned char   DelayStart;//¿ª»úµçÑ¹¼ì²âÑÓÊ±
 237          unsigned char   Sec5;//Ò»¸ö5ÃëµÄÑ­»·¼ÆÊıÆ÷2015-08-12
 238          
 239          unsigned char xdata     State[20]={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};    //²É¼¯µãµÄ×´Ì¬¼Ä´æÆ÷
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 5   

 240          unsigned char Tcount;   //²É¼¯¼ÆÊıÆ÷
 241          
 242          unsigned char   ErrorState;     //´«ËÍµÄÃüÁî×Ö½Ú,×Ö½Ú¶¨Òå¼ûStateErrorCheck()
 243          unsigned char   CountIndex;     //¶¨Ê±Æ÷¼ÆÊı,±£Ö¤20ms·¢ËÍÒ»´ÎÖ¸Áî
 244          unsigned char   SecCount;       //¶¨Ê±Æ÷£¬ÓÃÓÚ1ÃëµÄ¼ÆÊ±,25ms¼õÒ»
 245          
 246          unsigned int xdata      OverLoad=0;
 247          unsigned long xdata     OverLoad1=0;
 248          unsigned int xdata      OverLoadCount=0;
 249          
 250          unsigned int xdata      Clock_1s=0;
 251          
 252          //Î»
 253          bit DrvUpSta;   //?
 254          bit FlagPowerL;         //ÓÃÒÔ¼ì²âµçÑ¹¹ÊÕÏ Ç·Ñ¹
 255          bit FlagPowerH;         //ÓÃÒÔ¼ì²âµçÑ¹¹ÊÕÏ ¹ıÑ¹
 256          bit FlagOverLoad;       //ÓÃÒÔ¼ì²â¹ıÔØ¹ÊÕÏ
 257          bit FlagErrorPhase;     //ÓÃÒÔ¼ì²â´íÏà¹ÊÕÏ
 258          bit FlagLosePhase;      //ÓÃÒÔ¼ì²âÈ±Ïà¹ÊÕÏ
 259          bit FlagStart;          //ÓÃÒÔ±êÊ¾¿ª»ú=0ÏÔÊ¾Ê±¼ä£¬=1ÏÔÊ¾×´Ì¬
 260          
 261          bit FlagRun;    //×´Ì¬±êÊ¾ =1ÔËĞĞ×´Ì¬ =0¿ÕÏĞ×´Ì¬ ÓÃÒÔ±£ÕÏÔËĞĞÖĞ²»¶Ô¹ıÔØ²âÁ¿£¬±ÜÃâÒâÍâÍ£»ú
 262          bit FlagReadCurrent;//=1¶ÁµçÁ÷²Ù×÷
 263          
 264          #define LoadZero        (128*4)//0µçÁ÷Öµ
 265          //#define LoadMin       (16*4)//¼ì²âµçÁ÷·§Öµ Ïàµ±ÓÚ20mA*16*4=1.2A
 266          //#define PhaseLoseMax  0x60    //È±ÏàºâÁ¿ÓĞµçÁ÷»ù×¼£¬Ïàµ±ÓÚ20mA*0x60/2=0.9A
 267          //#define PhaseLoseMin  0x40    //È±ÏàºâÁ¿ÎŞµçÁ÷»ù×¼£¬Ïàµ±ÓÚ20mA*0x40/2=0.6A
 268          
 269          #define LoadMin         64//¼ì²âµçÁ÷·§Öµ Ïàµ±ÓÚ20mA*16*4=1.2A
 270          #define PhaseLoseMax    200     //È±ÏàºâÁ¿ÓĞµçÁ÷»ù×¼£¬Ïàµ±ÓÚ20mA*200/2=2A
 271          #define PhaseLoseMin    180     //È±ÏàºâÁ¿ÎŞµçÁ÷»ù×¼£¬Ïàµ±ÓÚ20mA*180/2=1.8A
 272          
 273          /*
 274                  Ô­Ê¼Êı¾İ£º      ta12-200 5A==>2.5mA
 275                  ×î´óÁ¿³Ì£º      2.5mA*470/5V*1024=240
 276                  ·Ö±æÂÊ£º        5A/240=20mA
 277          */
 278          unsigned int xdata      DelaySecCount=0;//ÑÓÊ±¼ÆÊıÆ÷
 279          //µçÁ÷¼ì²â
 280          
 281          unsigned int xdata      LoadDot[4]={0,0,0,0};//ÈÎÒ»Ê±¿Ì²âÁ¿µ½µÄµçÁ÷
 282          //unsigned int  CurrentMax[3];//µçÁ÷²¨·å
 283          //unsigned int  CurrentMin[3];//µçÁ÷²¨¹È
 284          
 285          //0~2ÊÇABCÈıÏàÏà¼äµçÑ¹£¬3ÊÇAÏßµçÑ¹
 286          unsigned int xdata      LoadCurrent[4]={0,0,0,0};//µçÑ¹¾ùÖµ=SumLoadCurrent[3]/SumCount
 287          unsigned long xdata     SumLoadCurrent[4]={0,0,0,0};
 288          
 289          unsigned int    SumCount;
 290          unsigned char   PhaseLose;//È±Ïà´íÎó¼ÆÊıÆ÷£¬ÖÁÉÙ10¸öÖÜÆÚ²ÅÅĞ¶Ï
 291          
 292          bit             Polarity0;//aÏàÏßµ±Ç°¼«ĞÔ
 293          bit             Polarity1;//bÏàÏßµ±Ç°¼«ĞÔ
 294          bit             Polarity2;//cÏàÏßµ±Ç°¼«ĞÔ
 295          unsigned char   PhaseTimer[3];//ÏàĞò¼ÆÊ±
 296          unsigned char   PhaseError;//ÏàĞò´íÎó¼ÆÊıÆ÷£¬ÖÁÉÙ10¸öÖÜÆÚ²ÅÅĞ¶Ï
 297          unsigned char   LoadIndex;//Éè±¸¹¤×÷µçÁ÷²âÁ¿Ë÷Òı
 298          
 299          
 300          /*2014/3/19
 301          ¼Ù¶¨Éı½µ»úÔËĞĞ10·ÖÖÓ¼ÓÖØ50¹«½ï
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 6   

 302          10·ÖÖÓ=600Ãë=600000ºÁÃë
 303          GaoDuÃ¿25ºÁÃë¼ÆÊıÒ»´Î,¼ÆÊıÖµ=600000ºÁÃë/25ºÁÃë=24000
 304          ¶ø25¹«½ï,ÊıÄ£×ª»»ÖµÊÇ6(Õâ¸öÖµÊÇ·ñ×¼È·Î´Öª,ÏÈ¼Ù¶¨×¼È·)
 305          50¹«½ï¾ÍÊÇ12,24000/12=2000,Õâ¾ÍÊÇGaoDuKµÄÖµ
 306          */
 307          unsigned int    GaoDu;//2014/3/19
 308          #define GaoDuK  2000//2014/3/19
 309          
 310          //2017-5-25 start
 311          unsigned char   OldErrorState;  //
 312          bit                     FlagOverTimer;  //ÉÏµçÊ±¼ÇÂ¼³¬Ê±×´Ì¬
 313          bit                             OverTimer;//³¬Ê±ºóÓĞÉÏÉı²Ù×÷±¨´í
 314          unsigned int    OneMin;
 315          unsigned int    OldWorkTime;//Éè±¸¹¤×÷Ê±¼ä
 316          unsigned int    WorkTime;//Éè±¸¹¤×÷Ê±¼ä
 317          unsigned int    Pc_WorkTime;//¹¤×÷Ê±¼äµØÖ·Æ«ÒÆÁ¿ 
 318          //#define F_WorkTime    0x2800//stc12c5410ad
 319          #define F_WorkTime      0x0000//stc15w4k32s4£¬ÔÚstc15ÏµÁĞ£¬eeprom²»ÔÚÆ«ÒÆ£¨Ó²¼şÆ«ÒÆ£¬stc15w4k32s4Æ«ÒÆÎª0x8000£¬
             -Èç¹ûÊ¹ÓÃmovcÖ¸Áî£¬ĞèÒª¿¼ÂÇÆ«ÒÆÁ¿£©
 320          //#define Max_WorkTime (x*60+y)//xĞ¡Ê±ÓÖy·ÖÖÓ
 321          #define Max_WorkTime (300*60+0)//×î´óÊ±³¤300*2=600Ğ¡Ê±
 322          //#define Max_WorkTime (1*60+0)//Éè¶¨1Ğ¡Ê±
 323          unsigned char   WorkTimeStart;//±¾´Î¿ª»úÊ±¼ä
 324          //2017-5-25 end
 325          
 326          unsigned char RL1,RL2;//µçÎ»Æ÷µ÷ÕûÏÔÊ¾¶¯»­2017-8-22
 327          
 328          //ds1302³ÌĞò
 329          //¼Ä´æÆ÷ºê¶¨Òå 
 330          #define WRITE_SECOND            0x80 
 331          #define WRITE_MINUTE            0x82 
 332          #define WRITE_HOUR              0x84 
 333          #define READ_SECOND             0x81 
 334          #define READ_MINUTE             0x83 
 335          #define READ_HOUR               0x85 
 336          #define WRITE_PROTECT           0x8E
 337          #define READ_PROTECT            0x8F
 338          #define WRITE_POWER             0x90 
 339          #define READ_POWER              0x91 
 340          #define WRITE_YEAR              0x8C
 341          #define WRITE_MONTH             0x88 
 342          #define WRITE_DATE              0x86 
 343          #define READ_YEAR               0x8D 
 344          #define READ_MONTH              0x89 
 345          #define READ_DATE               0x87
 346          
 347          unsigned char xdata DATE[7];    //0Äê1ÔÂ2ÈÕ3Ê±4·Ö5Ãë 
 348          
 349          sbit SCLK       = P2^1; //DS1302Ê±ÖÓĞÅºÅ
 350          sbit DIO        = P2^2; // DS1302Êı¾İĞÅºÅ
 351          sbit CE         = P2^3; // DS1302Æ¬Ñ¡ 
 352          
 353          sbit    DA              =P4^3;
 354          sbit    DB              =P4^2;
 355          sbit    DF              =P4^1;
 356          sbit    DC              =P7^3;
 357          sbit    DD              =P7^2;
 358          sbit    DE              =P7^1;
 359          sbit    DG              =P7^0;
 360          
 361          sbit    L0              =P3^5;
 362          sbit    L1              =P3^6;
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 7   

 363          sbit    L2              =P3^7;
 364          
 365          unsigned char   ShowTimer;
 366          code char Bcd7Seg[64]   =
 367          {
 368          //dp g  f  e  d  c  b  a
 369              0x3F,// 0>>0
 370                  0x06,// 1>>1
 371                  0x5B,// 2>>2
 372                  0x4F,// 3>>3
 373                  0x66,// 4>>4
 374                  0x6D,// 5>>5
 375                  0x7D,// 6>>6
 376                  0x07,// 7>>7
 377                  0x7F,// 8>>8
 378                  0x6F,// 9>>9
 379                  0x77,// 10>>A
 380                  0x7C,// 11>>b
 381                  0x39,// 12>>C
 382                  0x5E,// 13>>d
 383                  0x79,// 14>>E
 384                  0x71,// 15>>F
 385                  0x76,// 16>>H
 386                  0x74,// 17>>h
 387                  0x38,// 18>>L
 388                  0x54,// 19>>n
 389                  0x63,// 20>>oÉÏ
 390                  0x5C,// 21>>oÏÂ
 391                  0x73,// 22>>p
 392                  0x67,// 23>>q
 393                  0x50,// 24>>r
 394                  0x3E,// 25>>U
 395                  0x40,// 26>>-
 396                  0x23,// 27>>ÉÏÉı
 397                  0x1C,// 28>>ÏÂ½µ
 398                  0x00,// 29>>¿Õ¸ñ
 399                  0x00,// 30>>¿Õ¸ñ
 400                  0x46,// 31>>-1
 401          
 402          //a  b  c  d  e  f  g  dp
 403              0xFC,// 0>>0
 404                  0x60,// 1>>1
 405                  0xDA,// 2>>2
 406                  0xF2,// 3>>3
 407                  0x66,// 4>>4
 408                  0xB6,// 5>>5
 409                  0xBE,// 6>>6
 410                  0xE0,// 7>>7
 411                  0xFE,// 8>>8
 412                  0xF6,// 9>>9
 413                  0xEE,// 10>>A
 414                  0x3E,// 11>>b
 415                  0x9C,// 12>>C
 416                  0x7A,// 13>>d
 417                  0x9E,// 14>>E
 418                  0x8E,// 15>>F
 419                  0x6E,// 16>>H
 420                  0x2E,// 17>>h
 421                  0x1C,// 18>>L
 422                  0x2A,// 19>>n
 423                  0xC6,// 20>>oÉÏ
 424                  0x3A,// 21>>oÏÂ
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 8   

 425                  0xCE,// 22>>p
 426                  0xE6,// 23>>q
 427                  0x0A,// 24>>r
 428                  0x7C,// 25>>U
 429                  0x02,// 26>>-
 430                  0xC4,// 27>>ÉÏÉı
 431                  0x38,// 28>>ÏÂ½µ
 432          
 433                  0x00,// 29>>¿Õ¸ñ
 434                  0x00,// 30>>¿Õ¸ñ
 435                  0x00,// 31>>¿Õ¸ñ
 436          };
 437          void Delay_us(unsigned int index)
 438          {
 439   1              while(index--)
 440   1              {
 441   2                      _nop_();_nop_();_nop_();_nop_();_nop_();_nop_();
 442   2                      _nop_();_nop_();_nop_();_nop_();_nop_();_nop_();
 443   2                      _nop_();_nop_();_nop_();_nop_();_nop_();_nop_();
 444   2              }
 445   1      }
 446          
 447          #define S2RI    0x01
 448          #define S2TI    0x02
 449          
 450          void Verify();
 451          void test();
 452          
 453          //µØÖ·¡¢Êı¾İ·¢ËÍ×Ó³ÌĞò 
 454          void Write1302 ( unsigned char addr,dat )     
 455          { 
 456   1             unsigned char i,temp; 
 457   1             
 458   1                 CE=0;                         //CEÒı½ÅÎªµÍ£¬Êı¾İ´«ËÍÖĞÖ¹ 
 459   1             SCLK=0;                    //ÇåÁãÊ±ÖÓ×ÜÏß 
 460   1                 Delay_us(4);
 461   1             CE = 1;                       //CEÒı½ÅÎª¸ß£¬Âß¼­¿ØÖÆÓĞĞ§ 
 462   1                 Delay_us(4);
 463   1             //·¢ËÍµØÖ· 
 464   1             for ( i=8; i>0; i-- ) //Ñ­»·8´ÎÒÆÎ» 
 465   1             {     
 466   2                    SCLK = 0; 
 467   2                    temp = addr; 
 468   2                    DIO = (bit)(temp&0x01);          //Ã¿´Î´«ÊäµÍ×Ö½Ú 
 469   2                                Delay_us(1);
 470   2                    addr >>= 1;                //ÓÒÒÆÒ»Î» 
 471   2                    SCLK = 1; 
 472   2             } 
 473   1      //·¢ËÍÊı¾İ 
 474   1             for ( i=8; i>0; i-- ) 
 475   1             {     
 476   2                    SCLK = 0; 
 477   2                    temp = dat; 
 478   2                    DIO = (bit)(temp&0x01);          
 479   2                                Delay_us(1);
 480   2                    dat >>= 1;                   
 481   2                    SCLK = 1; 
 482   2             } 
 483   1             CE = 0;         
 484   1      } 
 485          
 486          
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 9   

 487          //Êı¾İ¶ÁÈ¡×Ó³ÌĞò 
 488          unsigned char Read1302 ( unsigned char Index) 
 489          { 
 490   1             unsigned char i,temp,temp1,addr;
 491   1      
 492   1              do
 493   1              {
 494   2                      temp1=temp;
 495   2                      addr=Index;
 496   2                 
 497   2             CE=0;           
 498   2             SCLK=0;
 499   2                 Delay_us(4);
 500   2             CE = 1;  
 501   2                 Delay_us(4);
 502   2             //·¢ËÍµØÖ· 
 503   2             for ( i=8; i>0; i-- )                      //Ñ­»·8´ÎÒÆÎ» 
 504   2             {     
 505   3                    SCLK = 0; 
 506   3                                DIO = (bit)(addr&0x01);          //Ã¿´Î´«ÊäµÍ×Ö½Ú
 507   3                                Delay_us(1);
 508   3                    addr >>= 1;                              //ÓÒÒÆÒ»Î»
 509   3                    SCLK = 1; 
 510   3             } 
 511   2      
 512   2      //¶ÁÈ¡Êı¾İ
 513   2      
 514   2      //      DIO =1;
 515   2      
 516   2             for ( i=8; i>0; i-- ) 
 517   2             { 
 518   3                    SCLK = 1; 
 519   3                                temp>>=1;
 520   3                    SCLK = 0;
 521   3                                Delay_us(1);
 522   3                                if(DIO)temp|=0x80;
 523   3             }     
 524   2             CE=0;
 525   2      
 526   2              }while(temp!=temp1);
 527   1       
 528   1              return (temp); 
 529   1      }
 530          
 531          
 532          
 533          //³õÊ¼»¯DS1302 
 534          void Initial(void)    
 535          { 
 536   1             Write1302 (WRITE_PROTECT,0X00);          //½ûÖ¹Ğ´±£»¤ 
 537   1      
 538   1             Write1302 (WRITE_YEAR,DATE[0]);                  //ÃëÎ»³õÊ¼»¯ 
 539   1             Write1302 (WRITE_MONTH,DATE[1]);         //·ÖÖÓ³õÊ¼»¯ 
 540   1             Write1302 (WRITE_DATE,DATE[2]);                  //ÃëÎ»³õÊ¼»¯ 
 541   1             Write1302 (WRITE_HOUR,DATE[3]);                  //Ğ¡Ê±³õÊ¼»¯
 542   1             Write1302 (WRITE_MINUTE,DATE[4]);                //·ÖÖÓ³õÊ¼»¯ 
 543   1             Write1302 (WRITE_SECOND,0x00);                   //ÃëÎ»³õÊ¼»¯ 
 544   1      
 545   1             Write1302 (WRITE_POWER,0xAA);            //2¸ö¶ş¼«¹Ü£¬4Ç§Å·
 546   1             Write1302 (WRITE_PROTECT,0x80);          //ÔÊĞíĞ´±£»¤ 
 547   1      } 
 548          
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 10  

 549          
 550          
 551          //²âÊÔ
 552          unsigned int t_int1;
 553          unsigned char t_char;
 554          
 555          #define CMD_IDLE        0       //¿ÕÏĞÄ£Ê½
 556          #define CMD_READ        1       //IAP¶Á
 557          #define CMD_PROGRAM     2       //IAPĞ´
 558          #define CMD_ERASE       3       //IAP²Á³ı
 559          
 560          #define ENABLE_IAP      0X81    //SYSCLK<24M
 561          
 562          void IapIdle()
 563          {
 564   1              IAP_CONTR=0;
 565   1              IAP_CMD=0;
 566   1              IAP_TRIG=0;
 567   1              IAP_ADDRH=0x80;
 568   1              IAP_ADDRL=0;
 569   1      }
 570          void WriteFlash(unsigned int IspAddr,unsigned char IspData)
 571          {
 572   1              IAP_CONTR=ENABLE_IAP;
 573   1              IAP_CMD=CMD_PROGRAM;
 574   1              IAP_ADDRL=IspAddr%0x100;
 575   1              IAP_ADDRH=IspAddr/0x100;
 576   1              IAP_DATA=0xff-IspData;
 577   1              IAP_TRIG=0x5A;
 578   1              IAP_TRIG=0xA5;
 579   1              _nop_();
 580   1              IapIdle();
 581   1      }
 582          unsigned char ReadFlash(unsigned int IspAddr)
 583          {
 584   1      unsigned char i;
 585   1              IAP_CONTR=ENABLE_IAP;
 586   1              IAP_CMD=CMD_READ;
 587   1              IAP_ADDRL=IspAddr%0x100;
 588   1              IAP_ADDRH=IspAddr/0x100;
 589   1              IAP_TRIG=0x5A;
 590   1              IAP_TRIG=0xA5;
 591   1              _nop_();
 592   1              i=0xff-IAP_DATA;
 593   1              IapIdle();
 594   1      
 595   1              return i;
 596   1      }
 597          void EraseFlash(unsigned int IspAddr)
 598          {
 599   1              IAP_CONTR=ENABLE_IAP;
 600   1              IAP_CMD=CMD_ERASE;
 601   1              IAP_ADDRL=IspAddr%0x100;
 602   1              IAP_ADDRH=IspAddr/0x100;
 603   1              IAP_TRIG=0x5A;
 604   1              IAP_TRIG=0xA5;
 605   1              _nop_();
 606   1              IapIdle();
 607   1      }
 608          
 609          unsigned int crc_cal_value(unsigned char data_value,unsigned int crc_value)
 610          {
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 11  

 611   1      unsigned char i;
 612   1      union{
 613   1              unsigned char Addr[2];
 614   1          unsigned int crc_value;
 615   1              }temp;
 616   1      
 617   1              temp.crc_value=crc_value;
 618   1              temp.crc_value^=data_value;
 619   1      
 620   1              for(i=0;i<8;i++)
 621   1              {
 622   2                      if(temp.crc_value&0x0001)
 623   2                      {
 624   3                              temp.crc_value=temp.crc_value>>1;
 625   3                              temp.Addr[0]^=0xa0;
 626   3                              temp.Addr[1]^=0x01;
 627   3                      }
 628   2                      else temp.crc_value=temp.crc_value>>1;
 629   2              }
 630   1              return(temp.crc_value);
 631   1      }
 632          
 633          unsigned char xdata LedStr[3];
 634          bit Flag_CheckID;
 635          bit Flag_Timer0;//ÓÃÓÚ¿ª»úÊ±¼ÆËãÊ±¼ä£¬Ã¿´Î¶¨Ê±ÖĞ¶ÏÖÃ1
 636          unsigned char code ID2 _at_ 0x0020;
 637          unsigned char code ID1 _at_ 0x0021;
 638          unsigned char code ID0 _at_ 0x0022;
 639          
 640          unsigned char code EndYear _at_ 0x8000;//Èç¹ûÓÃiap¶ÁĞ´£¬µØÖ·Îª0x0000
 641          unsigned char code EndMon _at_ 0x8001;
 642          unsigned char code EndDay _at_ 0x8002;
 643          
 644          unsigned char code EndYear1 _at_ 0x8200;//Èç¹ûÓÃiap¶ÁĞ´£¬µØÖ·Îª0x0000
 645          unsigned char code EndMon1 _at_ 0x8201;
 646          unsigned char code EndDay1 _at_ 0x8202;
 647          
 648          unsigned char code EndYear2 _at_ 0x8400;//Èç¹ûÓÃiap¶ÁĞ´£¬µØÖ·Îª0x0000
 649          unsigned char code EndMon2 _at_ 0x8401;
 650          unsigned char code EndDay2 _at_ 0x8402;
 651          
 652          #define TB_NowTime              0xe9
 653          #define TB_EndTime              0xed
 654          
 655          unsigned char Sint_value=0;
 656          unsigned char Sint_value1=0;
 657          unsigned char Sint_count=0;
 658          
 659          void RstPower()
 660          {
 661   1      unsigned char t;
 662   1              if(RI)//ÔÚ³ÌĞòÔËĞĞ¹ı³ÌÖĞÒ²¿ÉÒÔÊÚÈ¨Ğ£ÕıÊ±¼ä
 663   1              {
 664   2                      RI=0;t=SBUF;
 665   2                      if(t==TB_NowTime)//Ğ£Ê±Í¬²½
 666   2                      {
 667   3                              if(Sint_value==TB_NowTime)Sint_count++;
 668   3                              else Sint_count=0;
 669   3                      }
 670   2      
 671   2                      if(t==TB_EndTime)//ÊÚÈ¨Í¬²½
 672   2                      {
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 12  

 673   3                              if(Sint_value==TB_EndTime)Sint_count++;
 674   3                              else Sint_count=0;
 675   3                      }
 676   2      
 677   2                      if(Sint_value1==0xEB)
 678   2                      {
 679   3                              if(Sint_value<=0x20)
 680   3                              {
 681   4                                      TI=0;SBUF=ReadFlash(Sint_value*256+t);while(!TI){};
 682   4                              }else if(Sint_value<0x80){}
 683   3                              else if(Sint_value<=0x90)
 684   3                              {
 685   4                                      Sint_value=Sint_value|0x01;//Èç¹ûÊı¾İÊÇĞ´£¬Ç¿ÖÆ¸ÄÎª¶Á
 686   4                                      TI=0;SBUF=Read1302 (Sint_value);while(!TI){};
 687   4                              }
 688   3                      }
 689   2      
 690   2                      Sint_value1=Sint_value;
 691   2                      Sint_value=t;
 692   2                      
 693   2                      if(Sint_count>10)IAP_CONTR=0x20;//ÖØĞÂÆô¶¯
 694   2              }
 695   1      }
 696          
 697          
 698          void CheckID()
 699          {
 700   1      unsigned int i,j;
 701   1      unsigned char t,t0;
 702   1      unsigned int crc_value;
 703   1      unsigned char BZ;//=0:¼ì²âID£¬=1:°üº¬±¾°åID
 704   1      
 705   1      union{
 706   1              unsigned char Addr[4];
 707   1          unsigned long value;
 708   1              }EndDate;
 709   1      
 710   1      union{                             
 711   1              unsigned char Addr[4];
 712   1          unsigned long value;
 713   1              }MeID;
 714   1      
 715   1      union{
 716   1              unsigned char Addr[4];
 717   1          unsigned long value;
 718   1              }AcceptDat;
 719   1      
 720   1              MeID.Addr[0]=0;MeID.Addr[1]=ID2;MeID.Addr[2]=ID1;MeID.Addr[3]=ID0;
 721   1              AcceptDat.Addr[0]=0;
 722   1              BZ=0;
 723   1      
 724   1      
 725   1              Flag_CheckID=1;EA=1;
 726   1      //¼ì²éÊÇ·ñ¿ªÆôĞÂµÄÊÚÈ¨
 727   1      //¼ì²éÊ±ÖÓÊÇ·ñÕı³££¬¼ì²éÊ±ÖÓÊÇ·ñÍ£°Ú£¬Èç¹ûÍ£°Ú±¨E01£¬Í¬Ê±ÏÔÊ¾A01£¬²¢½ûÖ¹ÔËĞĞ
 728   1      //¼ì²éÊ±ÖÓÊÇ·ñÕı³££¬¼ì²éÊ±ÖÓ³äµçÉèÖÃ£¬Èç¹û´íÎó±¨E01£¬Í¬Ê±ÏÔÊ¾A03£¬²¢½ûÖ¹ÔËĞĞ
 729   1      //¼ì²éÊÇ·ñÊÚÈ¨¹ıÆÚ£¬Èç¹û¹ıÆÚ±¨E01£¬Í¬Ê±ÏÔÊ¾A01£¬²¢½ûÖ¹ÔËĞĞ
 730   1      //Ê±¼äĞ£Õı
 731   1      
 732   1              RI=0;Flag_Timer0=0;i=0;
 733   1      
 734   1              //µÈ´ıÊÚÈ¨Ö¸Áî£¬²»ÂÛÓĞ»¹ÊÇÃ»ÓĞ£¬È·ÈÏÃ»ÓĞºó¼ì²éÊÚÈ¨×´Ì¬
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 13  

 735   1              while((i<200))//500*200us=100ms,14msÓĞ10%µÄ»ú»áÍê³ÉÍ¨ĞÅ£¬16msÓĞ80%»ú»áÍê³ÉÍ¨ĞÅ£¬18msÓë16ms²î²»¶à£¬20ms»ù±
             -¾100%£¬×îºóÈ¡40ms
 736   1              {
 737   2                      if(Flag_Timer0){i++;Flag_Timer0=0;}
 738   2                      if(RI)
 739   2                      {
 740   3                              RI=0;t=SBUF;
 741   3                              if(t==TB_EndTime)
 742   3                              {
 743   4                                      while(t==TB_EndTime)//½ÓÊÜÍ¬²½Âë£¬Í¬Ê±µÈ´ıÊ×Î»ĞÅÏ¢
 744   4                                      {
 745   5                                              TI=0;SBUF=0xaa;
 746   5                                              while(!RI){};
 747   5                                              RI=0;t0=SBUF;t=t0;
 748   5                                      }
 749   4      
 750   4                                      //¿ªÊ¼½ÓÊÕÊı¾İ,ÏÈ×öCRC³ÌĞò
 751   4                                      crc_value=0xffff;
 752   4                                      crc_value=crc_cal_value(t,crc_value);//Ëæ»úÂë
 753   4      
 754   4                                      for(i=0;i<3;i++)//½ÓÊÕÊÚÈ¨ÈÕÆÚ
 755   4                                      {
 756   5                                              //while(!RI){};RI=0;t=(t>>1)^SBUF;AcceptDat.Addr[2]=t;crc_value=crc_cal_value(t,crc_value);
 757   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[3]=t;crc_value=crc_cal_value(t,crc_value);
 758   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[2]=t;crc_value=crc_cal_value(t,crc_value);
 759   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 760   5                                      }EndDate.value=AcceptDat.value;
 761   4                                      
 762   4                                      for(i=0;i<1000;i++)//½ÓÊÕID
 763   4                                      {
 764   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 765   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[2]=t;crc_value=crc_cal_value(t,crc_value);
 766   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[3]=t;crc_value=crc_cal_value(t,crc_value);
 767   5                                              if(AcceptDat.value==MeID.value)BZ=1;
 768   5                                      }
 769   4      
 770   4                                      //½ÓÊÕcrc
 771   4                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 772   4                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 773   4      
 774   4                                      if(crc_value==0)
 775   4                                      {
 776   5                                              if(BZ==1)
 777   5                                              {
 778   6                                                      t=0x55;
 779   6                                              //ĞŞÕıÊÚÈ¨Ê±¼ä
 780   6                                                      for(i=0;i<3;i++)
 781   6                                                      {
 782   7                                                              BZ=0;
 783   7                                                              while(!BZ)
 784   7                                                              {
 785   8                                                                      EraseFlash(i*512);WriteFlash(i*512+0,EndDate.Addr[1]);WriteFlash(i*512+1,EndDate.Addr[2]);WriteFla
             -sh(i*512+2,EndDate.Addr[3]);
 786   8                                                                      BZ=(ReadFlash(i*512+0)==EndDate.Addr[1])&(ReadFlash(i*512+1)==EndDate.Addr[2])&(ReadFlash(i*512+2)
             -==EndDate.Addr[3]);
 787   8                                                              }
 788   7                                                      }
 789   6                                                      
 790   6                                              }
 791   5                                              else t=0xe1;
 792   5                                      }else t=0xee;
 793   4      
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 14  

 794   4                                      for(i=0;i<5;i++){TI=0;SBUF=t;while(!TI){}}
 795   4      
 796   4                              }else if(t==TB_NowTime)
 797   3                              {
 798   4                                      while(t==TB_NowTime)//½ÓÊÜÍ¬²½Âë£¬Í¬Ê±µÈ´ıÊ×Î»ĞÅÏ¢
 799   4                                      {
 800   5                                              TI=0;SBUF=0xa5;
 801   5                                              while(!RI){};
 802   5                                              RI=0;t0=SBUF;t=t0;
 803   5                                      }
 804   4      
 805   4                                      //¿ªÊ¼½ÓÊÕÊı¾İ,ÏÈ×öCRC³ÌĞò
 806   4                                      crc_value=0xffff;
 807   4                                      crc_value=crc_cal_value(t,crc_value);//Ëæ»úÂë
 808   4      
 809   4                                      //½ÓÊÕÃë·ÖÊ±
 810   4                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[3]=t;crc_value=crc_cal_value(t,crc_value);
 811   4                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[2]=t;crc_value=crc_cal_value(t,crc_value);
 812   4                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 813   4                                              EndDate.value=AcceptDat.value;//½èÓÃ¼Ä´æÆ÷
 814   4                                      
 815   4                                      //½ÓÊÕÈÕÔÂÄê
 816   4                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[3]=t;crc_value=crc_cal_value(t,crc_value);
 817   4                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[2]=t;crc_value=crc_cal_value(t,crc_value);
 818   4                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 819   4      
 820   4                                      //½ÓÊÕcrc
 821   4                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;crc_value=crc_cal_value(t,crc_value);
 822   4                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;crc_value=crc_cal_value(t,crc_value);
 823   4      
 824   4                                      if(crc_value==0)
 825   4                                      {
 826   5                                      //ĞŞÕıÊ±ÖÓ
 827   5                                      BZ=0;
 828   5                                      while(!BZ)
 829   5                                              {
 830   6                                              Write1302 (WRITE_PROTECT,0X00);         //½ûÖ¹Ğ´±£»¤ 
 831   6              
 832   6                                              Write1302 (WRITE_SECOND,EndDate.Addr[3]);               //ÃëÎ»³õÊ¼»¯ 
 833   6                                              Write1302 (WRITE_MINUTE,EndDate.Addr[2]);               //·ÖÖÓ³õÊ¼»¯ 
 834   6                                              Write1302 (WRITE_HOUR,EndDate.Addr[1]);                 //Ğ¡Ê±³õÊ¼»¯
 835   6      
 836   6                                              EndDate.value=AcceptDat.value;//½èÓÃ¼Ä´æÆ÷
 837   6                                                      Write1302 (WRITE_DATE,EndDate.Addr[3]);                 //ÈÕÎ»³õÊ¼»¯ 
 838   6                                              Write1302 (WRITE_MONTH,EndDate.Addr[2]);                //ÔÂÖÓ³õÊ¼»¯ 
 839   6                                              Write1302 (WRITE_YEAR,EndDate.Addr[1]);                 //ÄêÊ±³õÊ¼»¯
 840   6      
 841   6                                              Write1302 (WRITE_POWER,0xAA);                                   //2¸ö¶ş¼«¹Ü£¬4Ç§Å·
 842   6                                              Write1302 (WRITE_PROTECT,0x80);                                 //ÔÊĞíĞ´±£»¤ 
 843   6      
 844   6                                                      BZ=(Read1302(READ_DATE)==EndDate.Addr[3])&(Read1302(READ_MONTH)==EndDate.Addr[2])&(Read1302(READ_YEA
             -R)==EndDate.Addr[1]);
 845   6                                                      //BZ=1;
 846   6                                              }
 847   5      
 848   5                                              EraseFlash(8*512);WriteFlash(8*512,0);//Ã¿´ÎĞ£Ê±ºó£¬Ê±ÖÓ×Ô¶¯ĞŞ¸´ÏŞ´Î¹é0
 849   5      
 850   5                                              t=0x55;
 851   5                                      }else t=0xee;
 852   4      
 853   4                                      for(i=0;i<5;i++){TI=0;SBUF=t;while(!TI){}}
 854   4                              }
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 15  

 855   3                      }
 856   2              }
 857   1      
 858   1      
 859   1      //¼ì²éÊ±ÖÓÊÇ·ñÕı³££¬¼ì²éÊ±ÖÓÊÇ·ñÍ£°Ú£¬Èç¹ûÍ£°Ú±¨E01£¬Í¬Ê±ÏÔÊ¾A01£¬²¢½ûÖ¹ÔËĞĞ
 860   1              
 861   1              do{t=Read1302 (READ_PROTECT);}while(t&0x7f);//È·±£1302ÓĞ0Êı¾İÊä³ö£¬0x80»ò0x00
 862   1              
 863   1              t=Read1302 (READ_SECOND);
 864   1              if(t&0x80)
 865   1              {
 866   2                      t0=0;
 867   2                      //³¢ÊÔĞŞ¸´
 868   2                      BZ=0;
 869   2                      i=4;j=5;
 870   2                      if((ReadFlash(i*512+0)==ReadFlash(j*512+0))&(ReadFlash(i*512+1)==ReadFlash(j*512+1))&(ReadFlash(i*512+2)
             -==ReadFlash(j*512+2))&(ReadFlash(i*512+3)==ReadFlash(j*512+3))&(ReadFlash(i*512+4)==ReadFlash(j*512+4))&(ReadFlash(i*512
             -+5)==ReadFlash(j*512+5))&!BZ)
 871   2                      {DATE[0]=ReadFlash(i*512+0);DATE[1]=ReadFlash(i*512+1);DATE[2]=ReadFlash(i*512+2);DATE[3]=ReadFlash(i*51
             -2+3);DATE[4]=ReadFlash(i*512+4);DATE[5]=ReadFlash(i*512+5);BZ=1;}
 872   2                      i=4;j=6;
 873   2                      if((ReadFlash(i*512+0)==ReadFlash(j*512+0))&(ReadFlash(i*512+1)==ReadFlash(j*512+1))&(ReadFlash(i*512+2)
             -==ReadFlash(j*512+2))&(ReadFlash(i*512+3)==ReadFlash(j*512+3))&(ReadFlash(i*512+4)==ReadFlash(j*512+4))&(ReadFlash(i*512
             -+5)==ReadFlash(j*512+5))&!BZ)
 874   2                      {DATE[0]=ReadFlash(i*512+0);DATE[1]=ReadFlash(i*512+1);DATE[2]=ReadFlash(i*512+2);DATE[3]=ReadFlash(i*51
             -2+3);DATE[4]=ReadFlash(i*512+4);DATE[5]=ReadFlash(i*512+5);BZ=1;}
 875   2                      i=5;j=6;
 876   2                      if((ReadFlash(i*512+0)==ReadFlash(j*512+0))&(ReadFlash(i*512+1)==ReadFlash(j*512+1))&(ReadFlash(i*512+2)
             -==ReadFlash(j*512+2))&(ReadFlash(i*512+3)==ReadFlash(j*512+3))&(ReadFlash(i*512+4)==ReadFlash(j*512+4))&(ReadFlash(i*512
             -+5)==ReadFlash(j*512+5))&!BZ)
 877   2                      {DATE[0]=ReadFlash(i*512+0);DATE[1]=ReadFlash(i*512+1);DATE[2]=ReadFlash(i*512+2);DATE[3]=ReadFlash(i*51
             -2+3);DATE[4]=ReadFlash(i*512+4);DATE[5]=ReadFlash(i*512+5);BZ=1;}
 878   2      
 879   2                      i=DATE[0];j=i%16;i=i/16;i=i*10+j;if(i>99)BZ=0;
 880   2                      i=DATE[1];j=i%16;i=i/16;i=i*10+j;if((i==0)|(i>12))BZ=0;
 881   2                      i=DATE[2];j=i%16;i=i/16;i=i*10+j;if((i==0)|(i>31))BZ=0;
 882   2      
 883   2                      i=ReadFlash(8*512+0);
 884   2                      if(i>10)BZ=0;//ĞŞ¸´Ê±ÖÓÏŞÖÆÎª10´Î
 885   2                      else {EraseFlash(8*512);WriteFlash(8*512,i+1);}
 886   2      
 887   2                      if(BZ)Initial();
 888   2                      else
 889   2                      {
 890   3                              while(1)
 891   3                                      {
 892   4                                              //ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;while(!(S2CON&S2TI)){}
 893   4                                              DrvRun=1;//½ûÖ¹ÔËĞĞ
 894   4                                              RstPower();
 895   4      
 896   4                                              //²úÉúÒ»¸ö50000*200us=10ÃëµÄÖÜÆÚ
 897   4                                              while(!Flag_Timer0){}
 898   4                                              i++;Flag_Timer0=0;
 899   4                                              if(i>50000)i=0;
 900   4      
 901   4                                              //20msÏòB°å·¢×´Ì¬                       
 902   4                                              t=i%100;
 903   4                                              if(t==1){ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;}
 904   4      
 905   4                                              //ÏÔÊ¾µØÖ·ºÍ¹ÊÕÏ´úÂë
 906   4                                              t=i/10000;ShowTimer=7;
 907   4                                              if(t==2){t0=ID2;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 16  

 908   4                                              if(t==3){t0=ID1;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 909   4                                              if(t==4){t0=ID0;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 910   4                                              if(t<2){LedStr[0]=10;LedStr[1]=0;LedStr[2]=1;}//=7ÏÔÊ¾bcd7¶Î±àÂë£¬=8Ö±½ÓÏÔÊ¾Êı¾İ
 911   4                                      }
 912   3                      }
 913   2              }
 914   1      
 915   1      //¼ì²éÊ±ÖÓÊÇ·ñÕı³££¬¼ì²éÊ±ÖÓ³äµçÉèÖÃ£¬Èç¹û´íÎó±¨E01£¬Í¬Ê±ÏÔÊ¾A03£¬²¢½ûÖ¹ÔËĞĞ
 916   1              t=Read1302 (READ_POWER);
 917   1              if(t!=0xAA)
 918   1              {
 919   2                      t0=0;
 920   2                      while(1)
 921   2                              {
 922   3                                      //ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;while(!(S2CON&S2TI)){}
 923   3                                      DrvRun=1;//½ûÖ¹ÔËĞĞ
 924   3                                      RstPower();
 925   3      
 926   3                                      //²úÉúÒ»¸ö50000*200us=10ÃëµÄÖÜÆÚ
 927   3                                      while(!Flag_Timer0){}
 928   3                                      i++;Flag_Timer0=0;
 929   3                                      if(i>50000)i=0;
 930   3      
 931   3                                      //20msÏòB°å·¢×´Ì¬
 932   3                                      t=i%100;
 933   3                                      if(t==1){ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;}
 934   3      
 935   3                                      //ÏÔÊ¾µØÖ·ºÍ¹ÊÕÏ´úÂë
 936   3                                      t=i/10000;ShowTimer=7;
 937   3                                      if(t==2){t0=ID2;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 938   3                                      if(t==3){t0=ID1;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 939   3                                      if(t==4){t0=ID0;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 940   3                                      if(t<2){LedStr[0]=10;LedStr[1]=0;LedStr[2]=3;}//=7ÏÔÊ¾bcd7¶Î±àÂë£¬=8Ö±½ÓÏÔÊ¾Êı¾İ
 941   3                              }
 942   2              }
 943   1      
 944   1      //¼ì²éÊÇ·ñÊÚÈ¨¹ıÆÚ£¬Èç¹û¹ıÆÚ±¨E01£¬Í¬Ê±ÏÔÊ¾A02£¬²¢½ûÖ¹ÔËĞĞ
 945   1              EndDate.Addr[0]=0;EndDate.Addr[1]=~EndYear;EndDate.Addr[2]=~EndMon;EndDate.Addr[3]=~EndDay;
 946   1              MeID.Addr[0]=0;MeID.Addr[1]=~EndYear1;MeID.Addr[2]=~EndMon1;MeID.Addr[3]=~EndDay1;
 947   1              if(EndDate.value!=MeID.value)
 948   1              {
 949   2                      EndDate=MeID;MeID.Addr[0]=0;MeID.Addr[1]=~EndYear2;MeID.Addr[2]=~EndMon2;MeID.Addr[3]=~EndDay2;
 950   2      
 951   2                      if(EndDate.value!=MeID.value)
 952   2                      {
 953   3                              EndDate=MeID;MeID.Addr[0]=0;MeID.Addr[1]=~EndYear;MeID.Addr[2]=~EndMon;MeID.Addr[3]=~EndDay;
 954   3      
 955   3                              if(EndDate.value!=MeID.value)EndDate.value=0;
 956   3      
 957   3                      }
 958   2      
 959   2              }
 960   1      
 961   1              AcceptDat.Addr[0]=0;AcceptDat.Addr[1]=Read1302(READ_YEAR);AcceptDat.Addr[2]=Read1302(READ_MONTH);AcceptDa
             -t.Addr[3]=Read1302(READ_DATE);
 962   1              if(AcceptDat.value>EndDate.value)
 963   1              {
 964   2                      while(1)
 965   2                              {
 966   3                                      //ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;while(!(S2CON&S2TI)){}
 967   3                                      DrvRun=1;//½ûÖ¹ÔËĞĞ
 968   3                                      RstPower();
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 17  

 969   3      
 970   3                                      //²úÉúÒ»¸ö50000*200us=10ÃëµÄÖÜÆÚ
 971   3                                      while(!Flag_Timer0){}
 972   3                                      i++;Flag_Timer0=0;
 973   3                                      if(i>50000)i=0;
 974   3      
 975   3                                      //20msÏòB°å·¢×´Ì¬
 976   3                                      t=i%100;
 977   3                                      if(t==1){ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;}
 978   3      
 979   3                                      //ÏÔÊ¾µØÖ·ºÍ¹ÊÕÏ´úÂë
 980   3                                      t=i/10000;ShowTimer=7;
 981   3                                      if(t==2){t0=ID2;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 982   3                                      if(t==3){t0=ID1;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 983   3                                      if(t==4){t0=ID0;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 984   3                                      if(t<2){LedStr[0]=10;LedStr[1]=0;LedStr[2]=2;}//=7ÏÔÊ¾bcd7¶Î±àÂë£¬=8Ö±½ÓÏÔÊ¾Êı¾İ
 985   3                              }
 986   2              }
 987   1      
 988   1      //´æ´¢Ê±ÖÓµÄÄêÔÂÈÕÊ±·ÖÃë£¬ÒÔ±¸Êı¾İ¶ªÊ§¿ÉÒÔ×ÔĞĞ»Ø¸´Ê¹ÓÃ
 989   1              DATE[0]=Read1302(READ_YEAR);DATE[1]=Read1302(READ_MONTH);DATE[2]=Read1302(READ_DATE);DATE[3]=Read1302(REA
             -D_HOUR);DATE[4]=Read1302(READ_MINUTE);DATE[5]=Read1302(READ_SECOND);
 990   1      
 991   1              for(i=4;i<6;i++)
 992   1              {
 993   2                      BZ=0;
 994   2                      while(!BZ)
 995   2                      {
 996   3                              EraseFlash(i*512);WriteFlash(i*512+0,DATE[0]);WriteFlash(i*512+1,DATE[1]);WriteFlash(i*512+2,DATE[2]);W
             -riteFlash(i*512+3,DATE[3]);WriteFlash(i*512+4,DATE[4]);WriteFlash(i*512+5,DATE[5]);
 997   3                              BZ=(ReadFlash(i*512+0)==DATE[0])&(ReadFlash(i*512+1)==DATE[1])&(ReadFlash(i*512+2)==DATE[2])&(ReadFlash
             -(i*512+3)==DATE[3])&(ReadFlash(i*512+4)==DATE[4])&(ReadFlash(i*512+5)==DATE[5]);
 998   3                      }
 999   2              }
1000   1      
1001   1              Flag_CheckID=0;
1002   1      }
1003          
1004          unsigned char Line;
1005          
1006          void LedWr(unsigned char Index)
1007          {
1008   1              DA=Index&0x01;
1009   1              DB=Index&0x02;
1010   1              DC=Index&0x04;
1011   1              DD=Index&0x08;
1012   1              DE=Index&0x10;
1013   1              DF=Index&0x20;
1014   1              DG=Index&0x40;
1015   1      }
1016          void Led888(unsigned char Index0,unsigned char Index1,unsigned char Index2)//LED¿ØÖÆ
1017          {
1018   1              L0=0;L1=0;L2=0;
1019   1              if(Line==0)
1020   1              {
1021   2                      LedWr(Index2);
1022   2                      L0=1;
1023   2              }else if(Line==1)
1024   1              {
1025   2                      LedWr(Index1);
1026   2                      L1=1;
1027   2              }else if(Line==2)
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 18  

1028   1              {
1029   2                      LedWr(Index0);
1030   2                      L2=1;
1031   2              }
1032   1              Line=(Line+1)%3;
1033   1      }
1034          
1035          
1036          void ShowID()//ShowTimer=0,1ÏÔÊ¾4ÃëID2£»=2ÏÔÊ¾2ÃëID1£»=3ÏÔÊ¾2ÃëID0£»
1037          {
1038   1      unsigned int i;
1039   1      unsigned char t0,t1,t2;
1040   1              switch(ShowTimer)
1041   1              {
1042   2                      case 2:i=ID1;t2=1;break;
1043   2                      case 3:i=ID0;t2=2;break;
1044   2                      default:i=ID2;t2=0;
1045   2              }
1046   1      
1047   1              t0=i%16;i=i/16;
1048   1              t1=i;
1049   1      
1050   1              Led888(Bcd7Seg[t2],Bcd7Seg[t1],Bcd7Seg[t0]);
1051   1      }
1052          
1053          void ShowLoad()//ÏÔÊ¾¹ıÔØÊµ²âÊı¾İÓë»ù×¼Êı¾İµÄ²îÖµ£¬¾ø¶ÔÖµ3Î»Êı²»ÏÔÊ¾·ûºÅ
1054          {
1055   1      unsigned int i;
1056   1      unsigned char t0,t1,t2;
1057   1      
1058   1              RL1--;
1059   1              if(!RL1)
1060   1              {
1061   2                      RL1=100;//100*1.6ms=160ms
1062   2                      if(OverLoad<=OverLoadLimite1)
1063   2                      {
1064   3                              RL2=(RL2*2)%64;
1065   3                              if(RL2==0)RL2=1;
1066   3                              t2=RL2;
1067   3                      }else
1068   2                      {
1069   3                              RL2=RL2/2;
1070   3                              if(RL2==0)RL2=32;
1071   3                              t2=RL2;
1072   3                      }
1073   2              }
1074   1      
1075   1              if(OverLoad<=OverLoadLimite1)
1076   1              {
1077   2                      i=(OverLoadLimite1-OverLoad);
1078   2                      if(i>199)
1079   2                      {
1080   3                              t0=i%10;i=i/10;
1081   3                              t1=i%10;i=i/10;
1082   3                      }else
1083   2                      {
1084   3                              t0=i%10;i=i/10;
1085   3                              t1=i%10;i=i/10;
1086   3                              t2=Bcd7Seg[i%10];
1087   3                      }
1088   2              }
1089   1              else
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 19  

1090   1          {
1091   2                      i=(OverLoad-OverLoadLimite1);
1092   2                      if(i>199)
1093   2                      {
1094   3                              t0=i%10;i=i/10;
1095   3                              t1=i%10;i=i/10;
1096   3                      }else if(i>99)
1097   2                      {
1098   3                              t0=i%10;i=i/10;
1099   3                              t1=i%10;i=i/10;
1100   3                              t2=0x46;//-1
1101   3                      }else
1102   2                      {
1103   3                              t0=i%10;i=i/10;
1104   3                              t1=i%10;i=i/10;
1105   3                              t2=0x40;//¸ººÅ-
1106   3                      }               
1107   2              }
1108   1      
1109   1              Led888(t2,Bcd7Seg[t1],Bcd7Seg[t0]);
1110   1      }
1111          
1112          void ShowErrorState()
1113          {
1114   1      unsigned int i;
1115   1      unsigned char t0,t1,t2;
1116   1      
1117   1              i=ErrorState%32;
1118   1              t0=i%10;i=i/10;
1119   1              t1=i%10;
1120   1              i=ErrorState/32;
1121   1              t2=i%4;
1122   1      
1123   1              Led888(Bcd7Seg[t2],Bcd7Seg[t1],Bcd7Seg[t0]);
1124   1      }
1125          
1126          void ShowSec()
1127          {
1128   1      unsigned char t0,t1,t2;
1129   1          //t2=Read1302 (READ_SECOND);
1130   1              t0=t2%16;
1131   1              t1=t2/16;
1132   1              Led888(t2,Bcd7Seg[t1],Bcd7Seg[t0]);
1133   1      }
1134          
1135          void ShowBcd()
1136          {
1137   1              Led888(Bcd7Seg[LedStr[0]],Bcd7Seg[LedStr[1]],Bcd7Seg[LedStr[2]]);
1138   1      }
1139          
1140          void ShowStr()
1141          {
1142   1              Led888(LedStr[0],LedStr[1],LedStr[2]);
1143   1      }
1144          
1145          
1146          void LedShow()
1147          {
1148   1      //ShowTimer==0,1,2,3;¿ª»úÏÔÊ¾ID,ÏÔÊ¾¹ı³Ì£¬3-,D1,D2,D3
1149   1      //ShowTimer==4;È»ºóÏÔÊ¾¹ıÔØÊı¾İ£¬Îª¹ıÔØ±ê¶¨Ìá¹©·½±ã
1150   1      //ShowTimer==5;ÔËĞĞºóÏÔÊ¾ÔËĞĞ×´Ì¬
1151   1      
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 20  

1152   1              switch(ShowTimer)
1153   1              {
1154   2                      case 0:
1155   2                      case 1:
1156   2                      case 2:
1157   2                      case 3:ShowID();break;
1158   2                      case 4:ShowLoad();break;
1159   2                      case 5:ShowErrorState();break;
1160   2                      case 6:ShowSec();break;
1161   2                      case 7:ShowBcd();break;
1162   2                      default:ShowStr();
1163   2              }
1164   1      }
1165          
1166          //A/D×ª»»×¼±¸
1167          void AdReady(unsigned char INDEX)
1168          {
1169   1              if(INDEX==0)ADC_CONTR=0xe3;//AÏà²âÁ¿
1170   1              else if(INDEX==1)ADC_CONTR=0xe4;//BÏà²âÁ¿
1171   1              else if(INDEX==2)ADC_CONTR=0xe5;//CÏà²âÁ¿
1172   1              else if(INDEX==3)ADC_CONTR=0xe2;//¹ıÔØ²âÁ¿
1173   1              //else if(INDEX==3)ADC_CONTR=0xe0;//2.5V
1174   1      }
1175          
1176          void AdStart()
1177          {
1178   1              ADC_RES=0;
1179   1              ADC_RESL=0;
1180   1              ADC_CONTR=ADC_CONTR|0x08;
1181   1      }
1182          
1183          unsigned int GetAdResult()
1184          {
1185   1              while(!(ADC_CONTR&0x10)){};
1186   1              ADC_CONTR=ADC_CONTR&0xe7;
1187   1      
1188   1              return ADC_RES*4+ADC_RESL%4;
1189   1      }
1190          
1191          sbit To1        =P5^2;
1192          sbit To2        =P0^4;
1193          sbit To3        =P0^3;
1194          sbit To4        =P2^4;
1195          sbit To5        =P2^5;
1196          sbit To6        =P2^6;
1197          sbit To7        =P2^7;
1198          sbit To8        =P7^4;
1199          sbit To9        =P7^5;
1200          sbit To10       =P7^6;
1201          sbit To11       =P7^7;
1202          sbit To12       =P4^5;
1203          sbit To13       =P4^6;
1204          sbit To14       =P0^0;
1205          sbit To15       =P0^1;
1206          sbit To16       =P0^2;
1207          
1208          void StateCheck(void)//×´Ì¬¼ì²â
1209          {
1210   1      //Êı¾İ¶ÁÈ¡
1211   1      //Èç¹ûÓĞ24V£¬DatOut=0,State[]!=0
1212   1      //¶ÁÈ¡Ë³ĞòÓĞµçÂ·°å¾ö¶¨
1213   1              
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 21  

1214   1              if(!To1){if(State[1]<200)State[1]++;}else{if(State[1]>0)State[1]--;}
1215   1              if(!To2){if(State[2]<200)State[2]++;}else{if(State[2]>0)State[2]--;}
1216   1              if(!To3){if(State[3]<200)State[3]++;}else{if(State[3]>0)State[3]--;}
1217   1              if(!To4){if(State[4]<200)State[4]++;}else{if(State[4]>0)State[4]--;}
1218   1              if(!To5){if(State[5]<200)State[5]++;}else{if(State[5]>0)State[5]--;}
1219   1              if(!To6){if(State[6]<200)State[6]++;}else{if(State[6]>0)State[6]--;}
1220   1              if(!To7){if(State[7]<200)State[7]++;}else{if(State[7]>0)State[7]--;}
1221   1              if(!To8){if(State[8]<200)State[8]++;}else{if(State[8]>0)State[8]--;}
1222   1              if(!To9){if(State[9]<200)State[9]++;}else{if(State[9]>0)State[9]--;}
1223   1              if(!To10){if(State[10]<200)State[10]++;}else{if(State[10]>0)State[10]--;}
1224   1              if(!To11){if(State[11]<200)State[11]++;}else{if(State[11]>0)State[11]--;}
1225   1              if(!To12){if(State[12]<200)State[12]++;}else{if(State[12]>0)State[12]--;}
1226   1              if(!To13){if(State[13]<200)State[13]++;}else{if(State[13]>0)State[13]--;}
1227   1              if(!To14){if(State[14]<200)State[14]++;}else{if(State[14]>0)State[14]--;}
1228   1              if(!To15){if(State[15]<200)State[15]++;}else{if(State[15]>0)State[15]--;}
1229   1              if(!To16){if(State[16]<200)State[16]++;}else{if(State[16]>0)State[16]--;}
1230   1      }
1231          
1232          bit PhaseErrorCheck()
1233          {
1234   1      /*
1235   1      AÏà:00,01,02,03,04,05,06,07,  08,09,10,11,12,13,14,15,  16,17,18,19,20,21,22,23,
1236   1      BÏà:16,17,18,19,20,21,22,23,  00,01,02,03,04,05,06,07,  08,09,10,11,12,13,14,15,
1237   1      CÏà:08,09,10,11,12,13,14,15,  16,17,18,19,20,21,22,23,  00,01,02,03,04,05,06,07,
1238   1      */
1239   1      unsigned char a[3];
1240   1              a[0]=PhaseTimer[0];
1241   1              a[2]=PhaseTimer[1];
1242   1              a[1]=PhaseTimer[2];
1243   1      
1244   1              //´íÏà7
1245   1              if(!FlagErrorPhase)//²»´íÏà
1246   1              {
1247   2                      if((a[0]<40)&(a[1]<40)&(a[2]<40))//3Ïà¶¼ÓĞµçÁ÷Í¨¹ı;200us*4*40=32ms
1248   2                      {
1249   3                              if(a[0]<a[1])//AÏà:00,01,02,03,04,05,06,07
1250   3                              {
1251   4                                      if((a[2]>a[0])&(a[2]<a[1]))
1252   4                                      {
1253   5                                              if(PhaseError!=0)PhaseError--;
1254   5                                      }else
1255   4                                      {
1256   5                                              /*´íÏà*/if(PhaseError<200)PhaseError++;
1257   5                                      }
1258   4                              }else
1259   3                              {
1260   4                                      if((a[2]>a[0])|(a[2]<a[1]))//AÏà:08,09,10,11,12,13,14,15,  16,17,18,19,20,21,22,23,
1261   4                                      {
1262   5                                              if(PhaseError!=0)PhaseError--;
1263   5                                      }else
1264   4                                      {
1265   5                                              /*´íÏà*/if(PhaseError<200)PhaseError++;
1266   5                                      }                               
1267   4                              }
1268   3                      }
1269   2              }
1270   1      
1271   1              if(PhaseError>100)//´íÏà
1272   1              {
1273   2                      PhaseError=150;
1274   2                      ErrorState=Alarm+Error+7;//ERROR
1275   2                      FlagErrorPhase=1;
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 22  

1276   2              }
1277   1              
1278   1              return FlagErrorPhase;
1279   1      }
1280          
1281          bit PowerCheck()   //zjb
1282          {
1283   1      //µçÑ¹±¨¾¯²ÉÓÃÍÆÍìÉè¼Æ
1284   1      
1285   1              //if(SecCount>(255-20*1))//25ms*20=500ms
1286   1              if(SecCount>(255-100))//25ms*100=2.5s£¬
1287   1              {//Æô¶¯2.5s²»¼ì²â£¬µÈ´ıµçÂ·ÎÈ¶¨   20130924
1288   2              }else if((LoadCurrent[0]<LosePower)&(LoadCurrent[1]<LosePower)&(LoadCurrent[2]<LosePower)&(LoadCurrent[3]
             -<LosePower))
1289   1              {//Î´¼ì²âµ½ÓĞĞ§µçÑ¹£¬²»¼ì²â£¬ÒÔ±ãÓÚµçÂ·°å¼ì²â2017-5-25
1290   2              }else
1291   1              {
1292   2                      if(FlagPowerL)//Ç·Ñ¹Ê±
1293   2                      {
1294   3                              if((LoadCurrent[0]>MinPower)&(LoadCurrent[1]>MinPower)&(LoadCurrent[2]>MinPower))FlagPowerL=0;//²»Ç·Ñ¹
1295   3                              else {FlagPowerL=1;ErrorState=Alarm+Error+21;}
1296   3                      }else //Õı³£Ê±
1297   2                      {
1298   3                              if((LoadCurrent[0]<MinPower)|(LoadCurrent[1]<MinPower)|(LoadCurrent[2]<MinPower)){FlagPowerL=1;ErrorSta
             -te=Alarm+Error+21;}
1299   3                              else FlagPowerL=0;//²»Ç·Ñ¹
1300   3                      }
1301   2              
1302   2                      if(FlagPowerH)//³¬Ñ¹Ê±
1303   2                      {
1304   3                              if((LoadCurrent[0]<MaxPower)&(LoadCurrent[1]<MaxPower)&(LoadCurrent[2]<MaxPower))FlagPowerH=0;//²»³¬Ñ¹
1305   3                              else {FlagPowerH=1;ErrorState=Alarm+Error+20;}
1306   3                      }else //Õı³£Ê±
1307   2                      {
1308   3                              if((LoadCurrent[0]>MaxPower)|(LoadCurrent[1]>MaxPower)|(LoadCurrent[2]>MaxPower)){FlagPowerH=1;ErrorSta
             -te=Alarm+Error+20;}
1309   3                              else FlagPowerH=0;//²»³¬Ñ¹
1310   3                      }
1311   2              }
1312   1      
1313   1              if(Sec5>1){FlagPowerH=0;FlagPowerL=0;}//2015-08-12
1314   1      
1315   1              
1316   1              /*È±Ïà*/
1317   1              //if((((LoadCurrent[0]>MinPower)|(LoadCurrent[1]>MinPower)|(LoadCurrent[2]>MinPower))
1318   1              //&((LoadCurrent[0]<LosePower)|(LoadCurrent[1]<LosePower)|(LoadCurrent[2]<LosePower)))//¼ì²âµ½ÓĞĞ§µçÑ¹
1319   1              //|(LoadCurrent[3]<MinPower))//L1~NµçÑ¹¹ıµÍ
1320   1              if(
1321   1                  ((LoadCurrent[0]>MinPower)|(LoadCurrent[1]>MinPower)|(LoadCurrent[2]>MinPower))//¼ì²âµ½ÓĞĞ§µçÑ¹
1322   1                 &((LoadCurrent[0]<LosePower)|(LoadCurrent[1]<LosePower)|(LoadCurrent[2]<LosePower)|(LoadCurrent[3]<Los
             -ePower))//L1~NµçÑ¹¹ıµÍ
1323   1                )
1324   1      
1325   1              {FlagLosePhase=1;ErrorState=Alarm+Error+8;}
1326   1              else FlagLosePhase=0;
1327   1              /*´íÏà*/
1328   1              PhaseErrorCheck();
1329   1              
1330   1              //FlagPower=0;//test ÆÁ±ÎÒÔÉÏÅĞ¶Ï
1331   1              return FlagPowerH|FlagPowerL|FlagLosePhase|FlagErrorPhase;
1332   1      }
1333          
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 23  

1334          
1335          bit OverLoadCheck()
1336          {
1337   1              //¹ıÔØ10
1338   1              if(OverLoadCount>500)//200us*4*500=400ms
1339   1              {
1340   2                      OverLoad=OverLoad1/OverLoadCount;
1341   2                      OverLoad1=OverLoad;
1342   2                      OverLoadCount=1;
1343   2              }
1344   1              /*
1345   1              if(OverLoad<OverLoadLimite1)FlagOverLoad=0;//²»¹ıÔØ
1346   1              else if((OverLoad>(OverLoadLimite))|FlagOverLoad)
1347   1              {       
1348   1                      ErrorState=Alarm+Error+10;//ERROR
1349   1                      FlagOverLoad=1;
1350   1              }//·ñÔò ×´Ì¬²»±ä
1351   1              */
1352   1              //²»ÔÙ²ÅÓÃÍÆÍì·½Ê½£¬Ìá¸ßÁéÃô¶È 20130503
1353   1              
1354   1              //if(OverLoad<OverLoadLimite1)FlagOverLoad=0;//²»¹ıÔØ
1355   1              if((OverLoad-(GaoDu/GaoDuK))<OverLoadLimite1)FlagOverLoad=0;//2014/3/19
1356   1              else
1357   1              {       ErrorState=Alarm+Error+10;//ERROR
1358   2                      FlagOverLoad=1;
1359   2              }
1360   1              if(FlagRun)FlagOverLoad=0;//µçÌİĞĞ½øÊ±£¬²»×ö¹ıÔØ¼ì²â£¬·ÀÖ¹ĞüÍ£¿ÕÖĞ
1361   1              
1362   1              return FlagOverLoad;
1363   1      }
1364          
1365          //2012-10-26
1366          bit MainSwitchCheck()
1367          {
1368   1      bit sta;
1369   1      /*
1370   1              ÏäÍâ¼±Í£
1371   1              ÏäÄÚ¼±Í£
1372   1              ÃÅ½û
1373   1              ½ô¼±ÉÏÏŞÎ»
1374   1              °²È«Ëø
1375   1              ÈÈ¼Ì
1376   1      */
1377   1      
1378   1              sta=1;FlagRun=0;
1379   1      /*
1380   1              if(State[0]==0)ErrorState=Error+1;//AC24V¹ÊÕÏ
1381   1              if(State[1]==0)ErrorState=Error+1;//Ô¿³×¿ª¹Ø
1382   1              if(State[2]==0)ErrorState=Error+3;//ÏäÍâ¼±Í£3
1383   1              else if(State[3]==0)ErrorState=Error+2; //ÏäÄÚ¼±Í£2
1384   1              else if(State[4]==0)ErrorState=Error+1; //¼ÌµçÆ÷6
1385   1              else if(State[5]==0)ErrorState=Error+17;//±¸ÓÃÃÅ17
1386   1              else if(State[6]==0)ErrorState=Error+16;//ÃÅ½û16
1387   1              else if(State[7]==0)ErrorState=Alarm+Error+4;//½ô¼±ÉÏÏŞÎ»4
1388   1              else if(State[8]==0)ErrorState=Alarm+Error+18;//°²È«Ëø18
1389   1              else if(State[9]==0)ErrorState=Alarm+Error+9;//ÈÈ¼Ì9
1390   1              else {sta=0;FlagRun=1;}
1391   1      */      
1392   1              if(State[0]<50)ErrorState=Error+1;//AC24V¹ÊÕÏ
1393   1              if(State[1]<50)ErrorState=Error+1;//Ô¿³×¿ª¹Ø
1394   1              if(State[2]<50)ErrorState=Error+3;//ÏäÍâ¼±Í£3
1395   1              else if(State[3]<50)ErrorState=Error+2; //ÏäÄÚ¼±Í£2
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 24  

1396   1              else if(State[4]<50)ErrorState=Error+1; //¼ÌµçÆ÷6
1397   1              else if(State[5]<50)ErrorState=Error+17;//±¸ÓÃÃÅ17
1398   1              else if(State[6]<50)ErrorState=Error+16;//ÃÅ½û16
1399   1              else if(State[7]<50)ErrorState=Alarm+Error+4;//½ô¼±ÉÏÏŞÎ»4
1400   1              else if(State[8]<50)ErrorState=Alarm+Error+18;//°²È«Ëø18
1401   1              else if(State[9]<50)ErrorState=Alarm+Error+9;//ÈÈ¼Ì9
1402   1              else {sta=0;FlagRun=1;}
1403   1      
1404   1      
1405   1              return sta;
1406   1      }
1407          
1408          //2012-10-26
1409          bit UpSwitchCheck()
1410          {
1411   1      bit sta;
1412   1              sta=1;
1413   1              if(State[10]>0)//ÉÏÉı
1414   1              {
1415   2                      FlagStart=1;
1416   2                      if(State[11]<50)ErrorState=Error+11;//ÉÏÏŞÎ»¶¯×÷11
1417   2                      else if(State[12]<50)ErrorState=Alarm+Error+19;//ÂÖÀªÉÏÏŞÎ»¶¯×÷19
1418   2                      else if(State[13]<50)ErrorState=Alarm+Error+1;//¼ÌµçÆ÷2´íÎó
1419   2                      //else {ErrorState=2;FlagRun=1;}//ÉÏÉı×´Ì¬
1420   2              else {ErrorState=2;FlagRun=1;if(GaoDu<60000)GaoDu++;}//2014/3/19
1421   2              }else {sta=0;FlagRun=0;}
1422   1              
1423   1              return sta;
1424   1      }
1425          
1426          //2012-10-26
1427          bit DownSwitchCheck()
1428          {
1429   1      bit sta;
1430   1              sta=1;
1431   1              if(State[14]>150)//ÏÂ½µ
1432   1              {
1433   2                      FlagStart=1;
1434   2                      //if(State[15]<50)ErrorState=Error+12;//ÏÂÏŞÎ»¶¯×÷12
1435   2                      if(State[15]<50){ErrorState=Error+12;GaoDu=0;}//2014/3/19
1436   2                      else if(State[16]<50)ErrorState=Alarm+Error+1;//¼ÌµçÆ÷1´íÎó
1437   2                      //else {ErrorState=3;FlagRun=1;}//ÏÂ½µ×´Ì¬
1438   2                      else {ErrorState=3;FlagRun=1;if(GaoDu>0)GaoDu--;}//2014/3/19
1439   2              }else {sta=0;FlagRun=0;}
1440   1              
1441   1              return sta;
1442   1      }
1443          
1444          void StateShow()
1445          {
1446   1              FlagRun=0;
1447   1              if(FlagStart)ErrorState=1;//Í£Ö¹×´Ì¬1
1448   1              else ErrorState=0;
1449   1      }
1450          
1451          //¹ÊÕÏ·ÖÎö
1452          void StateErrorCheck()
1453          {
1454   1              if(OverLoadCheck()){}//¹ıÔØÏÔÊ¾¹ÊÕÏ
1455   1              else if(PowerCheck()){}//¹ıµçÑ¹»òÇ·µçÑ¹»òÈ±Ïà»òÏàĞò´íÎó
1456   1              else if(FlagStart)//Èç¹ûÒÑ¾­¿ªÊ¼²Ù×÷¼ì²éºÍÏÔÊ¾ÆäËû¹ÊÕÏ£¬·ñÔòÏÔÊ¾ÔËĞĞÊ±¼ä
1457   1              {
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 25  

1458   2                      if(MainSwitchCheck());
1459   2                      else if(UpSwitchCheck());
1460   2                      else if(DownSwitchCheck());
1461   2                      else StateShow();
1462   2              }else
1463   1              {
1464   2                      if(UpSwitchCheck());
1465   2                      else if(DownSwitchCheck());
1466   2                      else StateShow();
1467   2              }
1468   1              
1469   1      /*
1470   1      B7£º=B6¨B5¨B4¨B3¨B2¨B1¨B0
1471   1      B6 B5=0×´Ì¬ÏÔÊ¾
1472   1      B4 B3 B2 B1 B0=
1473   1              0£ºÏÔÊ¾µç»úÔË×ªÊ±¼ä
1474   1      1£º¿ÕÏĞ×´Ì¬
1475   1      2£ºÉÏÉı×´Ì¬
1476   1      3£ºÏÂ½µ×´Ì¬
1477   1      B6 B5=1¹ÊÕÏÏÔÊ¾(²»¸æ¾¯)
1478   1              B4 B3 B2 B1 B0=
1479   1      1£ºµçÔ´24·ü¹ÊÕÏ»òÕßµçÂ·°å¹ÊÕÏ£»ok
1480   1      2£ºÏáÄÚ¼±Í£´¥·¢£»ok
1481   1      3£ºÏáÍâ¼±Í£´¥·¢£»ok
1482   1      4£º½ô¼±ÉÏÏŞÎ»´¥·¢£»ok
1483   1      5£º½ÓÊÜÃüÁîÊ§°Ü£¨ÎóÂë£©£»
1484   1      6£º½ÓÊÜÃüÁîÊ§°Ü£¨³¬Ê±£©£»ok
1485   1      7£ºÏàĞò´íÎó£»
1486   1      8£º¶ÏÏà£»
1487   1      9£º¹ıÁ÷±£»¤£»ÈÈ¼ÌµçÆ÷ ok
1488   1      10£º¹ıÔØ±£»¤£»ok
1489   1      11£ºÉÏÏŞÎ»´¥·¢£»ok
1490   1      12£ºÏÂÏŞÎ»´¥·¢£»ok
1491   1      16£ºÇ°ÃÅÎ´¹Ø±Õ ok
1492   1      17£ººóÃÅÎ´¹Ø±Õ ok
1493   1      18£º°²È«Ëø¶¯×÷ ok
1494   1      19£ºÂÖÀªÉÏÏŞÎ»´¥·¢ ok
1495   1      
1496   1      20£ºµçÑ¹¹ı¸ß
1497   1      21£ºµçÑ¹¹ıµÍ
1498   1      30~31£º²âÊÔ¶Ë¿Ú1~2£¨µ±²âÊÔ¶Ë¿ÚÉÏ³öÏÖ24VµçÑ¹Ê±£¬ÏÔÊ¾²âÊÔ¶Ë¿ÚÊı¾İ£¬Í¬Ê±¿ØÖÆ°åµÄºìµÆÉÁË¸£©
1499   1      B6 B5=3¹ÊÕÏÏÔÊ¾(¸æ¾¯)£¬¹ÊÕÏÀàĞÍÍ¬B6 B5=1
1500   1      */
1501   1      
1502   1              if(SecCount>(255-20*1))//25ms*20=500ms
1503   1              {
1504   2                      if(FlagErrorPhase)//±£Ö¤500msÃëÄÚÔÊĞí´íÏàÔËĞĞ£¬ÒÔ±ã²ğĞ¶¸ÖË¿Éş
1505   2                      {
1506   3                              DrvRun=0;
1507   3                              SecCount=255;//2012-3-24 ±¨´íºó£¬Èç¹ûÍ£Ö¹²Ù×÷
1508   3                      }
1509   2      
1510   2                      if(State[14]>150)DrvSl3=0;      //Èç¹ûÏÂ½µ£¬¶Ï¿ª°²È«Ëø¼ÌµçÆ÷2017-05-22
1511   2              }else
1512   1              {
1513   2                      //DrvRun=FlagOverLoad|FlagErrorPhase|FlagLosePhase;//¿ØÖÆÔËĞĞ¼ÌµçÆ÷
1514   2                      //DrvRun=FlagOverLoad|FlagErrorPhase|FlagLosePhase|FlagPowerH|FlagPowerL;//¿ØÖÆÔËĞĞ¼ÌµçÆ÷
1515   2                      //DrvRun=FlagOverLoad|FlagErrorPhase|FlagLosePhase;//¿ØÖÆÔËĞĞ¼ÌµçÆ÷ ¹ıÑ¹Ç·Ñ¹Ôİ²»Í£»ú£¬Ö»ÊÇ±¨¾¯
1516   2                      DrvRun=FlagOverLoad|FlagErrorPhase|FlagLosePhase|OverTimer;//2017-5-25
1517   2                      DrvSl3=0;       //¶Ï¿ª°²È«Ëø¼ÌµçÆ÷
1518   2                      //DrvSl3=1;     //test ¶Ï¿ª°²È«Ëø¼ÌµçÆ÷
1519   2              }
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 26  

1520   1              
1521   1              //²âÊÔ¶Ë¿Ú
1522   1              //if(State[17]>150)ErrorState=Alarm+Error+31;//2017-5-27
1523   1      /*²»ÔÚ²âÊÔ£¬ÕÅ½ğ²¨20121109
1524   1              if((State[16]==0)|(State[17]>0))//²âÊÔµçÂ·°å
1525   1              {
1526   1                      ErrorState=Alarm+Error+1;//µçÂ·°å¹ÊÕÏ
1527   1              }
1528   1      */
1529   1      }
1530          
1531          void Verify()
1532          {
1533   1      unsigned char check;
1534   1              check=0;
1535   1              if(ErrorState&0x01)check++;
1536   1              if(ErrorState&0x02)check++;
1537   1              if(ErrorState&0x04)check++;
1538   1              if(ErrorState&0x08)check++;
1539   1              if(ErrorState&0x10)check++;
1540   1              if(ErrorState&0x20)check++;
1541   1              if(ErrorState&0x40)check++;
1542   1              
1543   1              if(check&0x01)ErrorState=ErrorState+0x80;
1544   1      
1545   1      }
1546          
1547          //**********************************************************************2017-5-31
1548          void SxBUF_Init()
1549          {
1550   1      //´®¿Ú
1551   1              TH1=0x100-Crystal/12/16/BaudRate;TL1=0x100-Crystal/12/16/BaudRate;
1552   1      //1
1553   1      /*
1554   1              //µçÔ´¹ÜÀí,Í¬Ê±´®¿Ú²¨ÌØÂÊ¼Ó±¶
1555   1              PCON=0x80;//SMOD/SMOD0/LVDF/POF/GF1/GF0/PD/IDL;
1556   1              //¶¨Ê±Æ÷¹¤×÷Ä£Ê½
1557   1              TMOD=0x21;//GATE/CT/M1/M0/GATE/CT/M1/M0;
1558   1              //´®¿Ú1¿ØÖÆ¼Ä´æÆ÷
1559   1              SCON=0x58;//SM0/SM1/SM2/REN/TB8/RB8/TI/RI
1560   1              //ÖĞ¶ÏÓÅÏÈ¼¶¼Ä´æÆ÷µÍ(¿ÉÎ»Ñ°Ö·)
1561   1              IP=0x02;//PPCA/PLVD/PADC/PS/PT1/PX1/PT0/PX0
1562   1              //ÖĞ¶ÏÓÅÏÈ¼¶¼Ä´æÆ÷¸ß(²»¿ÉÎ»Ñ°Ö·)
1563   1              IPH=1;//PPCAH/PLVDH/PADCH/PSH/PT1H/PX1H/PT0H/PX0H
1564   1              //¶¨Ê±Æ÷¿ØÖÆ¼Ä´æÆ÷
1565   1              TCON=0x50//TF1/TR1/TF0/TR0/IE1/IT1/IE0/IT0;TFÒç³ö±êÖ¾,TRÔËĞĞ¿ØÖÆÎ»,IEÖĞ¶Ï±êÖ¾,ITÖĞ¶ÏÔ´ÀàĞÍÑ¡Ôñ=0Ë«ÑØ´¥·¢,
             -=1ÏÂ½µÑØ´¥·¢
1566   1              //TR1=1;TR0=1;
1567   1              ET0=1;
1568   1      */
1569   1              SCON=0x58;
1570   1              T2H=(65536-Crystal/4/BaudRate)/256;
1571   1              T2L=(65536-Crystal/4/BaudRate)%256;
1572   1      //2
1573   1              S2CON=0x58;//S2SM0/NC/S2SM2/S2REN/S2TB8/S2RB8/S2TI/S2RI
1574   1      //3     
1575   1              S3CON=0x98;//S3SM0/S3ST3/S3SM2/S3REN/S3TB8/S3RB8/S3TI/S3RI
1576   1      //4     
1577   1              S4CON=0x98;//S4SM0/S4ST4/S4SM2/S4REN/S4TB8/S4RB8/S4TI/S4RI
1578   1              //¸¨Öú¼Ä´æÆ÷
1579   1              AUXR=0X14;//T0*12/T1*12/UART_M0*6/T2R/T2_CT/T2*12/EXTRAM/S1ST2;S1ST2ÉèÖÃ´®¿Ú1Ê¹ÓÃ¶¨Ê±Æ÷T2
1580   1              AUXR|=0X01;
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 27  

1581   1      }
1582          
1583          //200us¶¨Ê±ÖĞ¶Ï³ÌĞò
1584          //Ê±ÖÓÊ±¼ä½Ú×à×¼È·
1585          void timer0(void) interrupt 1 /*T0ÖĞ¶Ï*/
1586          {
1587   1              TH0=(65536-Crystal/12000*InitTime/1000)/256;
1588   1              TL0=(65536-Crystal/12000*InitTime/1000)%256;
1589   1      
1590   1              WDT_CONTR=0x3e;//2.72Ãë¿´ÃÅ¹·
1591   1      
1592   1              Clock_1s++;
1593   1              if(Clock_1s>9999)
1594   1              {
1595   2                      if(ShowTimer<4)ShowTimer++;
1596   2                      Clock_1s=0;
1597   2              }
1598   1      
1599   1              if(FlagStart)ShowTimer=5;
1600   1              
1601   1              if(Flag_CheckID)//Èç¹ûÔÚ¼ì²âÊÚÈ¨Ìø¹ıËùÓĞ²Ù×÷
1602   1              {
1603   2                      LedShow();
1604   2                      Flag_Timer0=1;
1605   2                      goto timer0end;
1606   2              }
1607   1      
1608   1              AdStart();//ok
1609   1              
1610   1              StateCheck();//ok
1611   1              
1612   1              //¹ıÔØ²âÊÔÖµÈ¡¾ø¶ÔÖµ£¬´ËÊ±ÕıÔÚ²âÁ¿AÏà£¬¹ıÔØÒÑ²âÁ¿Íê±Ï
1613   1              if(LoadIndex==0)//0.8msÒ»´Î
1614   1              {
1615   2                      OverLoad1=OverLoad1+LoadDot[3];
1616   2                      OverLoadCount++;
1617   2                      
1618   2      
1619   2                      if(DelaySecCount>0)DelaySecCount--;
1620   2                      SumCount++;
1621   2                      
1622   2                      CountIndex=SumCount%CheckCycle;
1623   2                      if(CountIndex==0)//0.8ms*31=24.8ms
1624   2                      {
1625   3      
1626   3                              StateErrorCheck();
1627   3      
1628   3                              //2017-5-25
1629   3                              //start
1630   3      /*
1631   3                              if(ErrorState==2)
1632   3                              {
1633   3                                      if(WorkTimeStart<10)OneMin++;//Éı½µ»úÉÏĞĞÊ±¼ä²»µ½10·ÖÖÓ£¬¼ÌĞø¼ÆÊ±
1634   3      
1635   3                                      if(FlagOverTimer){OverTimer=1;OldErrorState=0;}//Èç¹û³¬Ê±²¢ÇÒÉÏÉı²Ù×÷,±¨µçÂ·°å´íÎó
1636   3                              }
1637   3      
1638   3                              if(OneMin>2400){OneMin=0;WorkTime++;WorkTimeStart++;}//2400*25ms=1·ÖÖÓ
1639   3                              //if(OneMin>40){OneMin=0;WorkTime++;WorkTimeStart++;}//40*25ms=1ÃëÖÓ //test
1640   3                              if((OldErrorState==2)&(ErrorState!=2))
1641   3                              {
1642   3                                      if(OldWorkTime!=WorkTime)
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 28  

1643   3                                      {
1644   3                                              EraseFlash(F_WorkTime);WriteFlash(F_WorkTime,WorkTime/256);WriteFlash(F_WorkTime+1,WorkTime%256);
1645   3                                              EraseFlash(F_WorkTime+512);WriteFlash(F_WorkTime+512,WorkTime/256);WriteFlash(F_WorkTime+513,WorkTime
             -%256);
1646   3                                              EraseFlash(F_WorkTime+1024);WriteFlash(F_WorkTime+1024,WorkTime/256);WriteFlash(F_WorkTime+1025,WorkT
             -ime%256);
1647   3                                              OldWorkTime=WorkTime;
1648   3                                      }
1649   3                              }
1650   3                              OldErrorState=ErrorState;
1651   3                              //end
1652   3      */
1653   3      
1654   3                              if(SumCount>(CheckCycle*40))//800us*31*40=992ms
1655   3                              {
1656   4                                      LoadCurrent[0]=SumLoadCurrent[0]/SumCount;SumLoadCurrent[0]=0;
1657   4                                      LoadCurrent[1]=SumLoadCurrent[1]/SumCount;SumLoadCurrent[1]=0;
1658   4                                      SumLoadCurrent[2]=SumLoadCurrent[2]/1.06;//Êµ²â50hzÊÇ1.053£¬¼ÆËã»úÄ£Äâ50hzÊÇ1.053~1.056£¬60hzÊÇ1.064~1
             -.066£¬ÕÛÖĞÈ¡1.06
1659   4                                      //LoadCurrent[2]=SumLoadCurrent[2]/SumCount;SumLoadCurrent[2]=0;
1660   4                                      LoadCurrent[2]=LoadCurrent[1];SumLoadCurrent[2]=0;//¿¼ÂÇµ½²»ÊÇÖ±½Ó²âÁ¿£¬ÎÊÌâ½Ï´ó£¬²»ÔÙÊ¹ÓÃ20130503
1661   4                                      LoadCurrent[3]=SumLoadCurrent[3]/SumCount;SumLoadCurrent[3]=0;
1662   4      
1663   4                                      SumCount=0;
1664   4                                      Sec5++;Sec5=Sec5%5;//2015-08-12
1665   4                              }
1666   3      
1667   3                              if(FlagRun)L_Run=(SumCount>(CheckCycle*20));//1ºÕ×ÈÉÁË¸
1668   3                              else L_Run=0;
1669   3                              
1670   3                              Verify();S2CON&=~S2TI;S2BUF=ErrorState;
1671   3                              //Verify();TI=0;SBUF=OverLoad;//zjbtest
1672   3      
1673   3                              if(SecCount>0)SecCount--;
1674   3                              if(SecCount==0)
1675   3                              {
1676   4                                      SecCount=100;//2.5sec
1677   4                              }
1678   3      
1679   3                      }else if(CountIndex&0x01)LedShow();//1.6msÒ»´Î
1680   2              }
1681   1              
1682   1      /*
1683   1              LoadIndex==1Ê±£¬AÏàµçÁ÷·ÖÎö£¬´ËÊ±ÕıÔÚ²âÁ¿BÏà£¬AÏàÒÑ²âÁ¿Íê±Ï
1684   1              LoadIndex==2Ê±£¬BÏàµçÁ÷·ÖÎö£¬´ËÊ±ÕıÔÚ²âÁ¿CÏà£¬BÏàÒÑ²âÁ¿Íê±Ï
1685   1              LoadIndex==3Ê±£¬CÏàµçÁ÷·ÖÎö£¬´ËÊ±ÕıÔÚ²âÁ¿¹ıÔØ£¬CÏàÒÑ²âÁ¿Íê±Ï
1686   1              
1687   1              µ±µçÁ÷LoadDot[]>(LoadZero+LoadMin)Ê±£¬±íÊ¾ÓĞÕıµçÁ÷£¬¼«ĞÔPolarity[]±êÎª1
1688   1              µ±µçÁ÷LoadDot[]>(LoadZero-LoadMin)Ê±£¬±íÊ¾ÓĞ¸ºµçÁ÷£¬¼«ĞÔPolarity[]±êÎª0
1689   1              µ±¼«ĞÔPolarity[]ÓÉ0±äÎª1Ê±£¬PhaseTimer[]¿ªÊ¼¼ÆÊ±,
1690   1              µ±¼«ĞÔPolarity[]ÓÉ0±äÎª1Ê±£¬LoadCurrent[]¼ÆËã²¢ÀÛ¼Æ,
1691   1      
1692   1      */
1693   1              //ABÏàµçÑ¹
1694   1              if(LoadIndex==1)
1695   1              {
1696   2                      LoadDot[0]=1024-LoadDot[0];//²âÁ¿µÄÊÇBAµçÑ¹£¬×ªAB
1697   2                      if(LoadDot[0]>LoadZero)
1698   2                      {
1699   3                              SumLoadCurrent[0]=SumLoadCurrent[0]+LoadDot[0]-LoadZero;//2012-11-28
1700   3                              //t=LoadDot[0]-LoadZero;t=t*t;SumLoadCurrent[0]=SumLoadCurrent[0]+t;
1701   3                      }else
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 29  

1702   2                      {
1703   3                              SumLoadCurrent[0]=SumLoadCurrent[0]+LoadZero-LoadDot[0];//2012-11-28
1704   3                              //t=LoadZero-LoadDot[0];t=t*t;SumLoadCurrent[0]=SumLoadCurrent[0]+t;    
1705   3                      }
1706   2                      
1707   2                      if(!Polarity0)//Èç¹ûµçÁ÷¸º°ëÖÜÆÚ
1708   2                      {
1709   3                              if(LoadDot[0]>(LoadZero+LoadMin))//½øÈëÕı°ëÖÜ
1710   3                              {
1711   4                                      Polarity0=1;
1712   4                                      PhaseTimer[0]=0;
1713   4                              }
1714   3                              
1715   3                      }else
1716   2                      {
1717   3                              if(LoadDot[0]<(LoadZero-LoadMin))//½øÈë¸º°ëÖÜ
1718   3                              {
1719   4                                      Polarity0=0;
1720   4                              }
1721   3                      }
1722   2                      
1723   2                      if(PhaseTimer[0]<199)PhaseTimer[0]++;
1724   2              }
1725   1              
1726   1              //CAÏàµçÑ¹
1727   1              if(LoadIndex==2)
1728   1              {
1729   2                      if(LoadDot[1]>LoadZero)
1730   2                      {
1731   3                              SumLoadCurrent[1]=SumLoadCurrent[1]+LoadDot[1]-LoadZero;//2012-11-28
1732   3                              //t=LoadDot[1]-LoadZero;t=t*t;SumLoadCurrent[1]=SumLoadCurrent[1]+t;
1733   3                      }
1734   2                      else 
1735   2                      {
1736   3                              SumLoadCurrent[1]=SumLoadCurrent[1]+LoadZero-LoadDot[1];//2012-11-28
1737   3                              //t=LoadZero-LoadDot[1];t=t*t;SumLoadCurrent[1]=SumLoadCurrent[1]+t;
1738   3                      }
1739   2                      
1740   2                      if(!Polarity1)//Èç¹ûµçÁ÷¸º°ëÖÜÆÚ
1741   2                      {
1742   3                              if(LoadDot[1]>(LoadZero+LoadMin))//½øÈëÕı°ëÖÜ
1743   3                              {
1744   4                                      Polarity1=1;
1745   4                                      PhaseTimer[1]=0;
1746   4                                      
1747   4                              }
1748   3                      }else
1749   2                      {
1750   3                              if(LoadDot[1]<(LoadZero-LoadMin))//½øÈë¸º°ëÖÜ
1751   3                              {
1752   4                                      Polarity1=0;
1753   4                              }
1754   3                      }
1755   2                      
1756   2                      if(PhaseTimer[1]<199)PhaseTimer[1]++;
1757   2              }
1758   1      
1759   1              
1760   1              //BCÏàµçÑ¹ºÍAÏßµçÑ¹
1761   1              if(LoadIndex==3)
1762   1              {
1763   2                      //AÏßµçÑ¹
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 30  

1764   2                      if(LoadDot[2]>LoadZero)SumLoadCurrent[3]=SumLoadCurrent[3]+LoadDot[2]-LoadZero;//2012-11-28
1765   2                      else SumLoadCurrent[3]=SumLoadCurrent[3]+LoadZero-LoadDot[2];//2012-11-28
1766   2              
1767   2                      //BCÏàµçÑ¹
1768   2                      LoadDot[2]=1024-(LoadDot[0]+LoadDot[1]-LoadZero);
1769   2                      if(LoadDot[2]>LoadZero)
1770   2                      {
1771   3                              SumLoadCurrent[2]=SumLoadCurrent[2]+LoadDot[2]-LoadZero;//2012-11-28
1772   3                              //t=LoadZero-LoadDot[2];t=t*t;SumLoadCurrent[2]=SumLoadCurrent[2]+t;
1773   3                      }else 
1774   2                      {
1775   3                              SumLoadCurrent[2]=SumLoadCurrent[2]+LoadZero-LoadDot[2];//2012-11-28
1776   3                              //t=LoadDot[2]-LoadZero;t=t*t;SumLoadCurrent[2]=SumLoadCurrent[2]+t;
1777   3                      }
1778   2                      
1779   2                      if(!Polarity2)//Èç¹ûµçÁ÷¸º°ëÖÜÆÚ
1780   2                      {
1781   3                              if(LoadDot[2]>(LoadZero+LoadMin))//½øÈëÕı°ëÖÜ
1782   3                              {
1783   4                                      Polarity2=1;
1784   4                                      PhaseTimer[2]=0;
1785   4                              }
1786   3                              
1787   3                      }else
1788   2                      {
1789   3                              if(LoadDot[2]<(LoadZero-LoadMin))//½øÈë¸º°ëÖÜ
1790   3                              {
1791   4                                      Polarity2=0;
1792   4                              }
1793   3                      }
1794   2                      
1795   2                      if(PhaseTimer[2]<199)PhaseTimer[2]++;
1796   2              }
1797   1              
1798   1              LoadDot[LoadIndex]=GetAdResult();
1799   1      
1800   1              LoadIndex=(LoadIndex+1)%4;
1801   1              AdReady(LoadIndex);
1802   1      
1803   1      timer0end:;
1804   1      }
1805          
1806          //void init()
1807          
1808          void Int0(void)         interrupt 0//int0
1809          {while(1){TI=0;SBUF=0x00;while(!TI){};/*Delay(1000)*/;}}
1810          //void Timer0(void) interrupt 1//timer0
1811          //{while(1){TI=0;SBUF=0x01;while(!TI){};Delay(1000);}}
1812          void Int1(void)         interrupt 2//int1
1813          {while(1){TI=0;SBUF=0x02;while(!TI){};/*Delay(1000)*/;}}
1814          void Timer1(void)       interrupt 3//timer1
1815          {while(1){TI=0;SBUF=0x03;while(!TI){};/*Delay(1000)*/;}}
1816          void UART1(void)        interrupt 4//uart Í¨ĞÅ
1817          {while(1){TI=0;SBUF=0x04;while(!TI){};/*Delay(1000)*/;}}
1818          void ADC(void)          interrupt 5//adc Ä£Êı×ª»»
1819          {while(1){TI=0;SBUF=0x05;while(!TI){};/*Delay(1000)*/;}}
1820          void LVC(void)          interrupt 6//pca µÍÑ¹¼ì²â
1821          {while(1){TI=0;SBUF=0x06;while(!TI){};/*Delay(1000)*/;}}
1822          void PCA(void)          interrupt 7
1823          {while(1){TI=0;SBUF=0x07;while(!TI){};/*Delay(1000)*/;}}
1824          void UART2(void)        interrupt 8
1825          {while(1){TI=0;SBUF=0x08;while(!TI){};/*Delay(1000)*/;}}
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 31  

1826          void SPI(void)          interrupt 9
1827          {while(1){TI=0;SBUF=0x09;while(!TI){};/*Delay(1000)*/;}}
1828          void Int2(void)         interrupt 10
1829          {while(1){TI=0;SBUF=0x10;while(!TI){};/*Delay(1000)*/;}}
1830          void Int3(void)         interrupt 11
1831          {while(1){TI=0;SBUF=0x11;while(!TI){};/*Delay(1000)*/;}}
1832          void Timer2(void)       interrupt 12
1833          {while(1){TI=0;SBUF=0x12;while(!TI){};/*Delay(1000)*/;}}
1834          void zd13(void)         interrupt 13
1835          {while(1){TI=0;SBUF=0x13;while(!TI){};/*Delay(1000)*/;}}
1836          void zd14(void)         interrupt 14
1837          {while(1){TI=0;SBUF=0x14;while(!TI){};/*Delay(1000)*/;}}
1838          void zd15(void)         interrupt 15
1839          {while(1){TI=0;SBUF=0x15;while(!TI){};/*Delay(1000)*/;}}
1840          void Int4(void)         interrupt 16
1841          {while(1){TI=0;SBUF=0x16;while(!TI){};/*Delay(1000)*/;}}
1842          void S3(void)           interrupt 17
1843          {while(1){TI=0;SBUF=0x17;while(!TI){};/*Delay(1000)*/;}}
1844          void S4(void)           interrupt 18
1845          {while(1){TI=0;SBUF=0x18;while(!TI){};/*Delay(1000)*/;}}
1846          void Timer3(void)       interrupt 19
1847          {while(1){TI=0;SBUF=0x19;while(!TI){};/*Delay(1000)*/;}}
1848          void Timer4(void)       interrupt 20
1849          {while(1){TI=0;SBUF=0x20;while(!TI){};/*Delay(1000)*/;}}
1850          void Comparator(void) interrupt 21
1851          {while(1){TI=0;SBUF=0x21;while(!TI){};/*Delay(1000)*/;}}
1852          void PWM(void)          interrupt 22
1853          {while(1){TI=0;SBUF=0x22;while(!TI){};/*Delay(1000)*/;}}
1854          void PWMFD(void)        interrupt 23
1855          {while(1){TI=0;SBUF=0x23;while(!TI){};/*Delay(1000)*/;}}
1856          
1857          
1858          //Ö÷³ÌĞò
1859          void main()
1860          {
1861   1      //unsigned int ii;
1862   1      //unsigned char i;
1863   1      //¿´ÃÅ¹·³ÌĞò
1864   1      /*
1865   1              i=WDT_CONTR;
1866   1              if(i>127)//Èç¹û¿´ÃÅ¹·¸´Î»
1867   1              {
1868   1                      while(1){};
1869   1              }else WDT_CONTR=0x3e;//2.72Ãë¿´ÃÅ¹·
1870   1      */
1871   1      
1872   1      //*****************************************
1873   1      //Ó²¼ş³õÊ¼»¯
1874   1              IE=0;
1875   1      //T0
1876   1              TH0=(65536-Crystal/12000*InitTime/1000)/256;
1877   1              TL0=(65536-Crystal/12000*InitTime/1000)%256;
1878   1      
1879   1              TMOD=0x21;TR0=1;ET0=1;
1880   1      
1881   1               
1882   1              SxBUF_Init();
1883   1      
1884   1      //INT0
1885   1              //IT0=1;                //ÏÂ½µÑØ
1886   1              //EX0=1;                
1887   1      
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 32  

1888   1              ADC_CONTR=0x60;//½«×ª»»ËÙ¶ÈÉèÎª×î¸ß,210¸öÊ±ÖÓÖÜÆÚ
1889   1              ADC_CONTR=ADC_CONTR|0x80;//´ò¿ª×ª»»µçÔ´
1890   1      
1891   1      //INT0
1892   1      //      IT0=1;          //ÏÂ½µÑØ
1893   1      //      EX0=1;          //¼ÓÈÈ»òÕßÏû´ÅÊ±´ò¿ª
1894   1      
1895   1              PX0=0;PT0=1;IP2=0;
1896   1      
1897   1              ADC_CONTR=0x60;//½«×ª»»ËÙ¶ÈÉèÎª×î¸ß,210¸öÊ±ÖÓÖÜÆÚ
1898   1              ADC_CONTR=ADC_CONTR|0x80;//´ò¿ª×ª»»µçÔ´
1899   1      //½«P1.3,P1.4,P1.5ÉèÖÃÎªA/D×ª»»Ä£Ê½
1900   1      
1901   1      /*
1902   1      M1      M0
1903   1      0       0       Ë«Ïò
1904   1      0       1       Êä³ö
1905   1      1       0       ÊäÈë
1906   1      1       1       ¿ªÂ©¡¢AD
1907   1      
1908   1      O       Êä³ö
1909   1      I       ÊäÈë
1910   1      NC      Î´ÓÃÒı½Å
1911   1      N0      Ã»ÓĞÒı½Å
1912   1      */
1913   1              //01234567
1914   1          //TO14,TO15,TO16,TO3,TO2,S1,S0,NC
1915   1              P0M1=0x00;P0M0=0x00;
1916   1      
1917   1              //RXD2,TXD2,LOAD,AD0,AD1,AD2,2.5V,NC
1918   1              P1M1=~0x03;P1M0=~0x03;
1919   1      
1920   1              //NC,NC,NC,NC,TO4,TO5,TO6,TO7
1921   1              P2M1=0x00;P2M0=0x00;
1922   1      
1923   1          //RXD,TXD,IN8,IN7,IN6,IN3,IN2,IN1
1924   1              P3M1=0x00;P3M0=~0x03;//01´®¿Ú+6¸ö2803
1925   1      
1926   1              //NC,DF,DB,DA,NC,TO12,TO13,NC
1927   1              P4M1=0x00;P4M0=0x00;
1928   1      
1929   1              //IN5,IN4,TO1,NC,NC,NC,NO,NO
1930   1              P5M1=0x00;P5M0=0x03;//2¸ö2803+1¸ö¹âÅ¼
1931   1              
1932   1              //SCK,IO,RST,NC,NC,NC,NC,NC
1933   1              //P6M1=0x00;P6M0=0x05;
1934   1              P6M1=0x00;P6M0=0x07;//ds1302Êı¾İ¶Ë¿Ú±ØĞëÉÏÀ­²ÅÄÜ¿É¿¿¹¤×÷
1935   1      
1936   1              //DG,DE,DD,DC,TO8,TO9,TO10,TO11
1937   1              P7M1=0x00;P7M0=0x00;
1938   1      
1939   1      /*
1940   1              {TI=0;SBUF=1;}
1941   1              while(1)
1942   1              {
1943   1                      L0=0;L1=0;L2=0;
1944   1                      DA=1;
1945   1                      DB=1;
1946   1                      DC=1;
1947   1                      DD=1;
1948   1                      DE=1;
1949   1                      DF=1;
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 33  

1950   1                      DG=0;
1951   1                      L0=1;L1=0;L2=0;
1952   1                      ii++;
1953   1                      if(ii==0)
1954   1                      {
1955   1                              while(TI){TI=0;SBUF=i;i++;}
1956   1                      }
1957   1              }
1958   1      */
1959   1      //test end
1960   1      
1961   1              ErrorState      =0;
1962   1              
1963   1              DrvUpSta        =0;
1964   1              FlagOverLoad    =0;
1965   1              FlagErrorPhase  =0;
1966   1              FlagLosePhase   =0;
1967   1              FlagStart       =0;
1968   1              DrvSl3          =1;//±ÕËø°²È«Ëø
1969   1              DrvRun          =0;//ÔÊĞíÔËĞĞ
1970   1              
1971   1              OverLoad=0;
1972   1              OverLoadCount=1;
1973   1              Polarity0=0;
1974   1              Polarity1=0;
1975   1              Polarity2=0;
1976   1              
1977   1              PhaseError=0;
1978   1      
1979   1              PhaseTimer[0]=0;
1980   1              PhaseTimer[1]=0;
1981   1              PhaseTimer[2]=0;
1982   1              
1983   1              PhaseLose=0;
1984   1              
1985   1              CountIndex=0;
1986   1              SecCount=255;
1987   1      
1988   1              GaoDu=0;
1989   1      
1990   1      //2017-5-25 start
1991   1              OneMin=0;
1992   1              FlagOverTimer=0;
1993   1              OverTimer=0;
1994   1      
1995   1              CheckID();
1996   1      
1997   1              //test();//Ò»Ğ©¹¦ÄÜ²âÊÔ
1998   1      
1999   1      //2017-5-25 end
2000   1              
2001   1      //*********************************************Ok
2002   1              EA=1;   //µ÷ÊÔÊ±¹Ø¶Ï
2003   1              
2004   1              ErrorState      =0;
2005   1              
2006   1              DrvUpSta        =0;
2007   1              FlagOverLoad    =0;
2008   1              FlagErrorPhase  =0;
2009   1              FlagLosePhase   =0;
2010   1              FlagStart       =0;
2011   1              DrvSl3          =1;//±ÕËø°²È«Ëø
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 34  

2012   1              DrvRun          =0;//ÔÊĞíÔËĞĞ
2013   1      
2014   1              FlagPowerL      =0;             //ÓÃÒÔ¼ì²âµçÑ¹¹ÊÕÏ Ç·Ñ¹
2015   1              FlagPowerH      =0;             //ÓÃÒÔ¼ì²âµçÑ¹¹ÊÕÏ ¹ıÑ¹
2016   1              
2017   1              
2018   1              OverLoad=0;
2019   1              OverLoadCount=1;
2020   1              Polarity0=0;
2021   1              Polarity1=0;
2022   1              Polarity2=0;
2023   1              
2024   1              PhaseError=0;
2025   1      
2026   1              PhaseTimer[0]=0;
2027   1              PhaseTimer[1]=0;
2028   1              PhaseTimer[2]=0;
2029   1              
2030   1              PhaseLose=0;
2031   1              
2032   1              CountIndex=0;
2033   1              SecCount=255;
2034   1              
2035   1              while(1){RstPower();_nop_();_nop_();_nop_();_nop_();}
2036   1              while(1){RstPower();_nop_();_nop_();_nop_();_nop_();}
2037   1              while(1){RstPower();_nop_();_nop_();_nop_();_nop_();}
2038   1      }
2039          
2040          /*
2041          void test()
2042          {
2043          unsigned char t,i;
2044          
2045          Flag_CheckID=1;EA=1;
2046          
2047          LedStr[0]=1;i=Read1302 (READ_MONTH);LedStr[1]=i/16;LedStr[2]=i%16;ShowTimer=7;//=7ÏÔÊ¾bcd7¶Î±àÂë£¬=8Ö±½ÓÏÔ
             -Ê¾Êı¾İ
2048          
2049          while(1)
2050                  {
2051                  t=0;
2052                  while(Clock_1s!=0){RstPower();};{Clock_1s++;t++;LedStr[0]=t;i=Read1302 (READ_YEAR);LedStr[1]=i/16;LedStr[
             -2]=i%16;}
2053                  while(Clock_1s!=0){RstPower();};{Clock_1s++;t++;LedStr[0]=t;i=Read1302 (READ_MONTH);LedStr[1]=i/16;LedStr
             -[2]=i%16;}
2054                  while(Clock_1s!=0){RstPower();};{Clock_1s++;t++;LedStr[0]=t;i=Read1302 (READ_DATE);LedStr[1]=i/16;LedStr[
             -2]=i%16;}
2055                  while(Clock_1s!=0){RstPower();};{Clock_1s++;t++;LedStr[0]=t;i=Read1302 (READ_HOUR);LedStr[1]=i/16;LedStr[
             -2]=i%16;}
2056                  while(Clock_1s!=0){RstPower();};{Clock_1s++;t++;LedStr[0]=t;i=Read1302 (READ_MINUTE);LedStr[1]=i/16;LedSt
             -r[2]=i%16;}
2057                  while(Clock_1s!=0){RstPower();};{Clock_1s++;t++;LedStr[0]=t;i=Read1302 (READ_SECOND);LedStr[1]=i/16;LedSt
             -r[2]=i%16;}
2058                  }
2059          }
2060          
2061          */


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   8732    ----
   CONSTANT SIZE    =     64    ----
C51 COMPILER V8.05a   CONTR50L                                                             02/03/2018 11:59:20 PAGE 35  

   XDATA SIZE       =     74    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     36      37
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     16       3
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
