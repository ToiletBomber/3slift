C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 1   


C51 COMPILER V8.05a, COMPILATION OF MODULE CONTR50L
OBJECT MODULE PLACED IN contr50L.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE contr50L.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          //zjbtest
   2          /*
   3          *****************************±ØĞëÊ¹ÓÃ×Ô¶¯ÔöÁ¿Ä£Ê½£¬ÆğÊ¼µØÖ·0x22£¬ÔöÁ¿³¤¶È3£¬ÔöÁ¿Öµ1£¬Ê®½øÖÆ¸ñÊ½
   4          *****************************×¢Òâ£¬
   5          *****************************ÉÕÂ¼²ÉÓÃ18.4320M£¬
   6          *****************************µÍµçÑ¹½ûÖ¹eeprom²Ù×÷£¬
   7          *****************************eepromÌî³äÎªFF
   8          
   9          ID´æ´¢Î»ÖÃ 0x20,0x21,0x22
  10          ÊÚÈ¨ÓĞĞ§Ê±¼ä´æ´¢Î»ÖÃÒ³Âë0£¬1£¬2£¬µØÖ·0x00(Äê)£¬0x01(ÔÂ),0x02(ÈÕ)
  11          
  12          ±£´æ¿ª»úÊ±Ê±ÖÓÒ³Âë4£¬5£¬6£¬µØÖ·0x00(Äê)£¬0x01(ÔÂ),0x02(ÈÕ),0x03(Ê±),0x04(·Ö),0x05(Ãë)
  13          
  14          ±£´æÊ±ÖÓÍ£°Ú×Ô¶¯ĞŞ¸´´ÎÊıÒ³Âë8£¬µØÖ·0x00£¬µ±´óÓÚ10´Î±¨´í
  15          
  16          ¿ª»úÊÚÈ¨·½Ê½£¬¿ª»ú½øĞĞ0.1ÃëÖÓµÄ¼ì²â£¬ÅĞ¶ÏÊÇ·ñ´æÔÚÊÚÈ¨ĞèÇó
  17          
  18          2017-5-31
  19          
  20          ÔÚÒÔÇ°µÄ³ÌĞòÉÏĞŞ¸ÄÉı¼¶Îªstc15w4k32s4µÄĞÂ°æ±¾³ÌĞò£¬ÒÔÇ°³ÌĞòµÄĞŞ¸Ä¼ÇÂ¼±£Áô£¬µ«¿ÉÄÜÒÑ¾­Ã»ÓĞÒâÒå
  21          stc15w4k32s4Ê¹ÓÃÍ·ÎÄ¼ş·½Ê½£¬²»ÔÙ×Ô¼º¶¨Òå
  22          
  23          ÒÔÏÂÊÇÃ»ÓĞ1302Ç°µÄĞŞ¸Ä¼ÇÂ¼
  24          2017-5-27
  25                  1\Ê¹ÓÃÍâ²¿´æ´¢Æ÷±àÒëºó£¬Ò»Ğ©±äÁ¿ĞèÒª³õÊ¼»¯
  26                  2\ÆÁ±ÎÁËÃ»ÓĞÌ«´óÒâÒåµÄE31¹ÊÕÏ
  27          2017-5-25
  28          1\ĞÂÔö°´ÕÕÔËĞĞÊ±¼äÀ´ÉÏËø
  29                  Ö»¼ÆÉÏÉıÔËĞĞÊ±¼ä£¬
  30                  ÔËĞĞÊ±¼äÓÃ·ÖÖÓ¼Æ,Ê¹ÓÃ2¸ö×Ö½Ú,65535·Ö=1092Ğ¡Ê±£¬
  31                  ÔËĞĞÊ±¼ä³¬Ê±Ê±,Ö»ÏŞÖÆÉÏÉı,²»ÏŞÖÆÏÂ½µ,²¢Ö»ÔÚĞÂ¿ªµçÔ´Ê±²ÅÓĞĞ§£¬
  32          
  33          2\Ê±¼äËø×î´óÊ±¼äÓÃ³ÌĞòµØÖ·ĞŞ¸Ä,³ÌĞòµØÖ·Îª[0x0010,0x0011],×î´óÊ±¼ä=[0x0010]*256+[0x0011]
  34          ¶Ô16½øÖÆ,¿ÉÒÔ´ÖËã0x40ÎªÒ»Ğ¡Ê±,0x80,0xc0,0x100......
  35          
  36          3\°´ÕÕÃ¿ÖÜÊ¹ÓÃ1´Î,Ã¿´Î20·ÖÖÓ,ÉÏÉıÎª10·ÖÖÓ,³¬¹ı10·ÖÖÓµ±´Î²»ÔÚ¼ÆÊ±
  37          
  38          4\Èç¹ûÃ»ÓĞÌØÊâÒªÇó£¬×î´ó¹¤×÷Ê±³¤ÉèÎª300Ğ¡Ê±
  39          
  40          2017-05-22
  41          ÓÉÓÚ¿Í»§ÔÚ°²È«Ëø´¥·¢×´Ì¬ÏÂ£¬´íÎóÊ¹ÓÃ½âËø·½Ê½£¬¼´ÉÏµçÊ±°´ÏÂ½µ°´Å¥£¨Ó¦¸Ã°´ÉÏÉı°´Å¥È»ºóÊÖ¶¯½âËø£©£¬ËùÒÔÆÁ±Îµô
             -ÏÂ½µÓĞĞ§
  42          
  43          2017-01-04²âÊÔ½«»¥¸ĞÆ÷ÏŞÁ÷µç×èÓÉ200kÔö¼Óµ½600k,Í¬Ê±Êä³ö×è¿¹ÓÉ330Ôöµ½1k
  44          
  45          2015-08-12
  46          ÓÉÓÚÊ¹ÓÃ·¢µç»úµçÑ¹¹ıµÍ±¨¾¯»á¸²¸ÇÆäËû¹ÊÕÏ±¨¾¯,ÑÏÖØÓ°Ïì¿Í·şµ÷ÊÔ,¸ÄµçÑ¹±¨¾¯²»ÍêÈ«¸²¸ÇÔ­ÓĞ¹ÊÕÏĞÅÏ¢
  47          
  48          2015-04-08
  49          ÏÖ³¡·¢ÏÖÆµ·±±¨µçÑ¹¹ıµÍ,ĞŞ¸ÄÔ­À´360Îª330·ü
  50          
  51          2014/3/19
  52          Ôö¼ÓÒ»¸öÊ±¼ä¼ÆÊıÆ÷,ÒÔÏÂÏŞÎ»´¥·¢¹éÁã,¼ÇÂ¼µçÌİÉÏÉıºÍÏÂ½µµÄÊ±¼ä,ÒÔ±ã´Ö¹ÀÉı½µ»úµÄÎ»ÖÃ,ÅĞ¶¨¹ıÔØÊ±ÅÙ³ıµçÀÂµÄÖØÁ¿
             -ºÍ¸ÖË¿ÉşµÄÓ°Ïì,±äÁ¿Ãûint GaoDu,ÁíÉèÒ»¸ö³£Á¿(¼ÓÈ¨ÏµÊı)GaoDuK
  53          
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 2   

  54          2013-05-03ĞŞ¸Ä
  55          1¡¢²»ÔÙ¼ÆËãµÚÈıÏàµçÁ÷
  56          2¡¢¹ıÔØ²»ÔÙ²ÅÓÃÍÆÍì·½Ê½
  57          3¡¢
  58          
  59          2012-12-3²âÊÔ½á¹û
  60          1¡¢¿ª»ú±¨21ºÅ´íÎó£¬È»ºóÏûÊ§
  61          2¡¢¿ª»úÃ»ÓĞÊ±¼äÏÔÊ¾¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ª¡ªÓĞÏÔÊ¾£¬1.2Ôİ²»Ğè´¦Àí
  62          
  63          3¡¢Éè¶¨µÄ360~440£¬Êµ²â360~400
  64          4¡¢È±Ïà±¨µçÑ¹µÍ
  65          5¡¢¹ıÔØÎ´´¦Àí
  66          */
  67          
  68          
  69          /*
  70          ³ÌĞòĞŞ¸Ä¼ÇÂ¼
  71          2012-10-25 ÔÚ¶ş´úµçÌİ³ÌĞò»ù´¡ÉÏÖÆ×÷5´úµçÌİ³ÌĞò£¬Ô´³ÌĞòcontr204.c
  72          1¡¢¼ÌµçÆ÷¿ØÖÆ¹¦ÄÜÍ¨¹ı
  73          2¡¢ÕÕÃ÷Ê§°Ü£¬µÆÉÁË¸£¬¿¼ÂÇÈı¶ËÎÈÑ¹ºãÁ÷Ô´
  74          
  75          2012-11-28¼ÇÂ¼
  76          1¡¢µçÑ¹²âÊÔÍ¨¹ı
  77          2¡¢ÕÕÃ÷Ê§°Ü£¬ÎÈÑ¹Ğ¾Æ¬¹ıÈÈ£¬¿¼ÂÇ×¨ÓÃÕÕÃ÷ºãÁ÷Ô´
  78          
  79          2012-8-2
  80          ¶ÏÏà±£»¤ºÍ´íÏà±£»¤Ê±¼äÓÉ250ºÁÃë Ôö¼Óµ½2.5Ãë
  81          ³ÌĞòĞŞ¸Ä¼ÇÂ¼
  82          2012-3-24
  83          ¼ÓÈë±¸ÓÃÃÅ±¨¾¯
  84          ¶ÏÏà±£»¤µçÁ÷ÃÅÏŞÓÉ0.6Aµ÷µ½1.8A
  85          
  86          ±à³ÉÈÕÆÚ£º2009-12-25
  87          Íê³ÉµÄµ÷ÊÔ
  88          1¡¢²âÊÔµãµÄ²É¼¯ºÍË³ĞòÕûÀí
  89          2¡¢¹ıÔØµÄ¼ì²âºÍ¿ØÖÆ
  90          3¡¢°²È«Ëø¼ÌµçÆ÷µÄ¿ØÖÆ
  91          4¡¢¹ÊÕÏ¼ÌµçÆ÷µÄ¿ØÖÆ
  92          5¡¢¹ıÔØµÄ±ê¶¨
  93          6¡¢Ö÷µçÂ·µÄ¿ØÖÆ
  94          7¡¢ÉÏÉıµçÂ·µÄ¿ØÖÆ
  95          8¡¢ÏÂ½µµçÂ·µÄ¿ØÖÆ
  96          9¡¢¿ª»úµÄ¿ØÖÆ
  97          Î´Íê³ÉµÄµ÷ÊÔ
  98          1¡¢´íÏàµÄ¼ì²âºÍ¿ØÖÆ
  99          2¡¢È±ÏàµÄ¼ì²âºÍ¿ØÖÆ
 100          Íê³ÉÈÕÆÚ£º2010-1-11
 101          */
 102          //¿âÎÄ¼ş
 103          #include <intrins.h>
 104          #include <ABSACC.h>
 105          #include <STC15W4K32S4.h>
 106          
 107          //#include <STDIO.H>
 108          //°üÀ¨µÄº¯Êı
 109          
 110          //³£Êı
 111          #define OverLoadLimite  (128*4+6*10)    //¹ıÔØÔØÖØÖµ 0.2mV<==>25kg<==>6
 112          #define OverLoadLimite1 (OverLoadLimite-1)      
 113          
 114          #define Crystal         18432000
 115          #define BaudRate        19200
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 3   

 116          #define InitTime        200//(us)×î´ó256*12/18432000=42.6ms
 117          
 118          #define Alarm           0x40
 119          #define Error           0x20
 120          
 121          #define CheckCycle      31//´óÔ¼25ms 800us*31=24.8ms
 122          /*
 123          #define MaxPower        ((440-40)/2.5)//µçÑ¹ÉÏÏŞ£¬440V
 124          //#define MaxPower      (30/3.3)//µçÑ¹ÉÏÏŞ£¬ÀíÂÛÉÏÓ¦¸Ã=µçÑ¹/3£¬¿ÉÊµ²âÊÇµçÑ¹/3.3
 125          #define MinPower        ((360-40)/2.5)//µçÑ¹ÏÂÏŞ  360V
 126          #define LosePower       ((110-40)/2.5)//µçÑ¹ÏÂÏŞ  110V
 127          */
 128          #define MaxPower        (440/3.1)//µçÑ¹ÉÏÏŞ£¬Êµ²â420V
 129          //#define MinPower      (360/3.1)//µçÑ¹ÏÂÏŞ  Êµ²â360V
 130          #define MinPower        (330/3.1)//2015-04-08
 131          //#define MinPower      (430/3.1)//2015-08-12//test
 132          #define LosePower       (110/3.1)//µçÑ¹ÏÂÏŞ  110V
 133          
 134          /*Êµ²â½á¹û
 135          380V    80h
 136          
 137          388V    87h
 138          
 139          400V    7Eh     
 140          360V    6Dh
 141          
 142          
 143          20121212
 144          µÚÒ»´Î²âÁ¿£¬ÆäÖĞµÚÒ»¸ö»¥¸ĞÆ÷Õı×°£¬µÚ¶ş¸ö·´×°£¬µÚÈı¸öÊÇ¼ÆËãµÃ³ö
 145          50hz
 146          120     26 25 25
 147          300     68 66 5c
 148          320     6f 6d 63
 149          340     77 75 6a
 150          360     7f 7c 70
 151          380     87 84 78
 152          400     8f 8c 7f
 153          420     97 94 86
 154          440     9f 9c 8e
 155          460     a8 a4 95
 156          
 157                  60hz            50hz
 158          460     a7 a3 92        a9 a5 96
 159          400     8f 8c 7d        90 8c 80
 160          340     78 75 69        77 75 6a
 161          
 162          µÚÒ»´Î²âÁ¿£¬ÆäÖĞµÚÒ»¸ö»¥¸ĞÆ÷Õı×°£¬µÚ¶ş¸öÕı×°£¬µÚÈı¸öÊÇ¼ÆËãµÃ³ö
 163                  60hz            50hz
 164          460     a7 a3 92        a9 a5 96
 165          400     8f 8c 7d        90 8c 80
 166          340     78 75 69        77 75 6a
 167          
 168          
 169          µÃµ½¹ØÏµÊ½£¬Êı¾İ=(µçÑ¹-40)/2.5
 170          
 171          ÒÔÉÏÃ¿¸öÊı¾İ´ó¸ÅÔÚ+1»ò-1ÉÏ¸¡¶¯
 172          */
 173          
 174          
 175          //IOÎ»¶¨Òå
 176          //Ë«Ïò
 177           
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 4   

 178          //A/D£¬Õâ¼¸¸ö¶¨ÒåÖ»ÊÇÎªÁËËµÃ÷ioÎ»ÖÃ£¬Êµ¼Ê³ÌĞòÖĞ²¢²»³öÏÖ
 179          sbit    Load    =P1^2;  //³ÆÖØ´«¸ĞÆ÷£¬Òı½Å
 180          sbit    AD0             =P1^3;  //AÏà
 181          sbit    AD1             =P1^4;  //BÏà
 182          sbit    AD2             =P1^5;  //CÏà
 183          sbit    AD25    =P1^6;  //»¥¸ĞÆ÷»ù×¼µçÑ¹
 184          
 185          //Êä³ö
 186          sbit    DrvRun  =P3^2;  //¹ÊÕÏ¿ØÖÆ(È±Ïà£¬´íÏà£¬¹ıÔØ)
 187          sbit    DrvSl3  =P3^3;  //°²È«Ëø¿ØÖÆ
 188          sbit    Ss0     =P0^6;  //±¸ÓÃ£¬µçÂ·°åÀ©Õ¹ÓÃ
 189          sbit    Ss1     =P0^5;  //±¸ÓÃ£¬µçÂ·°åÀ©Õ¹ÓÃ
 190          
 191          sbit    L_Run   =P5^0;  //µÆ
 192          /*595ºÍ165£¬²»ÔÙÊ¹ÓÃ£¬ĞŞ¸ÄÍê³ÌĞòÉ¾³ı
 193          sbit    Pl      =P2^4;
 194          sbit    DatOut  =P2^5;
 195          sbit    Lsetb   =P2^6;
 196          sbit    Lclk    =P2^7;
 197          sbit    Nc2     =P3^2;  //¿Õ
 198          sbit    Nc3     =P3^3;  //¿Õ
 199          sbit    Nc4     =P3^4;  //¿Õ
 200          sbit    Clk     =P3^5;
 201          sbit    Ldat    =P3^7;
 202          
 203          //ÌØÊâ¹¦ÄÜ¼Ä´æÆ÷
 204          sfr     P0M0            =0x93;
 205          sfr     P0M1            =0x94;
 206          sfr     P1M0            =0x91;
 207          sfr     P1M1            =0x92;
 208          sfr     P2M0            =0x95;
 209          sfr     P2M1            =0x96;
 210          sfr     P3M0            =0xb1;
 211          sfr     P3M1            =0xb2;
 212          
 213          sfr     ISP_DATA        =0xe2;//ISP/IAP²Ù×÷Êı¾İ¼Ä´æÆ÷
 214          sfr     ISP_ADDRH       =0xe3;//ISP/IAP²Ù×÷µØÖ·¼Ä´æÆ÷¸ß°ËÎ»
 215          sfr     ISP_ADDRL       =0xe4;//ISP/IAP²Ù×÷µØÖ·¼Ä´æÆ÷µÍ°ËÎ»
 216          sfr     ISP_CMD         =0xe5;//ISP/IAP²Ù×÷ÃüÁî¼Ä´æÆ÷£¬ĞèÃüÁî´¥·¢¼Ä´æÆ÷´¥·¢·½¿ÉÉúĞ§
 217                                          //=0£º´ı»ú£¬ÎŞ²Ù×÷=1=2=3
 218                                          //=1£º¶Á
 219                                          //=2£ºĞ´
 220                                          //=3£º²Á³ı
 221          sfr     ISP_TRIG        =0xe6;//ISP/IAP²Ù×÷ÃüÁî´¥·¢¼Ä´æÆ÷
 222                                          //ÔÚISPEN(ISP_CONTR.7)=1Ê±£¬ÏÈĞ´Èë0x46£¬ÔÙĞ´Èë0xb9£¬ISP/IAPÃüÁî²Å»áÉúĞ§
 223          sfr     ISP_CONTR       =0xe7;////ISP/IAP¿ØÖÆ¼Ä´æÆ÷
 224          
 225          sfr     IPH             =0xb7;
 226          
 227          sfr     AUXR            =0x8e;
 228          
 229          
 230          sfr     WDT_CONTR               =0xe1;//¿´ÃÅ¹·
 231          
 232          */
 233          
 234          //¶¨ÒåÈ«¾Ö±äÁ¿
 235          unsigned char   DelayStart;     //¿ª»úµçÑ¹¼ì²âÑÓÊ±
 236          unsigned char   Sec5;           //Ò»¸ö5ÃëµÄÑ­»·¼ÆÊıÆ÷2015-08-12
 237          
 238          unsigned char xdata     State[20]={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};    //²É¼¯µãµÄ×´Ì¬¼Ä´æÆ÷
 239          unsigned char Tcount;           //²É¼¯¼ÆÊıÆ÷
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 5   

 240          
 241          unsigned char   ErrorState;     //´«ËÍµÄÃüÁî×Ö½Ú,×Ö½Ú¶¨Òå¼ûStateErrorCheck()
 242          unsigned char   CountIndex;     //¶¨Ê±Æ÷¼ÆÊı,±£Ö¤20ms·¢ËÍÒ»´ÎÖ¸Áî
 243          unsigned char   SecCount;       //¶¨Ê±Æ÷£¬ÓÃÓÚ1ÃëµÄ¼ÆÊ±,25ms¼õÒ»
 244          
 245          unsigned int xdata      OverLoad=0;
 246          unsigned long xdata     OverLoad1=0;
 247          unsigned int xdata      OverLoadCount=0;
 248          
 249          unsigned int xdata      Clock_1s=0;
 250          
 251          //Î»
 252          bit DrvUpSta;           //?
 253          bit FlagPowerL;         //ÓÃÒÔ¼ì²âµçÑ¹¹ÊÕÏ Ç·Ñ¹
 254          bit FlagPowerH;         //ÓÃÒÔ¼ì²âµçÑ¹¹ÊÕÏ ¹ıÑ¹
 255          bit FlagOverLoad;       //ÓÃÒÔ¼ì²â¹ıÔØ¹ÊÕÏ
 256          bit FlagErrorPhase;     //ÓÃÒÔ¼ì²â´íÏà¹ÊÕÏ
 257          bit FlagLosePhase;      //ÓÃÒÔ¼ì²âÈ±Ïà¹ÊÕÏ
 258          bit FlagStart;          //ÓÃÒÔ±êÊ¾¿ª»ú=0ÏÔÊ¾Ê±¼ä£¬=1ÏÔÊ¾×´Ì¬
 259          
 260          bit FlagRun;                                    //×´Ì¬±êÊ¾ =1ÔËĞĞ×´Ì¬ =0¿ÕÏĞ×´Ì¬ ÓÃÒÔ±£ÕÏÔËĞĞÖĞ²»¶Ô¹ıÔØ²âÁ¿£¬±ÜÃâÒâÍâÍ£»ú
 261          bit FlagReadCurrent;                    //=1¶ÁµçÁ÷²Ù×÷
 262          
 263          #define LoadZero        (128*4)         //0µçÁ÷Öµ
 264          //#define LoadMin       (16*4)          //¼ì²âµçÁ÷·§Öµ Ïàµ±ÓÚ20mA*16*4=1.2A
 265          //#define PhaseLoseMax  0x60    //È±ÏàºâÁ¿ÓĞµçÁ÷»ù×¼£¬Ïàµ±ÓÚ20mA*0x60/2=0.9A
 266          //#define PhaseLoseMin  0x40    //È±ÏàºâÁ¿ÎŞµçÁ÷»ù×¼£¬Ïàµ±ÓÚ20mA*0x40/2=0.6A
 267          
 268          #define LoadMin         64              //¼ì²âµçÁ÷·§Öµ Ïàµ±ÓÚ20mA*16*4=1.2A
 269          #define PhaseLoseMax    200     //È±ÏàºâÁ¿ÓĞµçÁ÷»ù×¼£¬Ïàµ±ÓÚ20mA*200/2=2A
 270          #define PhaseLoseMin    180     //È±ÏàºâÁ¿ÎŞµçÁ÷»ù×¼£¬Ïàµ±ÓÚ20mA*180/2=1.8A
 271          
 272          /*
 273                  Ô­Ê¼Êı¾İ£º      ta12-200 5A==>2.5mA
 274                  ×î´óÁ¿³Ì£º      2.5mA*470/5V*1024=240
 275                  ·Ö±æÂÊ£º        5A/240=20mA
 276          */
 277          unsigned int xdata      DelaySecCount=0;//ÑÓÊ±¼ÆÊıÆ÷
 278          //µçÁ÷¼ì²â
 279          
 280          unsigned int xdata      LoadDot[4]={0,0,0,0};   //ÈÎÒ»Ê±¿Ì²âÁ¿µ½µÄµçÁ÷
 281          //unsigned int  CurrentMax[3];                          //µçÁ÷²¨·å
 282          //unsigned int  CurrentMin[3];                          //µçÁ÷²¨¹È
 283          
 284          //0~2ÊÇABCÈıÏàÏà¼äµçÑ¹£¬3ÊÇAÏßµçÑ¹
 285          unsigned int xdata      LoadCurrent[4]={0,0,0,0};//µçÑ¹¾ùÖµ=SumLoadCurrent[3]/SumCount
 286          unsigned long xdata     SumLoadCurrent[4]={0,0,0,0};
 287          
 288          unsigned int    SumCount;
 289          unsigned char   PhaseLose;              //È±Ïà´íÎó¼ÆÊıÆ÷£¬ÖÁÉÙ10¸öÖÜÆÚ²ÅÅĞ¶Ï
 290          
 291          bit                             Polarity0;              //aÏàÏßµ±Ç°¼«ĞÔ
 292          bit                             Polarity1;              //bÏàÏßµ±Ç°¼«ĞÔ
 293          bit                             Polarity2;              //cÏàÏßµ±Ç°¼«ĞÔ
 294          unsigned char   PhaseTimer[3];  //ÏàĞò¼ÆÊ±
 295          unsigned char   PhaseError;             //ÏàĞò´íÎó¼ÆÊıÆ÷£¬ÖÁÉÙ10¸öÖÜÆÚ²ÅÅĞ¶Ï
 296          unsigned char   LoadIndex;              //Éè±¸¹¤×÷µçÁ÷²âÁ¿Ë÷Òı
 297          
 298          
 299          /*2014/3/19
 300          ¼Ù¶¨Éı½µ»úÔËĞĞ10·ÖÖÓ¼ÓÖØ50¹«½ï
 301          10·ÖÖÓ=600Ãë=600000ºÁÃë
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 6   

 302          GaoDuÃ¿25ºÁÃë¼ÆÊıÒ»´Î,¼ÆÊıÖµ=600000ºÁÃë/25ºÁÃë=24000
 303          ¶ø25¹«½ï,ÊıÄ£×ª»»ÖµÊÇ6(Õâ¸öÖµÊÇ·ñ×¼È·Î´Öª,ÏÈ¼Ù¶¨×¼È·)
 304          50¹«½ï¾ÍÊÇ12,24000/12=2000,Õâ¾ÍÊÇGaoDuKµÄÖµ
 305          */
 306          unsigned int    GaoDu;//2014/3/19
 307          #define GaoDuK  2000//2014/3/19
 308          
 309          //2017-5-25 start
 310          unsigned char   OldErrorState;  //
 311          bit                     FlagOverTimer;  //ÉÏµçÊ±¼ÇÂ¼³¬Ê±×´Ì¬
 312          bit                             OverTimer;              //³¬Ê±ºóÓĞÉÏÉı²Ù×÷±¨´í
 313          unsigned int    OneMin;
 314          unsigned int    OldWorkTime;    //Éè±¸¹¤×÷Ê±¼ä
 315          unsigned int    WorkTime;               //Éè±¸¹¤×÷Ê±¼ä
 316          unsigned int    Pc_WorkTime;    //¹¤×÷Ê±¼äµØÖ·Æ«ÒÆÁ¿ 
 317          //#define F_WorkTime    0x2800//stc12c5410ad
 318          #define F_WorkTime      0x0000//stc15w4k32s4£¬ÔÚstc15ÏµÁĞ£¬eeprom²»ÔÚÆ«ÒÆ£¨Ó²¼şÆ«ÒÆ£¬stc15w4k32s4Æ«ÒÆÎª0x8000£¬
             -Èç¹ûÊ¹ÓÃmovcÖ¸Áî£¬ĞèÒª¿¼ÂÇÆ«ÒÆÁ¿£©
 319          //#define Max_WorkTime (x*60+y)//xĞ¡Ê±ÓÖy·ÖÖÓ
 320          #define Max_WorkTime (300*60+0)//×î´óÊ±³¤300*2=600Ğ¡Ê±
 321          //#define Max_WorkTime (1*60+0)//Éè¶¨1Ğ¡Ê±
 322          unsigned char   WorkTimeStart;//±¾´Î¿ª»úÊ±¼ä
 323          //2017-5-25 end
 324          
 325          unsigned char RL1,RL2;//µçÎ»Æ÷µ÷ÕûÏÔÊ¾¶¯»­2017-8-22
 326          
 327          //ds1302³ÌĞò
 328          //¼Ä´æÆ÷ºê¶¨Òå 
 329          #define WRITE_SECOND            0x80 
 330          #define WRITE_MINUTE            0x82 
 331          #define WRITE_HOUR              0x84 
 332          #define READ_SECOND             0x81 
 333          #define READ_MINUTE             0x83 
 334          #define READ_HOUR               0x85 
 335          #define WRITE_PROTECT           0x8E
 336          #define READ_PROTECT            0x8F
 337          #define WRITE_POWER             0x90 
 338          #define READ_POWER              0x91 
 339          #define WRITE_YEAR              0x8C
 340          #define WRITE_MONTH             0x88 
 341          #define WRITE_DATE              0x86 
 342          #define READ_YEAR               0x8D 
 343          #define READ_MONTH              0x89 
 344          #define READ_DATE               0x87
 345          
 346          unsigned char xdata DATE[7];    //0Äê1ÔÂ2ÈÕ3Ê±4·Ö5Ãë 
 347          
 348          sbit    SCLK    = P2^1;                 //DS1302Ê±ÖÓĞÅºÅ
 349          sbit    DIO             = P2^2;                 // DS1302Êı¾İĞÅºÅ
 350          sbit    CE              = P2^3;                 // DS1302Æ¬Ñ¡ 
 351          
 352          sbit    DA              = P4^3;
 353          sbit    DB              = P4^2;
 354          sbit    DF              = P4^1;
 355          sbit    DC              = P7^3;
 356          sbit    DD              = P7^2;
 357          sbit    DE              = P7^1;
 358          sbit    DG              = P7^0;
 359          
 360          sbit    LED1    = P3^6;
 361          sbit    LED2    = P3^5;
 362          sbit    LED3    = P3^4;
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 7   

 363          sbit    IN3             = P2^4;
 364          sbit    IN2             = P2^5;
 365          sbit    IN1             = P2^6;
 366          unsigned char   ShowTimer;
 367          code char Bcd7Seg[64]   =
 368          {
 369          //dp g  f  e  d  c  b  a
 370              0x3F,// 0>>0
 371                  0x06,// 1>>1
 372                  0x5B,// 2>>2
 373                  0x4F,// 3>>3
 374                  0x66,// 4>>4
 375                  0x6D,// 5>>5
 376                  0x7D,// 6>>6
 377                  0x07,// 7>>7
 378                  0x7F,// 8>>8
 379                  0x6F,// 9>>9
 380                  0x77,// 10>>A
 381                  0x7C,// 11>>b
 382                  0x39,// 12>>C
 383                  0x5E,// 13>>d
 384                  0x79,// 14>>E
 385                  0x71,// 15>>F
 386                  0x76,// 16>>H
 387                  0x74,// 17>>h
 388                  0x38,// 18>>L
 389                  0x54,// 19>>n
 390                  0x63,// 20>>oÉÏ
 391                  0x5C,// 21>>oÏÂ
 392                  0x73,// 22>>p
 393                  0x67,// 23>>q
 394                  0x50,// 24>>r
 395                  0x3E,// 25>>U
 396                  0x40,// 26>>-
 397                  0x23,// 27>>ÉÏÉı
 398                  0x1C,// 28>>ÏÂ½µ
 399                  0x00,// 29>>¿Õ¸ñ
 400                  0x00,// 30>>¿Õ¸ñ
 401                  0x46,// 31>>-1
 402          
 403          //a  b  c  d  e  f  g  dp
 404              0xFC,// 0>>0
 405                  0x60,// 1>>1
 406                  0xDA,// 2>>2
 407                  0xF2,// 3>>3
 408                  0x66,// 4>>4
 409                  0xB6,// 5>>5
 410                  0xBE,// 6>>6
 411                  0xE0,// 7>>7
 412                  0xFE,// 8>>8
 413                  0xF6,// 9>>9
 414                  0xEE,// 10>>A
 415                  0x3E,// 11>>b
 416                  0x9C,// 12>>C
 417                  0x7A,// 13>>d
 418                  0x9E,// 14>>E
 419                  0x8E,// 15>>F
 420                  0x6E,// 16>>H
 421                  0x2E,// 17>>h
 422                  0x1C,// 18>>L
 423                  0x2A,// 19>>n
 424                  0xC6,// 20>>oÉÏ
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 8   

 425                  0x3A,// 21>>oÏÂ
 426                  0xCE,// 22>>p
 427                  0xE6,// 23>>q
 428                  0x0A,// 24>>r
 429                  0x7C,// 25>>U
 430                  0x02,// 26>>-
 431                  0xC4,// 27>>ÉÏÉı
 432                  0x38,// 28>>ÏÂ½µ
 433          
 434                  0x00,// 29>>¿Õ¸ñ
 435                  0x00,// 30>>¿Õ¸ñ
 436                  0x00,// 31>>¿Õ¸ñ
 437          };
 438          void Delay_us(unsigned int index)
 439          {
 440   1              while(index--)
 441   1              {
 442   2                      _nop_();_nop_();_nop_();_nop_();_nop_();_nop_();
 443   2                      _nop_();_nop_();_nop_();_nop_();_nop_();_nop_();
 444   2                      _nop_();_nop_();_nop_();_nop_();_nop_();_nop_();
 445   2              }
 446   1      }
 447          
 448          #define S2RI    0x01
 449          #define S2TI    0x02
 450          
 451          void Verify();
 452          void test();
 453          
 454          //µØÖ·¡¢Êı¾İ·¢ËÍ×Ó³ÌĞò 
 455          void Write1302 ( unsigned char addr,dat )     
 456          { 
 457   1              unsigned char i,temp; 
 458   1              
 459   1              CE=0;                         //CEÒı½ÅÎªµÍ£¬Êı¾İ´«ËÍÖĞÖ¹ 
 460   1              SCLK=0;                    //ÇåÁãÊ±ÖÓ×ÜÏß 
 461   1              Delay_us(4);
 462   1              CE = 1;                       //CEÒı½ÅÎª¸ß£¬Âß¼­¿ØÖÆÓĞĞ§ 
 463   1              Delay_us(4);
 464   1              //·¢ËÍµØÖ· 
 465   1              for ( i=8; i>0; i-- ) //Ñ­»·8´ÎÒÆÎ» 
 466   1              {     
 467   2                    SCLK = 0; 
 468   2                    temp = addr; 
 469   2                    DIO = (bit)(temp&0x01);          //Ã¿´Î´«ÊäµÍ×Ö½Ú 
 470   2                        Delay_us(1);
 471   2                    addr >>= 1;                //ÓÒÒÆÒ»Î» 
 472   2                    SCLK = 1; 
 473   2              } 
 474   1              //·¢ËÍÊı¾İ 
 475   1              for ( i=8; i>0; i-- ) 
 476   1              {     
 477   2                    SCLK = 0; 
 478   2                    temp = dat; 
 479   2                    DIO = (bit)(temp&0x01);          
 480   2                        Delay_us(1);
 481   2                    dat >>= 1;                   
 482   2                    SCLK = 1; 
 483   2              } 
 484   1              CE = 0;         
 485   1      } 
 486          
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 9   

 487          
 488          //Êı¾İ¶ÁÈ¡×Ó³ÌĞò 
 489          unsigned char Read1302 ( unsigned char Index) 
 490          { 
 491   1              unsigned char i,temp,temp1,addr;
 492   1      
 493   1              do
 494   1              {
 495   2                      temp1=temp;
 496   2                      addr=Index;
 497   2                      
 498   2                      CE=0;           
 499   2                      SCLK=0;
 500   2                      Delay_us(4);
 501   2                      CE = 1;  
 502   2                      Delay_us(4);
 503   2             //·¢ËÍµØÖ· 
 504   2                      for ( i=8; i>0; i-- )                      //Ñ­»·8´ÎÒÆÎ» 
 505   2                      {     
 506   3                            SCLK = 0; 
 507   3                                DIO = (bit)(addr&0x01);          //Ã¿´Î´«ÊäµÍ×Ö½Ú
 508   3                                Delay_us(1);
 509   3                            addr >>= 1;                              //ÓÒÒÆÒ»Î»
 510   3                            SCLK = 1; 
 511   3                      } 
 512   2      
 513   2      //¶ÁÈ¡Êı¾İ
 514   2      
 515   2      //      DIO =1;
 516   2      
 517   2                      for ( i=8; i>0; i-- ) 
 518   2                      { 
 519   3                            SCLK = 1; 
 520   3                                temp>>=1;
 521   3                            SCLK = 0;
 522   3                                Delay_us(1);
 523   3                                if(DIO)temp|=0x80;
 524   3                      }     
 525   2                      CE=0;
 526   2      
 527   2              }while(temp!=temp1);
 528   1       
 529   1              return (temp); 
 530   1      }
 531          
 532          
 533          
 534          //³õÊ¼»¯DS1302 
 535          void Initial(void)    
 536          { 
 537   1         Write1302 (WRITE_PROTECT,0X00);              //½ûÖ¹Ğ´±£»¤ 
 538   1      
 539   1         Write1302 (WRITE_YEAR,DATE[0]);                      //ÃëÎ»³õÊ¼»¯ 
 540   1         Write1302 (WRITE_MONTH,DATE[1]);             //·ÖÖÓ³õÊ¼»¯ 
 541   1         Write1302 (WRITE_DATE,DATE[2]);                      //ÃëÎ»³õÊ¼»¯ 
 542   1         Write1302 (WRITE_HOUR,DATE[3]);              //Ğ¡Ê±³õÊ¼»¯
 543   1         Write1302 (WRITE_MINUTE,DATE[4]);            //·ÖÖÓ³õÊ¼»¯ 
 544   1         Write1302 (WRITE_SECOND,0x00);               //ÃëÎ»³õÊ¼»¯ 
 545   1      
 546   1         Write1302 (WRITE_POWER,0xAA);                //2¸ö¶ş¼«¹Ü£¬4Ç§Å·
 547   1         Write1302 (WRITE_PROTECT,0x80);              //ÔÊĞíĞ´±£»¤ 
 548   1      } 
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 10  

 549          
 550          
 551          
 552          //²âÊÔ
 553          unsigned int t_int1;
 554          unsigned char t_char;
 555          
 556          #define CMD_IDLE        0       //¿ÕÏĞÄ£Ê½
 557          #define CMD_READ        1       //IAP¶Á
 558          #define CMD_PROGRAM     2       //IAPĞ´
 559          #define CMD_ERASE       3       //IAP²Á³ı
 560          
 561          #define ENABLE_IAP      0X81    //SYSCLK<24M
 562          
 563          void IapIdle()
 564          {
 565   1              IAP_CONTR=0;
 566   1              IAP_CMD=0;
 567   1              IAP_TRIG=0;
 568   1              IAP_ADDRH=0x80;
 569   1              IAP_ADDRL=0;
 570   1      }
 571          void WriteFlash(unsigned int IspAddr,unsigned char IspData)
 572          {
 573   1              IAP_CONTR=ENABLE_IAP;
 574   1              IAP_CMD=CMD_PROGRAM;
 575   1              IAP_ADDRL=IspAddr%0x100;
 576   1              IAP_ADDRH=IspAddr/0x100;
 577   1              IAP_DATA=0xff-IspData;
 578   1              IAP_TRIG=0x5A;
 579   1              IAP_TRIG=0xA5;
 580   1              _nop_();
 581   1              IapIdle();
 582   1      }
 583          unsigned char ReadFlash(unsigned int IspAddr)
 584          {
 585   1              unsigned char i;
 586   1              IAP_CONTR=ENABLE_IAP;
 587   1              IAP_CMD=CMD_READ;
 588   1              IAP_ADDRL=IspAddr%0x100;
 589   1              IAP_ADDRH=IspAddr/0x100;
 590   1              IAP_TRIG=0x5A;
 591   1              IAP_TRIG=0xA5;
 592   1              _nop_();
 593   1              i=0xff-IAP_DATA;
 594   1              IapIdle();
 595   1      
 596   1              return i;
 597   1      }
 598          void EraseFlash(unsigned int IspAddr)
 599          {
 600   1              IAP_CONTR=ENABLE_IAP;
 601   1              IAP_CMD=CMD_ERASE;
 602   1              IAP_ADDRL=IspAddr%0x100;
 603   1              IAP_ADDRH=IspAddr/0x100;
 604   1              IAP_TRIG=0x5A;
 605   1              IAP_TRIG=0xA5;
 606   1              _nop_();
 607   1              IapIdle();
 608   1      }
 609          
 610          unsigned int crc_cal_value(unsigned char data_value,unsigned int crc_value)
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 11  

 611          {
 612   1              unsigned char i;
 613   1              union{
 614   1                              unsigned char Addr[2];
 615   1                          unsigned int crc_value;
 616   1                      }temp;
 617   1      
 618   1              temp.crc_value=crc_value;
 619   1              temp.crc_value^=data_value;
 620   1      
 621   1              for(i=0;i<8;i++)
 622   1              {
 623   2                      if(temp.crc_value&0x0001)
 624   2                      {
 625   3                              temp.crc_value = temp.crc_value>>1;
 626   3                              temp.Addr[0]^=0xa0;
 627   3                              temp.Addr[1]^=0x01;
 628   3                      }
 629   2                      else temp.crc_value=temp.crc_value>>1;
 630   2              }
 631   1              return(temp.crc_value);
 632   1      }
 633          
 634          unsigned char xdata LedStr[3];
 635          bit Flag_CheckID;
 636          bit Flag_Timer0;                //ÓÃÓÚ¿ª»úÊ±¼ÆËãÊ±¼ä£¬Ã¿´Î¶¨Ê±ÖĞ¶ÏÖÃ1
 637          unsigned char code ID2 _at_     0x0020;
 638          unsigned char code ID1 _at_     0x0021;
 639          unsigned char code ID0 _at_     0x0022;
 640          
 641          unsigned char code EndYear _at_ 0x8000;//Èç¹ûÓÃiap¶ÁĞ´£¬µØÖ·Îª0x0000
 642          unsigned char code EndMon  _at_ 0x8001;
 643          unsigned char code EndDay  _at_ 0x8002;
 644          
 645          unsigned char code EndYear1 _at_ 0x8200;//Èç¹ûÓÃiap¶ÁĞ´£¬µØÖ·Îª0x0000
 646          unsigned char code EndMon1  _at_ 0x8201;
 647          unsigned char code EndDay1  _at_ 0x8202;
 648          
 649          unsigned char code EndYear2 _at_ 0x8400;//Èç¹ûÓÃiap¶ÁĞ´£¬µØÖ·Îª0x0000
 650          unsigned char code EndMon2  _at_ 0x8401;
 651          unsigned char code EndDay2  _at_ 0x8402;
 652          
 653          #define TB_NowTime              0xe9
 654          #define TB_EndTime              0xed
 655          
 656          unsigned char Sint_value=0;
 657          unsigned char Sint_value1=0;
 658          unsigned char Sint_count=0;
 659          
 660          void RstPower()
 661          {
 662   1              unsigned char t;
 663   1              if(RI)//ÔÚ³ÌĞòÔËĞĞ¹ı³ÌÖĞÒ²¿ÉÒÔÊÚÈ¨Ğ£ÕıÊ±¼ä
 664   1              {
 665   2                      RI=0;
 666   2                      t=SBUF;
 667   2                      if(t==TB_NowTime)//Ğ£Ê±Í¬²½
 668   2                      {
 669   3                              if(Sint_value==TB_NowTime)Sint_count++;
 670   3                              else Sint_count=0;
 671   3                      }
 672   2                      if(t==TB_EndTime)//ÊÚÈ¨Í¬²½
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 12  

 673   2                      {
 674   3                              if(Sint_value==TB_EndTime)Sint_count++;
 675   3                              else Sint_count=0;
 676   3                      }
 677   2                      if(Sint_value1==0xEB)
 678   2                      {
 679   3                              if(Sint_value<=0x20)
 680   3                              {
 681   4                                      TI=0;
 682   4                                      SBUF=ReadFlash(Sint_value*256+t);
 683   4                                      while(!TI);
 684   4                              }
 685   3                              else if(Sint_value<0x80){;}
 686   3                              else if(Sint_value<=0x90)
 687   3                              {
 688   4                                      Sint_value=Sint_value|0x01;//Èç¹ûÊı¾İÊÇĞ´£¬Ç¿ÖÆ¸ÄÎª¶Á
 689   4                                      TI=0;
 690   4                                      SBUF=Read1302(Sint_value);
 691   4                                      while(!TI){};
 692   4                              }
 693   3                      }
 694   2                      Sint_value1=Sint_value;
 695   2                      Sint_value=t;
 696   2                      if(Sint_count>10)IAP_CONTR=0x20;//ÖØĞÂÆô¶¯
 697   2              }
 698   1      }
 699          
 700          
 701          void CheckID()
 702          {
 703   1              unsigned int i,j;
 704   1              unsigned char t,t0;
 705   1              unsigned int crc_value;
 706   1              unsigned char BZ;//=0:¼ì²âID£¬=1:°üº¬±¾°åID
 707   1              
 708   1              union{
 709   1                              unsigned char Addr[4];
 710   1                          unsigned long value;
 711   1                      }EndDate;
 712   1              
 713   1              union{                             
 714   1                              unsigned char Addr[4];
 715   1                          unsigned long value;
 716   1                      }MeID;
 717   1              
 718   1              union{
 719   1                              unsigned char Addr[4];
 720   1                          unsigned long value;
 721   1                      }AcceptDat;
 722   1      
 723   1              MeID.Addr[0]=0;
 724   1              MeID.Addr[1]=ID2;
 725   1              MeID.Addr[2]=ID1;
 726   1              MeID.Addr[3]=ID0;
 727   1              AcceptDat.Addr[0]=0;
 728   1              BZ=0;
 729   1              Flag_CheckID=1;
 730   1              EA=1;
 731   1      //¼ì²éÊÇ·ñ¿ªÆôĞÂµÄÊÚÈ¨
 732   1      //¼ì²éÊ±ÖÓÊÇ·ñÕı³££¬¼ì²éÊ±ÖÓÊÇ·ñÍ£°Ú£¬Èç¹ûÍ£°Ú±¨E01£¬Í¬Ê±ÏÔÊ¾A01£¬²¢½ûÖ¹ÔËĞĞ
 733   1      //¼ì²éÊ±ÖÓÊÇ·ñÕı³££¬¼ì²éÊ±ÖÓ³äµçÉèÖÃ£¬Èç¹û´íÎó±¨E01£¬Í¬Ê±ÏÔÊ¾A03£¬²¢½ûÖ¹ÔËĞĞ
 734   1      //¼ì²éÊÇ·ñÊÚÈ¨¹ıÆÚ£¬Èç¹û¹ıÆÚ±¨E01£¬Í¬Ê±ÏÔÊ¾A01£¬²¢½ûÖ¹ÔËĞĞ
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 13  

 735   1      //Ê±¼äĞ£Õı
 736   1      
 737   1              RI=0;Flag_Timer0=0;i=0;
 738   1      
 739   1              //µÈ´ıÊÚÈ¨Ö¸Áî£¬²»ÂÛÓĞ»¹ÊÇÃ»ÓĞ£¬È·ÈÏÃ»ÓĞºó¼ì²éÊÚÈ¨×´Ì¬
 740   1              while((i<200))//500*200us=100ms,14msÓĞ10%µÄ»ú»áÍê³ÉÍ¨ĞÅ£¬16msÓĞ80%»ú»áÍê³ÉÍ¨ĞÅ£¬18msÓë16ms²î²»¶à£¬20ms»ù±
             -¾100%£¬×îºóÈ¡40ms
 741   1              {
 742   2                      if(Flag_Timer0) //Õâ¸ö±äÁ¿Ö»ÓĞÔÚ¼ì²éÊÚÈ¨Ê±ÖÃÎ»,ËùÒÔÆäÊµÕâ¸öº¯Êı¾ÍÊÇÑÓÊ±,ÉÏµçÊ±¼ì²éÊÇ·ñÒªÊÚÈ¨
 743   2                      {
 744   3                              i++;
 745   3                              Flag_Timer0=0;
 746   3                      }
 747   2                      if(RI)                  //Èç¹û´®¿Ú½ÓÊÕµ½Êı¾İ
 748   2                      {
 749   3                              RI=0;
 750   3                              t=SBUF;         //½ÓÊÕµ½µÄÊı¾İ´æÈët±äÁ¿ÖĞ
 751   3                              if(t==TB_EndTime) //ÊÕµ½Í¬²½Í·Îª 0xed
 752   3                              {
 753   4                                      while(t==TB_EndTime)//½ÓÊÜÍ¬²½Âë£¬Í¬Ê±µÈ´ıÊ×Î»ĞÅÏ¢
 754   4                                      {
 755   5                                              TI=0;
 756   5                                              SBUF=0xaa;        //·µ»Ø0XAA
 757   5                                              while(!RI){;}
 758   5                                              RI=0;
 759   5                                              t0=SBUF;          //ÏÂ¸öÊı¾İ´æÈët0±äÁ¿ÖĞ
 760   5                                              t=t0;             //½«t0ÖĞµÄÊı¾İ¸øtÈ·±£t0Ò»Ö±ÊÇ×îĞÂÊÕµ½µÄÖµ
 761   5                                      }
 762   4      
 763   4                                      //¿ªÊ¼½ÓÊÕÊı¾İ,ÏÈ×öCRC³ÌĞò
 764   4                                      crc_value=0xffff;
 765   4                                      crc_value=crc_cal_value(t,crc_value);//Ëæ»úÂë
 766   4      
 767   4                                      for(i=0;i<3;i++)//½ÓÊÕÊÚÈ¨ÈÕÆÚ
 768   4                                      {
 769   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[3]=t;crc_value=crc_cal_value(t,crc_value);
 770   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[2]=t;crc_value=crc_cal_value(t,crc_value);
 771   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 772   5                                      }
 773   4                                      EndDate.value=AcceptDat.value;
 774   4      
 775   4                                      for(i=0;i<1000;i++)//½ÓÊÕID
 776   4                                      {
 777   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 778   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[2]=t;crc_value=crc_cal_value(t,crc_value);
 779   5                                              while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[3]=t;crc_value=crc_cal_value(t,crc_value);
 780   5                                              if(AcceptDat.value==MeID.value)BZ=1;
 781   5                                      }
 782   4      
 783   4                                      //½ÓÊÕcrc
 784   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 785   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 786   4      
 787   4                                      if(crc_value==0)  //crcÎŞ´íÎó
 788   4                                      {
 789   5                                              if(BZ==1)        //idºÅÔÚÊÚÈ¨·¶Î§ÄÚ
 790   5                                              {
 791   6                                                      t=0x55; //ĞÅÏ¢½ÓÊÕÍê±Ï
 792   6                                              //ĞŞÕıÊÚÈ¨Ê±¼ä
 793   6                                                      for(i=0;i<3;i++)
 794   6                                                      {
 795   7                                                              BZ=0;
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 14  

 796   7                                                              while(!BZ)
 797   7                                                              {
 798   8                                                                      EraseFlash(i*512);      //µÚ1,2,3ÉÈÇø´æ´¢ÊÚÈ¨µÄÖÕÖ¹Ê±¼ä
 799   8                                                                      WriteFlash(i*512+0,EndDate.Addr[1]);
 800   8                                                                      WriteFlash(i*512+1,EndDate.Addr[2]);
 801   8                                                                      WriteFlash(i*512+2,EndDate.Addr[3]);
 802   8                                                                      BZ=(ReadFlash(i*512+0)==EndDate.Addr[1])&(ReadFlash(i*512+1)==EndDate.Addr[2])&(ReadFlash(i*512+2)
             -==EndDate.Addr[3]);
 803   8                                                              }
 804   7                                                      }
 805   6                                                      
 806   6                                              }
 807   5                                              else t=0xe1;
 808   5                                      }
 809   4                                      else t=0xee;
 810   4      
 811   4                                      for(i=0;i<5;i++)
 812   4                                      {
 813   5                                              TI=0;
 814   5                                              SBUF=t;
 815   5                                              while(!TI);
 816   5                                      }
 817   4      
 818   4                              }
 819   3                              else if(t==TB_NowTime)
 820   3                              {
 821   4                                      while(t==TB_NowTime)//½ÓÊÜÍ¬²½Âë£¬Í¬Ê±µÈ´ıÊ×Î»ĞÅÏ¢
 822   4                                      {
 823   5                                              TI=0;
 824   5                                              SBUF=0xa5;
 825   5                                              while(!RI){};
 826   5                                              RI=0;
 827   5                                              t0=SBUF;
 828   5                                              t=t0;
 829   5                                      }
 830   4      
 831   4                                      //¿ªÊ¼½ÓÊÕÊı¾İ,ÏÈ×öCRC³ÌĞò
 832   4                                      crc_value = 0xffff;
 833   4                                      crc_value = crc_cal_value(t,crc_value);//Ëæ»úÂë
 834   4      
 835   4                                      //½ÓÊÕÃë·ÖÊ±
 836   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[3]=t;crc_value=crc_cal_value(t,crc_value);
 837   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[2]=t;crc_value=crc_cal_value(t,crc_value);
 838   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 839   4                                      EndDate.value=AcceptDat.value;//½èÓÃ¼Ä´æÆ÷
 840   4                                      
 841   4                                      //½ÓÊÕÈÕÔÂÄê
 842   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[3]=t;crc_value=crc_cal_value(t,crc_value);
 843   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[2]=t;crc_value=crc_cal_value(t,crc_value);
 844   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;AcceptDat.Addr[1]=t;crc_value=crc_cal_value(t,crc_value);
 845   4      
 846   4                                      //½ÓÊÕcrc
 847   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;crc_value=crc_cal_value(t,crc_value);
 848   4                                      while(!RI){};RI=0;t=(t0<<1);t0=SBUF;t=t^t0;crc_value=crc_cal_value(t,crc_value);
 849   4      
 850   4                                      if(crc_value==0)
 851   4                                      {
 852   5                                              //ĞŞÕıÊ±ÖÓ
 853   5                                              BZ=0;
 854   5                                              while(!BZ)
 855   5                                              {
 856   6                                              Write1302 (WRITE_PROTECT,0X00);                                 //½ûÖ¹Ğ´±£»¤ 
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 15  

 857   6                                              Write1302 (WRITE_SECOND,EndDate.Addr[3]);               //ÃëÎ»³õÊ¼»¯ 
 858   6                                              Write1302 (WRITE_MINUTE,EndDate.Addr[2]);               //·ÖÖÓ³õÊ¼»¯ 
 859   6                                              Write1302 (WRITE_HOUR,EndDate.Addr[1]);                 //Ğ¡Ê±³õÊ¼»¯
 860   6                                              EndDate.value=AcceptDat.value;                                          //½èÓÃ¼Ä´æÆ÷
 861   6                                                      Write1302 (WRITE_DATE,EndDate.Addr[3]);                 //ÈÕÎ»³õÊ¼»¯ 
 862   6                                              Write1302 (WRITE_MONTH,EndDate.Addr[2]);                //ÔÂÖÓ³õÊ¼»¯ 
 863   6                                              Write1302 (WRITE_YEAR,EndDate.Addr[1]);                 //ÄêÊ±³õÊ¼»¯
 864   6                                              Write1302 (WRITE_POWER,0xAA);                                   //2¸ö¶ş¼«¹Ü£¬4Ç§Å·
 865   6                                              Write1302 (WRITE_PROTECT,0x80);                                 //ÔÊĞíĞ´±£»¤ 
 866   6              
 867   6                                                      BZ=(Read1302(READ_DATE)==EndDate.Addr[3])&(Read1302(READ_MONTH)==EndDate.Addr[2])&(Read1302(READ_YEA
             -R)==EndDate.Addr[1]);
 868   6                                                      //BZ=1;
 869   6                                              }
 870   5                                              EraseFlash(8*512);
 871   5                                              WriteFlash(8*512,0);//Ã¿´ÎĞ£Ê±ºó£¬Ê±ÖÓ×Ô¶¯ĞŞ¸´ÏŞ´Î¹é0
 872   5                                              
 873   5                                              IN1=1;
 874   5                                              LED1 =1;
 875   5              
 876   5                                              t=0x55;
 877   5                                      }
 878   4                                      else    t=0xee;
 879   4                                      for(i=0;i<5;i++)
 880   4                                      {
 881   5                                              TI=0;
 882   5                                              SBUF=t;
 883   5                                              while(!TI);
 884   5                                      }
 885   4                              }
 886   3                      }
 887   2              }
 888   1      
 889   1      
 890   1      //¼ì²éÊ±ÖÓÊÇ·ñÕı³££¬¼ì²éÊ±ÖÓÊÇ·ñÍ£°Ú£¬Èç¹ûÍ£°Ú±¨E01£¬Í¬Ê±ÏÔÊ¾A01£¬²¢½ûÖ¹ÔËĞĞ
 891   1              
 892   1              do
 893   1              {
 894   2                      t=Read1302(READ_PROTECT);
 895   2              }while(t&0x7f);//È·±£1302ÓĞ0Êı¾İÊä³ö£¬0x80»ò0x00
 896   1              
 897   1              t=Read1302(READ_SECOND);
 898   1              if(t&0x80)
 899   1              {
 900   2                      t0=0;
 901   2                      //³¢ÊÔĞŞ¸´
 902   2                      BZ=0;
 903   2                      i=4;j=5;
 904   2                      if((ReadFlash(i*512+0)==ReadFlash(j*512+0))&(ReadFlash(i*512+1)==ReadFlash(j*512+1))&(ReadFlash(i*512+2)
             -==ReadFlash(j*512+2))&(ReadFlash(i*512+3)==ReadFlash(j*512+3))&(ReadFlash(i*512+4)==ReadFlash(j*512+4))&(ReadFlash(i*512
             -+5)==ReadFlash(j*512+5))&!BZ)
 905   2                      {DATE[0]=ReadFlash(i*512+0);DATE[1]=ReadFlash(i*512+1);DATE[2]=ReadFlash(i*512+2);DATE[3]=ReadFlash(i*51
             -2+3);DATE[4]=ReadFlash(i*512+4);DATE[5]=ReadFlash(i*512+5);BZ=1;}
 906   2                      i=4;j=6;
 907   2                      if((ReadFlash(i*512+0)==ReadFlash(j*512+0))&(ReadFlash(i*512+1)==ReadFlash(j*512+1))&(ReadFlash(i*512+2)
             -==ReadFlash(j*512+2))&(ReadFlash(i*512+3)==ReadFlash(j*512+3))&(ReadFlash(i*512+4)==ReadFlash(j*512+4))&(ReadFlash(i*512
             -+5)==ReadFlash(j*512+5))&!BZ)
 908   2                      {DATE[0]=ReadFlash(i*512+0);DATE[1]=ReadFlash(i*512+1);DATE[2]=ReadFlash(i*512+2);DATE[3]=ReadFlash(i*51
             -2+3);DATE[4]=ReadFlash(i*512+4);DATE[5]=ReadFlash(i*512+5);BZ=1;}
 909   2                      i=5;j=6;
 910   2                      if((ReadFlash(i*512+0)==ReadFlash(j*512+0))&(ReadFlash(i*512+1)==ReadFlash(j*512+1))&(ReadFlash(i*512+2)
             -==ReadFlash(j*512+2))&(ReadFlash(i*512+3)==ReadFlash(j*512+3))&(ReadFlash(i*512+4)==ReadFlash(j*512+4))&(ReadFlash(i*512
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 16  

             -+5)==ReadFlash(j*512+5))&!BZ)
 911   2                      {DATE[0]=ReadFlash(i*512+0);DATE[1]=ReadFlash(i*512+1);DATE[2]=ReadFlash(i*512+2);DATE[3]=ReadFlash(i*51
             -2+3);DATE[4]=ReadFlash(i*512+4);DATE[5]=ReadFlash(i*512+5);BZ=1;}
 912   2      
 913   2                      i=DATE[0];j=i%16;i=i/16;i=i*10+j;if(i>99)BZ=0;
 914   2                      i=DATE[1];j=i%16;i=i/16;i=i*10+j;if((i==0)|(i>12))BZ=0;
 915   2                      i=DATE[2];j=i%16;i=i/16;i=i*10+j;if((i==0)|(i>31))BZ=0;
 916   2      
 917   2                      i=ReadFlash(8*512+0);
 918   2                      if(i>10)
 919   2                      {
 920   3                              BZ=0;
 921   3                              IN1=0;
 922   3                              LED1 =0;
 923   3                      }//ĞŞ¸´Ê±ÖÓÏŞÖÆÎª10´Î
 924   2                      else 
 925   2                      {
 926   3                              EraseFlash(8*512);
 927   3                              WriteFlash(8*512,i+1);
 928   3                              IN1=1;
 929   3                              LED1 =1;
 930   3                      }
 931   2                      if(BZ)Initial();
 932   2                      else
 933   2                      {
 934   3                              while(1)
 935   3                              {
 936   4                                      //ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;while(!(S2CON&S2TI)){}
 937   4                                      DrvRun=1;//½ûÖ¹ÔËĞĞ
 938   4                                      LED1 = 0;
 939   4                                      IN1 =0;
 940   4                                      RstPower();
 941   4      
 942   4                                      //²úÉúÒ»¸ö50000*200us=10ÃëµÄÖÜÆÚ
 943   4                                      while(!Flag_Timer0){}
 944   4                                      i++;
 945   4                                      Flag_Timer0=0;
 946   4                                      if(i>50000)i=0;
 947   4      
 948   4                                      //20msÏòB°å·¢×´Ì¬                       
 949   4                                      t=i%100;
 950   4                                      if(t==1){ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;}
 951   4      
 952   4                                      //ÏÔÊ¾µØÖ·ºÍ¹ÊÕÏ´úÂë
 953   4                                      t=i/10000;ShowTimer=7;
 954   4                                      if(t==2){t0=ID2;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 955   4                                      if(t==3){t0=ID1;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 956   4                                      if(t==4){t0=ID0;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 957   4                                      if(t<2){LedStr[0]=10;LedStr[1]=0;LedStr[2]=1;}//=7ÏÔÊ¾bcd7¶Î±àÂë£¬=8Ö±½ÓÏÔÊ¾Êı¾İ
 958   4                              }
 959   3                      }
 960   2              }
 961   1      
 962   1      //¼ì²éÊ±ÖÓÊÇ·ñÕı³££¬¼ì²éÊ±ÖÓ³äµçÉèÖÃ£¬Èç¹û´íÎó±¨E01£¬Í¬Ê±ÏÔÊ¾A03£¬²¢½ûÖ¹ÔËĞĞ
 963   1              t=Read1302(READ_POWER);
 964   1              if(t!=0xAA)
 965   1              {
 966   2                      t0=0;
 967   2                      while(1)
 968   2                      {
 969   3                              //ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;while(!(S2CON&S2TI)){}
 970   3                              DrvRun=1;//½ûÖ¹ÔËĞĞ
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 17  

 971   3                              LED1 = 0;
 972   3                              IN1 =0;
 973   3                              RstPower();
 974   3      
 975   3                              //²úÉúÒ»¸ö50000*200us=10ÃëµÄÖÜÆÚ
 976   3                              while(!Flag_Timer0){}
 977   3                              i++;Flag_Timer0=0;
 978   3                              if(i>50000)i=0;
 979   3      
 980   3                              //20msÏòB°å·¢×´Ì¬
 981   3                              t=i%100;
 982   3                              if(t==1){ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;}
 983   3      
 984   3                              //ÏÔÊ¾µØÖ·ºÍ¹ÊÕÏ´úÂë
 985   3                              t=i/10000;ShowTimer=7;
 986   3                              if(t==2){t0=ID2;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 987   3                              if(t==3){t0=ID1;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 988   3                              if(t==4){t0=ID0;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
 989   3                              if(t<2){LedStr[0]=10;LedStr[1]=0;LedStr[2]=3;}//=7ÏÔÊ¾bcd7¶Î±àÂë£¬=8Ö±½ÓÏÔÊ¾Êı¾İ
 990   3                      }
 991   2              }
 992   1      
 993   1      //¼ì²éÊÇ·ñÊÚÈ¨¹ıÆÚ£¬Èç¹û¹ıÆÚ±¨E01£¬Í¬Ê±ÏÔÊ¾A02£¬²¢½ûÖ¹ÔËĞĞ
 994   1              EndDate.Addr[0]=0;
 995   1              EndDate.Addr[1]=~EndYear;
 996   1              EndDate.Addr[2]=~EndMon;
 997   1              EndDate.Addr[3]=~EndDay;
 998   1      
 999   1              MeID.Addr[0]=0;
1000   1              MeID.Addr[1]=~EndYear1;
1001   1              MeID.Addr[2]=~EndMon1;
1002   1              MeID.Addr[3]=~EndDay1;
1003   1              if(EndDate.value!=MeID.value)
1004   1              {
1005   2                      EndDate=MeID;
1006   2                      MeID.Addr[0]=0;
1007   2                      MeID.Addr[1]=~EndYear2;
1008   2                      MeID.Addr[2]=~EndMon2;
1009   2                      MeID.Addr[3]=~EndDay2;
1010   2      
1011   2                      if(EndDate.value!=MeID.value)
1012   2                      {
1013   3                              EndDate=MeID;
1014   3                              MeID.Addr[0]=0;
1015   3                              MeID.Addr[1]=~EndYear;
1016   3                              MeID.Addr[2]=~EndMon;
1017   3                              MeID.Addr[3]=~EndDay;
1018   3      
1019   3                              if(EndDate.value!=MeID.value)EndDate.value=0;
1020   3                      }
1021   2              }
1022   1      
1023   1              AcceptDat.Addr[0]=0;AcceptDat.Addr[1]=Read1302(READ_YEAR);AcceptDat.Addr[2]=Read1302(READ_MONTH);AcceptDa
             -t.Addr[3]=Read1302(READ_DATE);
1024   1              if(AcceptDat.value>EndDate.value)
1025   1              {
1026   2                      while(1)
1027   2                      {
1028   3                              //ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;while(!(S2CON&S2TI)){}
1029   3                              DrvRun=1;//½ûÖ¹ÔËĞĞ
1030   3                              LED1 = 0;
1031   3                              IN1 =0;
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 18  

1032   3                              RstPower();
1033   3      
1034   3                              //²úÉúÒ»¸ö50000*200us=10ÃëµÄÖÜÆÚ
1035   3                              while(!Flag_Timer0){}
1036   3                              i++;
1037   3                              Flag_Timer0=0;
1038   3                              if(i>50000)i=0;
1039   3      
1040   3                              //20msÏòB°å·¢×´Ì¬
1041   3                              t=i%100;
1042   3                              if(t==1){ErrorState=Error+1;Verify();S2CON&=~S2TI;S2BUF=ErrorState;}
1043   3      
1044   3                              //ÏÔÊ¾µØÖ·ºÍ¹ÊÕÏ´úÂë
1045   3                              t=i/10000;ShowTimer=7;
1046   3                              if(t==2){t0=ID2;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
1047   3                              if(t==3){t0=ID1;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
1048   3                              if(t==4){t0=ID0;LedStr[0]=t-2;LedStr[1]=t0/16;LedStr[2]=t0%16;}
1049   3                              if(t<2){LedStr[0]=10;LedStr[1]=0;LedStr[2]=2;}//=7ÏÔÊ¾bcd7¶Î±àÂë£¬=8Ö±½ÓÏÔÊ¾Êı¾İ
1050   3                      }
1051   2              }
1052   1      
1053   1      //´æ´¢Ê±ÖÓµÄÄêÔÂÈÕÊ±·ÖÃë£¬ÒÔ±¸Êı¾İ¶ªÊ§¿ÉÒÔ×ÔĞĞ»Ø¸´Ê¹ÓÃ
1054   1              DATE[0]=Read1302(READ_YEAR);
1055   1              DATE[1]=Read1302(READ_MONTH);
1056   1              DATE[2]=Read1302(READ_DATE);
1057   1              DATE[3]=Read1302(READ_HOUR);
1058   1              DATE[4]=Read1302(READ_MINUTE);
1059   1              DATE[5]=Read1302(READ_SECOND);
1060   1      
1061   1              for(i=4;i<6;i++)
1062   1              {
1063   2                      BZ=0;
1064   2                      while(!BZ)
1065   2                      {
1066   3                              EraseFlash(i*512);
1067   3                              WriteFlash(i*512+0,DATE[0]);
1068   3                              WriteFlash(i*512+1,DATE[1]);
1069   3                              WriteFlash(i*512+2,DATE[2]);
1070   3                              WriteFlash(i*512+3,DATE[3]);
1071   3                              WriteFlash(i*512+4,DATE[4]);
1072   3                              WriteFlash(i*512+5,DATE[5]);
1073   3                              BZ=(ReadFlash(i*512+0)==DATE[0])&(ReadFlash(i*512+1)==DATE[1])&(ReadFlash(i*512+2)==DATE[2])&(ReadFlash
             -(i*512+3)==DATE[3])&(ReadFlash(i*512+4)==DATE[4])&(ReadFlash(i*512+5)==DATE[5]);
1074   3                      }
1075   2              }
1076   1      
1077   1              Flag_CheckID=0;
1078   1      }
1079          
1080          unsigned char Line;
1081          
1082          void LedWr(unsigned char Index)
1083          {
1084   1              DA=Index&0x01;
1085   1              DB=Index&0x02;
1086   1              DC=Index&0x04;
1087   1              DD=Index&0x08;
1088   1              DE=Index&0x10;
1089   1              DF=Index&0x20;
1090   1              DG=Index&0x40;
1091   1      }
1092          
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 19  

1093          void ShowID()//ShowTimer=0,1ÏÔÊ¾4ÃëID2£»=2ÏÔÊ¾2ÃëID1£»=3ÏÔÊ¾2ÃëID0£»
1094          {
1095   1              unsigned int i;
1096   1              unsigned char t0,t1,t2;
1097   1              switch(ShowTimer)
1098   1              {
1099   2                      case 2:i=ID1;t2=1;break;
1100   2                      case 3:i=ID0;t2=2;break;
1101   2                      default:i=ID2;t2=0;
1102   2              }
1103   1      
1104   1              t0=i%16;i=i/16;
1105   1              t1=i;
1106   1      
1107   1      
1108   1      }
1109          
1110          void ShowLoad()//ÏÔÊ¾¹ıÔØÊµ²âÊı¾İÓë»ù×¼Êı¾İµÄ²îÖµ£¬¾ø¶ÔÖµ3Î»Êı²»ÏÔÊ¾·ûºÅ
1111          {
1112   1              unsigned int i;
1113   1              unsigned char t0,t1,t2;
1114   1      
1115   1              RL1--;
1116   1              if(!RL1)
1117   1              {
1118   2                      RL1=100;//100*1.6ms=160ms
1119   2                      if(OverLoad<=OverLoadLimite1)
1120   2                      {
1121   3                              RL2=(RL2*2)%64;
1122   3                              if(RL2==0)RL2=1;
1123   3                              t2=RL2;
1124   3                      }else
1125   2                      {
1126   3                              RL2=RL2/2;
1127   3                              if(RL2==0)RL2=32;
1128   3                              t2=RL2;
1129   3                      }
1130   2              }
1131   1      
1132   1              if(OverLoad<=OverLoadLimite1)
1133   1              {
1134   2                      i=(OverLoadLimite1-OverLoad);
1135   2                      if(i>199)
1136   2                      {
1137   3                              t0=i%10;i=i/10;
1138   3                              t1=i%10;i=i/10;
1139   3                      }else
1140   2                      {
1141   3                              t0=i%10;i=i/10;
1142   3                              t1=i%10;i=i/10;
1143   3                              t2=Bcd7Seg[i%10];
1144   3                      }
1145   2              }
1146   1              else
1147   1          {
1148   2                      i=(OverLoad-OverLoadLimite1);
1149   2                      if(i>199)
1150   2                      {
1151   3                              t0=i%10;i=i/10;
1152   3                              t1=i%10;i=i/10;
1153   3                      }else if(i>99)
1154   2                      {
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 20  

1155   3                              t0=i%10;i=i/10;
1156   3                              t1=i%10;i=i/10;
1157   3                              t2=0x46;//-1
1158   3                      }else
1159   2                      {
1160   3                              t0=i%10;i=i/10;
1161   3                              t1=i%10;i=i/10;
1162   3                              t2=0x40;//¸ººÅ-
1163   3                      }               
1164   2              }
1165   1      
1166   1      }
1167          
1168          void ShowErrorState()
1169          {
1170   1              unsigned int i;
1171   1              unsigned char t0,t1,t2;
1172   1      
1173   1              i=ErrorState%32;
1174   1              t0=i%10;i=i/10;
1175   1              t1=i%10;
1176   1              i=ErrorState/32;
1177   1              t2=i%4;
1178   1      
1179   1      }
1180          
1181          void ShowSec()
1182          {
1183   1              unsigned char t0,t1,t2;
1184   1          //t2=Read1302 (READ_SECOND);
1185   1              t0=t2%16;
1186   1              t1=t2/16;
1187   1      }
1188          
1189          void ShowBcd()
1190          {;
1191   1      }
1192          
1193          void ShowStr()
1194          {;
1195   1      }
1196          
1197          
1198          void LedShow()
1199          {
1200   1      //ShowTimer==0,1,2,3;¿ª»úÏÔÊ¾ID,ÏÔÊ¾¹ı³Ì£¬3-,D1,D2,D3
1201   1      //ShowTimer==4;È»ºóÏÔÊ¾¹ıÔØÊı¾İ£¬Îª¹ıÔØ±ê¶¨Ìá¹©·½±ã
1202   1      //ShowTimer==5;ÔËĞĞºóÏÔÊ¾ÔËĞĞ×´Ì¬
1203   1      
1204   1              switch(ShowTimer)
1205   1              {
1206   2                      case 3:ShowID();break;
1207   2                      case 4:ShowLoad();break;
1208   2                      case 5:ShowErrorState();break;
1209   2                      case 6:ShowSec();break;
1210   2                      case 7:ShowBcd();break;
1211   2                      default:ShowStr();
1212   2              }
1213   1      }
1214          
1215          //A/D×ª»»×¼±¸
1216          void AdReady(unsigned char INDEX)
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 21  

1217          {
1218   1              if(INDEX==0)ADC_CONTR=0xe3;//AÏà²âÁ¿
1219   1              else if(INDEX==1)ADC_CONTR=0xe4;//BÏà²âÁ¿
1220   1              else if(INDEX==2)ADC_CONTR=0xe5;//CÏà²âÁ¿
1221   1              else if(INDEX==3)ADC_CONTR=0xe2;//¹ıÔØ²âÁ¿
1222   1      }
1223          
1224          void AdStart()
1225          {
1226   1              ADC_RES=0;
1227   1              ADC_RESL=0;
1228   1              ADC_CONTR=ADC_CONTR|0x08;
1229   1      }
1230          
1231          unsigned int GetAdResult()
1232          {
1233   1              while(!(ADC_CONTR&0x10)){};
1234   1              ADC_CONTR=ADC_CONTR&0xe7;
1235   1      
1236   1              return ADC_RES*4+ADC_RESL%4;  //<<2µÄ2´Î·½ ×óÒÆÁ½Î»
1237   1      }
1238          
1239          sbit To1        =P5^2;
1240          sbit To2        =P0^4;
1241          sbit To3        =P0^3;
1242          sbit To7        =P2^7;
1243          sbit To8        =P7^4;
1244          sbit To9        =P7^5;
1245          sbit To10       =P7^6;
1246          sbit To11       =P7^7;
1247          sbit To12       =P4^5;
1248          sbit To13       =P4^6;
1249          sbit To14       =P0^0;
1250          sbit To15       =P0^1;
1251          sbit To16       =P0^2;
1252          
1253          void StateCheck(void)//×´Ì¬¼ì²â
1254          {
1255   1      //Êı¾İ¶ÁÈ¡
1256   1      //Èç¹ûÓĞ24V£¬DatOut=0,State[]!=0
1257   1      //¶ÁÈ¡Ë³ĞòÓĞµçÂ·°å¾ö¶¨
1258   1              
1259   1              if(!To1){if(State[1]<200)State[1]++;}else{if(State[1]>0)State[1]--;}
1260   1              if(!To2){if(State[2]<200)State[2]++;}else{if(State[2]>0)State[2]--;}
1261   1              if(!To3){if(State[3]<200)State[3]++;}else{if(State[3]>0)State[3]--;}
1262   1              if(!To7){if(State[7]<200)State[7]++;}else{if(State[7]>0)State[7]--;}
1263   1              if(!To8){if(State[8]<200)State[8]++;}else{if(State[8]>0)State[8]--;}
1264   1              if(!To9){if(State[9]<200)State[9]++;}else{if(State[9]>0)State[9]--;}
1265   1              if(!To10){if(State[10]<200)State[10]++;}else{if(State[10]>0)State[10]--;} //ÉÏÉı
1266   1              if(!To11){if(State[11]<200)State[11]++;}else{if(State[11]>0)State[11]--;}
1267   1              if(!To12){if(State[12]<200)State[12]++;}else{if(State[12]>0)State[12]--;}
1268   1              if(!To13){if(State[13]<200)State[13]++;}else{if(State[13]>0)State[13]--;}
1269   1              if(!To14){if(State[14]<200)State[14]++;}else{if(State[14]>0)State[14]--;} //ÏÂ½µ
1270   1              if(!To15){if(State[15]<200)State[15]++;}else{if(State[15]>0)State[15]--;}
1271   1              if(!To16){if(State[16]<200)State[16]++;}else{if(State[16]>0)State[16]--;}
1272   1      }
1273          
1274          bit PhaseErrorCheck()
1275          {
1276   1      /*
1277   1      AÏà:00,01,02,03,04,05,06,07,  08,09,10,11,12,13,14,15,  16,17,18,19,20,21,22,23,
1278   1      BÏà:16,17,18,19,20,21,22,23,  00,01,02,03,04,05,06,07,  08,09,10,11,12,13,14,15,
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 22  

1279   1      CÏà:08,09,10,11,12,13,14,15,  16,17,18,19,20,21,22,23,  00,01,02,03,04,05,06,07,
1280   1      */
1281   1              unsigned char a[3];
1282   1              a[0]=PhaseTimer[0];
1283   1              a[2]=PhaseTimer[1];
1284   1              a[1]=PhaseTimer[2];
1285   1      
1286   1              //´íÏà7
1287   1              if(!FlagErrorPhase)//²»´íÏà
1288   1              {
1289   2                      if((a[0]<40)&(a[1]<40)&(a[2]<40))//3Ïà¶¼ÓĞµçÁ÷Í¨¹ı;200us*4*40=32ms
1290   2                      {
1291   3                              if(a[0]<a[1])//AÏà:00,01,02,03,04,05,06,07
1292   3                              {
1293   4                                      if((a[2]>a[0])&(a[2]<a[1]))
1294   4                                      {
1295   5                                              if(PhaseError!=0)PhaseError--;
1296   5                                      }
1297   4                                      else
1298   4                                      {
1299   5                                              /*´íÏà*/if(PhaseError<200)PhaseError++;
1300   5                                      }
1301   4                              }
1302   3                              else
1303   3                              {
1304   4                                      if((a[2]>a[0])|(a[2]<a[1]))//AÏà:08,09,10,11,12,13,14,15,  16,17,18,19,20,21,22,23,
1305   4                                      {
1306   5                                              if(PhaseError!=0)PhaseError--;
1307   5                                      }
1308   4                                      else
1309   4                                      {
1310   5                                              /*´íÏà*/if(PhaseError<200)PhaseError++;
1311   5                                      }                               
1312   4                              }
1313   3                      }
1314   2              }
1315   1              if(PhaseError>100)//´íÏà
1316   1              {
1317   2                      PhaseError=150;
1318   2                      ErrorState=Alarm+Error+7;//ERROR
1319   2                      FlagErrorPhase=1;
1320   2              }
1321   1              
1322   1              return FlagErrorPhase;
1323   1      }
1324          
1325          bit PowerCheck()   //zjb
1326          {
1327   1      //µçÑ¹±¨¾¯²ÉÓÃÍÆÍìÉè¼Æ
1328   1      
1329   1              //if(SecCount>(255-20*1))//25ms*20=500ms
1330   1              if(SecCount>(255-100))//25ms*100=2.5s£¬
1331   1              {//Æô¶¯2.5s²»¼ì²â£¬µÈ´ıµçÂ·ÎÈ¶¨   20130924
1332   2              }
1333   1              else if((LoadCurrent[0]<LosePower)&(LoadCurrent[1]<LosePower)&(LoadCurrent[2]<LosePower)&(LoadCurrent[3]<
             -LosePower))
1334   1              {//Î´¼ì²âµ½ÓĞĞ§µçÑ¹£¬²»¼ì²â£¬ÒÔ±ãÓÚµçÂ·°å¼ì²â2017-5-25
1335   2              }
1336   1              else
1337   1              {
1338   2                      if(FlagPowerL)//Ç·Ñ¹Ê±
1339   2                      {
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 23  

1340   3                              if((LoadCurrent[0]>MinPower)&(LoadCurrent[1]>MinPower)&(LoadCurrent[2]>MinPower))FlagPowerL=0;//²»Ç·Ñ¹
1341   3                              else {FlagPowerL=1;ErrorState=Alarm+Error+21;}
1342   3                      }else //Õı³£Ê±
1343   2                      {
1344   3                              if((LoadCurrent[0]<MinPower)|(LoadCurrent[1]<MinPower)|(LoadCurrent[2]<MinPower)){FlagPowerL=1;ErrorSta
             -te=Alarm+Error+21;}
1345   3                              else FlagPowerL=0;//²»Ç·Ñ¹
1346   3                      }
1347   2              
1348   2                      if(FlagPowerH)//³¬Ñ¹Ê±
1349   2                      {
1350   3                              if((LoadCurrent[0]<MaxPower)&(LoadCurrent[1]<MaxPower)&(LoadCurrent[2]<MaxPower))FlagPowerH=0;//²»³¬Ñ¹
1351   3                              else {FlagPowerH=1;ErrorState=Alarm+Error+20;}
1352   3                      }else //Õı³£Ê±
1353   2                      {
1354   3                              if((LoadCurrent[0]>MaxPower)|(LoadCurrent[1]>MaxPower)|(LoadCurrent[2]>MaxPower)){FlagPowerH=1;ErrorSta
             -te=Alarm+Error+20;}
1355   3                              else FlagPowerH=0;//²»³¬Ñ¹
1356   3                      }
1357   2              }
1358   1      
1359   1              if(Sec5>1){FlagPowerH=0;FlagPowerL=0;}//2015-08-12
1360   1      
1361   1              
1362   1              /*È±Ïà*/
1363   1              //if((((LoadCurrent[0]>MinPower)|(LoadCurrent[1]>MinPower)|(LoadCurrent[2]>MinPower))
1364   1              //&((LoadCurrent[0]<LosePower)|(LoadCurrent[1]<LosePower)|(LoadCurrent[2]<LosePower)))//¼ì²âµ½ÓĞĞ§µçÑ¹
1365   1              //|(LoadCurrent[3]<MinPower))//L1~NµçÑ¹¹ıµÍ
1366   1              if(
1367   1                  ((LoadCurrent[0]>MinPower)|(LoadCurrent[1]>MinPower)|(LoadCurrent[2]>MinPower))//¼ì²âµ½ÓĞĞ§µçÑ¹
1368   1                 &((LoadCurrent[0]<LosePower)|(LoadCurrent[1]<LosePower)|(LoadCurrent[2]<LosePower)|(LoadCurrent[3]<Los
             -ePower))//L1~NµçÑ¹¹ıµÍ
1369   1                )
1370   1      
1371   1              {FlagLosePhase=1;ErrorState=Alarm+Error+8;}
1372   1              else FlagLosePhase=0;
1373   1              /*´íÏà*/
1374   1              PhaseErrorCheck();
1375   1              
1376   1              //FlagPower=0;//test ÆÁ±ÎÒÔÉÏÅĞ¶Ï
1377   1              return FlagPowerH|FlagPowerL|FlagLosePhase|FlagErrorPhase;
1378   1      }
1379          bit OverLoadCheck()
1380          {
1381   1              //¹ıÔØ10
1382   1              if(OverLoadCount>500)//200us*4*500=400ms
1383   1              {
1384   2                      OverLoad=OverLoad1/OverLoadCount;
1385   2                      OverLoad1=OverLoad;
1386   2      //              OverLoad1 = OverLoad1*5000;
1387   2      //              OverLoad1 = OverLoad1/1024;
1388   2                      OverLoadCount=1;
1389   2                      TI=0;                                                           //´Ë¶Î´úÂë»áÓ°ÏìÈí¼şÍ¨Ñ¶..²âÊÔÊ±ÓÃ²»ÄÜµ±×öÕıÊ½³ÌĞòÊ¹ÓÃ
1390   2                      SBUF = OverLoad1>>24;
1391   2                      while(!TI);
1392   2                      TI=0;
1393   2                      SBUF = OverLoad1>>16;
1394   2                      while(!TI);
1395   2                      TI=0;                                                           //´Ë¶Î´úÂë»áÓ°ÏìÈí¼şÍ¨Ñ¶..²âÊÔÊ±ÓÃ²»ÄÜµ±×öÕıÊ½³ÌĞòÊ¹ÓÃ
1396   2                      SBUF = OverLoad1>>8;
1397   2                      while(!TI);
1398   2                      TI=0;
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 24  

1399   2                      SBUF = OverLoad1;
1400   2                      while(!TI);
1401   2              }
1402   1              //²»ÔÙ²ÅÓÃÍÆÍì·½Ê½£¬Ìá¸ßÁéÃô¶È 20130503
1403   1              
1404   1              //if(OverLoad<OverLoadLimite1)FlagOverLoad=0;//²»¹ıÔØ
1405   1              if((OverLoad-(GaoDu/GaoDuK))<OverLoadLimite1){FlagOverLoad=0;LED2=1;IN2=1;}//2014/3/19
1406   1              else
1407   1              {
1408   2                      IN2 = 0;
1409   2                      LED2 = 0;
1410   2                      ErrorState=Alarm+Error+10;//ERROR
1411   2                      FlagOverLoad=1;
1412   2              }
1413   1              if(FlagRun)FlagOverLoad=0;//µçÌİĞĞ½øÊ±£¬²»×ö¹ıÔØ¼ì²â£¬·ÀÖ¹ĞüÍ£¿ÕÖĞ
1414   1              
1415   1              return FlagOverLoad;
1416   1      }
1417          
1418          //2012-10-26
1419          bit MainSwitchCheck()
1420          {
1421   1      bit sta;
1422   1      /*
1423   1              ÏäÍâ¼±Í£
1424   1              ÏäÄÚ¼±Í£
1425   1              ÃÅ½û
1426   1              ½ô¼±ÉÏÏŞÎ»
1427   1              °²È«Ëø
1428   1              ÈÈ¼Ì
1429   1      */
1430   1      
1431   1              sta=1;FlagRun=0;        
1432   1              if(State[0]<50)         ErrorState=Error+1;//AC24V¹ÊÕÏ
1433   1              if(State[1]<50)         ErrorState=Error+1;//Ô¿³×¿ª¹Ø
1434   1              if(State[2]<50)         ErrorState=Error+3;//ÏäÍâ¼±Í£3
1435   1              else if(State[3]<50)ErrorState=Error+2; //ÏäÄÚ¼±Í£2
1436   1              else if(State[4]<50)ErrorState=Error+1; //¼ÌµçÆ÷6
1437   1              else if(State[5]<50)ErrorState=Error+17;//±¸ÓÃÃÅ17
1438   1              else if(State[6]<50)ErrorState=Error+16;//ÃÅ½û16
1439   1              else if(State[7]<50)ErrorState=Alarm+Error+4;//½ô¼±ÉÏÏŞÎ»4
1440   1              else if(State[8]<50)ErrorState=Alarm+Error+18;//°²È«Ëø18
1441   1              else if(State[9]<50)ErrorState=Alarm+Error+9;//ÈÈ¼Ì9
1442   1              else {sta=0;FlagRun=1;}
1443   1      
1444   1      
1445   1              return sta;
1446   1      }
1447          
1448          //2012-10-26
1449          bit UpSwitchCheck()
1450          {
1451   1              bit sta;
1452   1              sta=1;
1453   1              if(State[10]>0)//ÉÏÉı
1454   1              {
1455   2                      FlagStart=1;
1456   2                      if(State[11]<50)
1457   2                      ErrorState=Error+11;//ÉÏÏŞÎ»¶¯×÷11
1458   2                      else if(State[12]<50)
1459   2                      ErrorState=Alarm+Error+19;//ÂÖÀªÉÏÏŞÎ»¶¯×÷19
1460   2                      else if(State[13]<50)
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 25  

1461   2                      ErrorState=Alarm+Error+1;//¼ÌµçÆ÷2´íÎó
1462   2                      //else {ErrorState=2;FlagRun=1;}//ÉÏÉı×´Ì¬
1463   2                      else 
1464   2                      {
1465   3                              ErrorState=2;
1466   3                              FlagRun=1;
1467   3                              if(GaoDu<60000)
1468   3                              GaoDu++;
1469   3                      }//2014/3/19
1470   2              }
1471   1              else
1472   1          {
1473   2                      sta=0;
1474   2                      FlagRun=0;
1475   2              }
1476   1              
1477   1              return sta;
1478   1      }
1479          
1480          //2012-10-26
1481          bit DownSwitchCheck()
1482          {
1483   1              bit sta;
1484   1              sta=1;
1485   1              if(State[14]>150)//ÏÂ½µ
1486   1              {
1487   2                      FlagStart=1;
1488   2                      //if(State[15]<50)ErrorState=Error+12;//ÏÂÏŞÎ»¶¯×÷12
1489   2                      if(State[15]<50)
1490   2                      {
1491   3                              ErrorState=Error+12;
1492   3                              GaoDu=0;
1493   3                      }//2014/3/19
1494   2                      else if(State[16]<50)
1495   2                      ErrorState=Alarm+Error+1;//¼ÌµçÆ÷1´íÎó
1496   2                      //else {ErrorState=3;FlagRun=1;}//ÏÂ½µ×´Ì¬
1497   2                      else 
1498   2                      {
1499   3                              ErrorState=3;
1500   3                              FlagRun=1;
1501   3                              if(GaoDu>0)
1502   3                              GaoDu--;
1503   3                      }//2014/3/19
1504   2              }
1505   1              else
1506   1          {
1507   2                      sta=0;
1508   2                      FlagRun=0;
1509   2              }
1510   1              
1511   1              return sta;
1512   1      }
1513          
1514          void StateShow()
1515          {
1516   1              FlagRun=0;
1517   1              if(FlagStart)ErrorState=1;//Í£Ö¹×´Ì¬1
1518   1              else ErrorState=0;
1519   1      }
1520          
1521          //¹ÊÕÏ·ÖÎö
1522          void StateErrorCheck()
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 26  

1523          {
1524   1              if(OverLoadCheck()){}//¹ıÔØÏÔÊ¾¹ÊÕÏ
1525   1              else if(PowerCheck()){}//¹ıµçÑ¹»òÇ·µçÑ¹»òÈ±Ïà»òÏàĞò´íÎó
1526   1              else if(FlagStart)//Èç¹ûÒÑ¾­¿ªÊ¼²Ù×÷¼ì²éºÍÏÔÊ¾ÆäËû¹ÊÕÏ£¬·ñÔòÏÔÊ¾ÔËĞĞÊ±¼ä
1527   1              {
1528   2                      if(MainSwitchCheck());
1529   2                      else if(UpSwitchCheck());
1530   2                      else if(DownSwitchCheck());
1531   2                      else StateShow();
1532   2              }
1533   1              else
1534   1              {
1535   2                      if(UpSwitchCheck());
1536   2                      else if(DownSwitchCheck());
1537   2                      else StateShow();
1538   2              }
1539   1              
1540   1      /*
1541   1      B7£º=B6¨B5¨B4¨B3¨B2¨B1¨B0
1542   1      B6 B5=0×´Ì¬ÏÔÊ¾
1543   1      B4 B3 B2 B1 B0=
1544   1              0£ºÏÔÊ¾µç»úÔË×ªÊ±¼ä
1545   1      1£º¿ÕÏĞ×´Ì¬
1546   1      2£ºÉÏÉı×´Ì¬
1547   1      3£ºÏÂ½µ×´Ì¬
1548   1      B6 B5=1¹ÊÕÏÏÔÊ¾(²»¸æ¾¯)
1549   1              B4 B3 B2 B1 B0=
1550   1      1£ºµçÔ´24·ü¹ÊÕÏ»òÕßµçÂ·°å¹ÊÕÏ£»ok
1551   1      2£ºÏáÄÚ¼±Í£´¥·¢£»ok
1552   1      3£ºÏáÍâ¼±Í£´¥·¢£»ok
1553   1      4£º½ô¼±ÉÏÏŞÎ»´¥·¢£»ok
1554   1      5£º½ÓÊÜÃüÁîÊ§°Ü£¨ÎóÂë£©£»
1555   1      6£º½ÓÊÜÃüÁîÊ§°Ü£¨³¬Ê±£©£»ok
1556   1      7£ºÏàĞò´íÎó£»
1557   1      8£º¶ÏÏà£»
1558   1      9£º¹ıÁ÷±£»¤£»ÈÈ¼ÌµçÆ÷ ok
1559   1      10£º¹ıÔØ±£»¤£»ok
1560   1      11£ºÉÏÏŞÎ»´¥·¢£»ok
1561   1      12£ºÏÂÏŞÎ»´¥·¢£»ok
1562   1      16£ºÇ°ÃÅÎ´¹Ø±Õ ok
1563   1      17£ººóÃÅÎ´¹Ø±Õ ok
1564   1      18£º°²È«Ëø¶¯×÷ ok
1565   1      19£ºÂÖÀªÉÏÏŞÎ»´¥·¢ ok
1566   1      
1567   1      20£ºµçÑ¹¹ı¸ß
1568   1      21£ºµçÑ¹¹ıµÍ
1569   1      30~31£º²âÊÔ¶Ë¿Ú1~2£¨µ±²âÊÔ¶Ë¿ÚÉÏ³öÏÖ24VµçÑ¹Ê±£¬ÏÔÊ¾²âÊÔ¶Ë¿ÚÊı¾İ£¬Í¬Ê±¿ØÖÆ°åµÄºìµÆÉÁË¸£©
1570   1      B6 B5=3¹ÊÕÏÏÔÊ¾(¸æ¾¯)£¬¹ÊÕÏÀàĞÍÍ¬B6 B5=1
1571   1      */
1572   1      
1573   1              if(SecCount>(255-20*1))//25ms*20=500ms
1574   1              {
1575   2                      if(FlagErrorPhase)//±£Ö¤500msÃëÄÚÔÊĞí´íÏàÔËĞĞ£¬ÒÔ±ã²ğĞ¶¸ÖË¿Éş
1576   2                      {
1577   3                              DrvRun=0;
1578   3                              SecCount=255;//2012-3-24 ±¨´íºó£¬Èç¹ûÍ£Ö¹²Ù×÷
1579   3                      }
1580   2      
1581   2                      if(State[14]>150)DrvSl3=0;      //Èç¹ûÏÂ½µ£¬¶Ï¿ª°²È«Ëø¼ÌµçÆ÷2017-05-22
1582   2              }
1583   1              else
1584   1              {
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 27  

1585   2                      DrvRun=FlagOverLoad|FlagErrorPhase|FlagLosePhase|OverTimer;//2017-5-25
1586   2                      DrvSl3=0;       //¶Ï¿ª°²È«Ëø¼ÌµçÆ÷
1587   2              }
1588   1      }
1589          
1590          void Verify()
1591          {
1592   1              unsigned char check;
1593   1              check=0;
1594   1              if(ErrorState&0x01)check++;
1595   1              if(ErrorState&0x02)check++;
1596   1              if(ErrorState&0x04)check++;
1597   1              if(ErrorState&0x08)check++;
1598   1              if(ErrorState&0x10)check++;
1599   1              if(ErrorState&0x20)check++;
1600   1              if(ErrorState&0x40)check++;
1601   1              if(check&0x01)ErrorState=ErrorState+0x80;
1602   1      }
1603          
1604          //**********************************************************************2017-5-31
1605          void SxBUF_Init()
1606          {
1607   1      //´®¿Ú
1608   1              TH1=0x100-Crystal/12/16/BaudRate;TL1=0x100-Crystal/12/16/BaudRate;
1609   1      //1
1610   1              SCON=0x58;
1611   1              T2H=(65536-Crystal/4/BaudRate)/256;
1612   1              T2L=(65536-Crystal/4/BaudRate)%256;
1613   1      //2
1614   1              S2CON=0x58;//S2SM0/NC/S2SM2/S2REN/S2TB8/S2RB8/S2TI/S2RI
1615   1      //3     
1616   1              S3CON=0x98;//S3SM0/S3ST3/S3SM2/S3REN/S3TB8/S3RB8/S3TI/S3RI
1617   1      //4     
1618   1              S4CON=0x98;//S4SM0/S4ST4/S4SM2/S4REN/S4TB8/S4RB8/S4TI/S4RI
1619   1              //¸¨Öú¼Ä´æÆ÷
1620   1              AUXR=0X14;//T0*12/T1*12/UART_M0*6/T2R/T2_CT/T2*12/EXTRAM/S1ST2;S1ST2ÉèÖÃ´®¿Ú1Ê¹ÓÃ¶¨Ê±Æ÷T2
1621   1              AUXR|=0X01;
1622   1      }
1623          
1624          //200us¶¨Ê±ÖĞ¶Ï³ÌĞò
1625          //Ê±ÖÓÊ±¼ä½Ú×à×¼È·
1626          void timer0(void) interrupt 1 /*T0ÖĞ¶Ï*/
1627          {
1628   1              TH0=(65536-Crystal/12000*InitTime/1000)/256;
1629   1              TL0=(65536-Crystal/12000*InitTime/1000)%256;
1630   1      
1631   1              WDT_CONTR=0x3e;//2.72Ãë¿´ÃÅ¹·
1632   1      
1633   1              Clock_1s++;
1634   1              if(Clock_1s>9999)
1635   1              {
1636   2                      if(ShowTimer<4)ShowTimer++;
1637   2                      Clock_1s=0;
1638   2              }
1639   1      
1640   1              if(FlagStart)ShowTimer=5;
1641   1              
1642   1              if(Flag_CheckID)//Èç¹ûÔÚ¼ì²âÊÚÈ¨Ìø¹ıËùÓĞ²Ù×÷
1643   1              {
1644   2                      LedShow();
1645   2                      Flag_Timer0=1;
1646   2                      goto timer0end;
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 28  

1647   2              }
1648   1      
1649   1              AdStart();//ok
1650   1              
1651   1              StateCheck();//ok
1652   1              
1653   1              //¹ıÔØ²âÊÔÖµÈ¡¾ø¶ÔÖµ£¬´ËÊ±ÕıÔÚ²âÁ¿AÏà£¬¹ıÔØÒÑ²âÁ¿Íê±Ï
1654   1              if(LoadIndex==0)//0.8msÒ»´Î
1655   1              {
1656   2                      OverLoad1=OverLoad1+LoadDot[3];//¹ıÔØÊıÖµ¼ÆËã
1657   2                      OverLoadCount++;
1658   2                      if(DelaySecCount>0)DelaySecCount--;
1659   2                      SumCount++;
1660   2                      
1661   2                      CountIndex=SumCount%CheckCycle;
1662   2                      if(CountIndex==0)//0.8ms*31=24.8ms
1663   2                      {
1664   3                              StateErrorCheck();
1665   3                              //2017-5-25
1666   3                              //start
1667   3                              if(SumCount>(CheckCycle*40))//800us*31*40=992ms
1668   3                              {
1669   4                                      LoadCurrent[0]=SumLoadCurrent[0]/SumCount;SumLoadCurrent[0]=0;
1670   4                                      LoadCurrent[1]=SumLoadCurrent[1]/SumCount;SumLoadCurrent[1]=0;
1671   4                                      SumLoadCurrent[2]=SumLoadCurrent[2]/1.06;//Êµ²â50hzÊÇ1.053£¬¼ÆËã»úÄ£Äâ50hzÊÇ1.053~1.056£¬60hzÊÇ1.064~1
             -.066£¬ÕÛÖĞÈ¡1.06
1672   4                                      //LoadCurrent[2]=SumLoadCurrent[2]/SumCount;SumLoadCurrent[2]=0;
1673   4                                      LoadCurrent[2]=LoadCurrent[1];SumLoadCurrent[2]=0;//¿¼ÂÇµ½²»ÊÇÖ±½Ó²âÁ¿£¬ÎÊÌâ½Ï´ó£¬²»ÔÙÊ¹ÓÃ20130503
1674   4                                      LoadCurrent[3]=SumLoadCurrent[3]/SumCount;SumLoadCurrent[3]=0;
1675   4      
1676   4                                      SumCount=0;
1677   4                                      Sec5++;
1678   4                                      Sec5=Sec5%5;//2015-08-12
1679   4                              }
1680   3      
1681   3                              if(FlagRun)L_Run=(SumCount>(CheckCycle*20));//1ºÕ×ÈÉÁË¸
1682   3                              else L_Run=0;
1683   3                              
1684   3                              Verify();
1685   3                              S2CON&=~S2TI;
1686   3                              S2BUF=ErrorState;
1687   3                              //Verify();TI=0;SBUF=OverLoad;//zjbtest
1688   3      
1689   3                              if(SecCount>0)SecCount--;
1690   3                              if(SecCount==0)
1691   3                              {
1692   4                                      SecCount=100;//2.5sec
1693   4                              }
1694   3      
1695   3                      }
1696   2                      else if(CountIndex&0x01)LedShow();//1.6msÒ»´Î
1697   2              }
1698   1              
1699   1      /*
1700   1              LoadIndex==1Ê±£¬AÏàµçÁ÷·ÖÎö£¬´ËÊ±ÕıÔÚ²âÁ¿BÏà£¬AÏàÒÑ²âÁ¿Íê±Ï
1701   1              LoadIndex==2Ê±£¬BÏàµçÁ÷·ÖÎö£¬´ËÊ±ÕıÔÚ²âÁ¿CÏà£¬BÏàÒÑ²âÁ¿Íê±Ï
1702   1              LoadIndex==3Ê±£¬CÏàµçÁ÷·ÖÎö£¬´ËÊ±ÕıÔÚ²âÁ¿¹ıÔØ£¬CÏàÒÑ²âÁ¿Íê±Ï
1703   1              
1704   1              µ±µçÁ÷LoadDot[]>(LoadZero+LoadMin)Ê±£¬±íÊ¾ÓĞÕıµçÁ÷£¬¼«ĞÔPolarity[]±êÎª1
1705   1              µ±µçÁ÷LoadDot[]>(LoadZero-LoadMin)Ê±£¬±íÊ¾ÓĞ¸ºµçÁ÷£¬¼«ĞÔPolarity[]±êÎª0
1706   1              µ±¼«ĞÔPolarity[]ÓÉ0±äÎª1Ê±£¬PhaseTimer[]¿ªÊ¼¼ÆÊ±,
1707   1              µ±¼«ĞÔPolarity[]ÓÉ0±äÎª1Ê±£¬LoadCurrent[]¼ÆËã²¢ÀÛ¼Æ,
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 29  

1708   1      
1709   1      */
1710   1              //ABÏàµçÑ¹
1711   1              if(LoadIndex==1)
1712   1              {
1713   2                      LoadDot[0]=1024-LoadDot[0];//²âÁ¿µÄÊÇBAµçÑ¹£¬×ªAB
1714   2                      if(LoadDot[0]>LoadZero)
1715   2                      {
1716   3                              SumLoadCurrent[0]=SumLoadCurrent[0]+LoadDot[0]-LoadZero;//2012-11-28
1717   3                      }
1718   2                      else
1719   2                      {
1720   3                              SumLoadCurrent[0]=SumLoadCurrent[0]+LoadZero-LoadDot[0];//2012-11-28    
1721   3                      }
1722   2                      
1723   2                      if(!Polarity0)//Èç¹ûµçÁ÷¸º°ëÖÜÆÚ
1724   2                      {
1725   3                              if(LoadDot[0]>(LoadZero+LoadMin))//½øÈëÕı°ëÖÜ
1726   3                              {
1727   4                                      Polarity0=1;
1728   4                                      PhaseTimer[0]=0;
1729   4                              }
1730   3                              
1731   3                      }
1732   2                      else
1733   2                      {
1734   3                              if(LoadDot[0]<(LoadZero-LoadMin))//½øÈë¸º°ëÖÜ
1735   3                              {
1736   4                                      Polarity0=0;
1737   4                              }
1738   3                      }
1739   2                      
1740   2                      if(PhaseTimer[0]<199)PhaseTimer[0]++;
1741   2              }
1742   1              
1743   1              //CAÏàµçÑ¹
1744   1              if(LoadIndex==2)
1745   1              {
1746   2                      if(LoadDot[1]>LoadZero)
1747   2                      {
1748   3                              SumLoadCurrent[1]=SumLoadCurrent[1]+LoadDot[1]-LoadZero;//2012-11-28
1749   3                      }
1750   2                      else 
1751   2                      {
1752   3                              SumLoadCurrent[1]=SumLoadCurrent[1]+LoadZero-LoadDot[1];//2012-11-28
1753   3                      }
1754   2                      
1755   2                      if(!Polarity1)//Èç¹ûµçÁ÷¸º°ëÖÜÆÚ
1756   2                      {
1757   3                              if(LoadDot[1]>(LoadZero+LoadMin))//½øÈëÕı°ëÖÜ
1758   3                              {
1759   4                                      Polarity1=1;
1760   4                                      PhaseTimer[1]=0;
1761   4                                      
1762   4                              }
1763   3                      }else
1764   2                      {
1765   3                              if(LoadDot[1]<(LoadZero-LoadMin))//½øÈë¸º°ëÖÜ
1766   3                              {
1767   4                                      Polarity1=0;
1768   4                              }
1769   3                      }
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 30  

1770   2                      
1771   2                      if(PhaseTimer[1]<199)PhaseTimer[1]++;
1772   2              }
1773   1      
1774   1              
1775   1              //BCÏàµçÑ¹ºÍAÏßµçÑ¹
1776   1              if(LoadIndex==3)
1777   1              {
1778   2                      //AÏßµçÑ¹
1779   2                      if(LoadDot[2]>LoadZero)SumLoadCurrent[3]=SumLoadCurrent[3]+LoadDot[2]-LoadZero;//2012-11-28
1780   2                      else SumLoadCurrent[3]=SumLoadCurrent[3]+LoadZero-LoadDot[2];//2012-11-28
1781   2              
1782   2                      //BCÏàµçÑ¹
1783   2                      LoadDot[2]=1024-(LoadDot[0]+LoadDot[1]-LoadZero);
1784   2                      if(LoadDot[2]>LoadZero)
1785   2                      {
1786   3                              SumLoadCurrent[2]=SumLoadCurrent[2]+LoadDot[2]-LoadZero;//2012-11-28
1787   3                      }else 
1788   2                      {
1789   3                              SumLoadCurrent[2]=SumLoadCurrent[2]+LoadZero-LoadDot[2];//2012-11-28
1790   3                      }
1791   2                      
1792   2                      if(!Polarity2)//Èç¹ûµçÁ÷¸º°ëÖÜÆÚ
1793   2                      {
1794   3                              if(LoadDot[2]>(LoadZero+LoadMin))//½øÈëÕı°ëÖÜ
1795   3                              {
1796   4                                      Polarity2=1;
1797   4                                      PhaseTimer[2]=0;
1798   4                              }
1799   3                              
1800   3                      }else
1801   2                      {
1802   3                              if(LoadDot[2]<(LoadZero-LoadMin))//½øÈë¸º°ëÖÜ
1803   3                              {
1804   4                                      Polarity2=0;
1805   4                              }
1806   3                      }
1807   2                      
1808   2                      if(PhaseTimer[2]<199)PhaseTimer[2]++;
1809   2              }
1810   1              
1811   1              LoadDot[LoadIndex]=GetAdResult();
1812   1      
1813   1              LoadIndex=(LoadIndex+1)%4;
1814   1              AdReady(LoadIndex);
1815   1      
1816   1      timer0end:;
1817   1      }
1818          //-------------------ÖĞ¶Ïº¯Êı--------------------------//
1819          void Int0(void)         interrupt 0//int0
1820          {while(1){TI=0;SBUF=0x00;while(!TI){};/*Delay(1000)*/;}}
1821          void Int1(void)         interrupt 2//int1
1822          {while(1){TI=0;SBUF=0x02;while(!TI){};/*Delay(1000)*/;}}
1823          void Timer1(void)       interrupt 3//timer1
1824          {while(1){TI=0;SBUF=0x03;while(!TI){};/*Delay(1000)*/;}}
1825          void UART1(void)        interrupt 4//uart Í¨ĞÅ
1826          {while(1){TI=0;SBUF=0x04;while(!TI){};/*Delay(1000)*/;}}
1827          void ADC(void)          interrupt 5//adc Ä£Êı×ª»»
1828          {while(1){TI=0;SBUF=0x05;while(!TI){};/*Delay(1000)*/;}}
1829          void LVC(void)          interrupt 6//pca µÍÑ¹¼ì²â
1830          {while(1){TI=0;SBUF=0x06;while(!TI){};/*Delay(1000)*/;}}
1831          void PCA(void)          interrupt 7
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 31  

1832          {while(1){TI=0;SBUF=0x07;while(!TI){};/*Delay(1000)*/;}}
1833          void UART2(void)        interrupt 8
1834          {while(1){TI=0;SBUF=0x08;while(!TI){};/*Delay(1000)*/;}}
1835          void SPI(void)          interrupt 9
1836          {while(1){TI=0;SBUF=0x09;while(!TI){};/*Delay(1000)*/;}}
1837          void Int2(void)         interrupt 10
1838          {while(1){TI=0;SBUF=0x10;while(!TI){};/*Delay(1000)*/;}}
1839          void Int3(void)         interrupt 11
1840          {while(1){TI=0;SBUF=0x11;while(!TI){};/*Delay(1000)*/;}}
1841          void Timer2(void)       interrupt 12
1842          {while(1){TI=0;SBUF=0x12;while(!TI){};/*Delay(1000)*/;}}
1843          void zd13(void)         interrupt 13
1844          {while(1){TI=0;SBUF=0x13;while(!TI){};/*Delay(1000)*/;}}
1845          void zd14(void)         interrupt 14
1846          {while(1){TI=0;SBUF=0x14;while(!TI){};/*Delay(1000)*/;}}
1847          void zd15(void)         interrupt 15
1848          {while(1){TI=0;SBUF=0x15;while(!TI){};/*Delay(1000)*/;}}
1849          void Int4(void)         interrupt 16
1850          {while(1){TI=0;SBUF=0x16;while(!TI){};/*Delay(1000)*/;}}
1851          void S3(void)           interrupt 17
1852          {while(1){TI=0;SBUF=0x17;while(!TI){};/*Delay(1000)*/;}}
1853          void S4(void)           interrupt 18
1854          {while(1){TI=0;SBUF=0x18;while(!TI){};/*Delay(1000)*/;}}
1855          void Timer3(void)       interrupt 19
1856          {while(1){TI=0;SBUF=0x19;while(!TI){};/*Delay(1000)*/;}}
1857          void Timer4(void)       interrupt 20
1858          {while(1){TI=0;SBUF=0x20;while(!TI){};/*Delay(1000)*/;}}
1859          void Comparator(void) interrupt 21
1860          {while(1){TI=0;SBUF=0x21;while(!TI){};/*Delay(1000)*/;}}
1861          void PWM(void)          interrupt 22
1862          {while(1){TI=0;SBUF=0x22;while(!TI){};/*Delay(1000)*/;}}
1863          void PWMFD(void)        interrupt 23
1864          {while(1){TI=0;SBUF=0x23;while(!TI){};/*Delay(1000)*/;}}
1865          
1866          
1867          //Ö÷³ÌĞò
1868          void main()
1869          {
1870   1      //unsigned int ii;
1871   1      //unsigned char i;
1872   1      //¿´ÃÅ¹·³ÌĞò
1873   1      /*
1874   1              i=WDT_CONTR;
1875   1              if(i>127)//Èç¹û¿´ÃÅ¹·¸´Î»
1876   1              {
1877   1                      while(1){};
1878   1              }else WDT_CONTR=0x3e;//2.72Ãë¿´ÃÅ¹·
1879   1      */
1880   1      
1881   1      //*****************************************
1882   1      //Ó²¼ş³õÊ¼»¯
1883   1              IE=0;
1884   1      //T0
1885   1              TH0=(65536-Crystal/12000*InitTime/1000)/256;
1886   1              TL0=(65536-Crystal/12000*InitTime/1000)%256;
1887   1              TMOD=0x21;TR0=1;ET0=1;
1888   1      
1889   1              SxBUF_Init();
1890   1      
1891   1              ADC_CONTR=0x60;//½«×ª»»ËÙ¶ÈÉèÎª×î¸ß,210¸öÊ±ÖÓÖÜÆÚ
1892   1              ADC_CONTR=ADC_CONTR|0x80;//´ò¿ª×ª»»µçÔ´
1893   1              PX0=0;PT0=1;IP2=0;
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 32  

1894   1      
1895   1              ADC_CONTR=0x60;//½«×ª»»ËÙ¶ÈÉèÎª×î¸ß,210¸öÊ±ÖÓÖÜÆÚ
1896   1              ADC_CONTR=ADC_CONTR|0x80;//´ò¿ª×ª»»µçÔ´
1897   1      //½«P1.3,P1.4,P1.5ÉèÖÃÎªA/D×ª»»Ä£Ê½
1898   1      
1899   1      /*
1900   1      M1      M0
1901   1      0       0       Ë«Ïò
1902   1      0       1       Êä³ö
1903   1      1       0       ÊäÈë
1904   1      1       1       ¿ªÂ©¡¢AD
1905   1      
1906   1      O       Êä³ö
1907   1      I       ÊäÈë
1908   1      NC      Î´ÓÃÒı½Å
1909   1      N0      Ã»ÓĞÒı½Å
1910   1      */
1911   1              //01234567
1912   1          //TO14,TO15,TO16,TO3,TO2,S1,S0,NC
1913   1              P0M1=0x00;P0M0=0x00;
1914   1      
1915   1              //RXD2,TXD2,LOAD,AD0,AD1,AD2,2.5V,NC
1916   1              P1M1=~0x03;P1M0=~0x03;
1917   1      
1918   1              //NC,NC,NC,NC,TO4,TO5,TO6,TO7
1919   1              P2M1=0x00;P2M0=0x00;
1920   1      
1921   1          //RXD,TXD,IN8,IN7,IN6,IN3,IN2,IN1
1922   1              P3M1=0x00;P3M0=~0x03;//01´®¿Ú+6¸ö2803
1923   1      
1924   1              //NC,DF,DB,DA,NC,TO12,TO13,NC
1925   1              P4M1=0x00;P4M0=0x00;
1926   1      
1927   1              //IN5,IN4,TO1,NC,NC,NC,NO,NO
1928   1              P5M1=0x00;P5M0=0x03;//2¸ö2803+1¸ö¹âÅ¼
1929   1      
1930   1              //DG,DE,DD,DC,TO8,TO9,TO10,TO11
1931   1              P7M1=0x00;P7M0=0x00;
1932   1      
1933   1      //test end
1934   1              ErrorState      =0;
1935   1              DrvUpSta        =0;
1936   1              FlagOverLoad    =0;
1937   1              FlagErrorPhase  =0;
1938   1              FlagLosePhase   =0;
1939   1              FlagStart       =0;
1940   1              DrvSl3          =1;//±ÕËø°²È«Ëø
1941   1              DrvRun          =0;//ÔÊĞíÔËĞĞ
1942   1              
1943   1              OverLoad=0;
1944   1              OverLoadCount=1;
1945   1              Polarity0=0;
1946   1              Polarity1=0;
1947   1              Polarity2=0;
1948   1              PhaseError=0;
1949   1              PhaseTimer[0]=0;
1950   1              PhaseTimer[1]=0;
1951   1              PhaseTimer[2]=0;
1952   1              PhaseLose=0;
1953   1              
1954   1              CountIndex=0;
1955   1              SecCount=255;
C51 COMPILER V8.05a   CONTR50L                                                             01/22/2018 14:33:00 PAGE 33  

1956   1      
1957   1              GaoDu=0;
1958   1      
1959   1      //2017-5-25 start
1960   1              OneMin=0;
1961   1              FlagOverTimer=0;
1962   1              OverTimer=0;
1963   1      
1964   1              CheckID();
1965   1      
1966   1      //2017-5-25 end
1967   1              EA=1;   //µ÷ÊÔÊ±¹Ø¶Ï
1968   1              while(1)
1969   1              {
1970   2              //      IN1 = 0;
1971   2              //      IN2 = 0;
1972   2              //      IN3=0;
1973   2              //      LED2 =0;
1974   2              //      LED1= 0;
1975   2                      LED3 = 0;
1976   2                      RstPower();
1977   2                      _nop_();
1978   2                      _nop_();
1979   2                      _nop_();
1980   2                      _nop_();
1981   2              }
1982   1      }
1983          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   8491    ----
   CONSTANT SIZE    =     64    ----
   XDATA SIZE       =     74    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     36      40
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     16       3
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
